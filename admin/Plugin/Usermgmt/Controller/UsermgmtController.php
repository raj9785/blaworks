<?php/** * @license MIT License (http://www.opensource.org/licenses/mit-license.php) * * PHP version 5 * CakePHP version 1.3 *//** * Categories Users Controller * * @package Categories * @subpackage users.controllers */class UsermgmtController extends UsermgmtAppController {    /**     * Controller name     *     * @var string     */    var $name = 'Usermgmt';    /**     * Helpers     *     * @var array     */    public $helpers = array('Html', 'Form', 'Session', 'Time', 'Text');//public $paginate = array('limit'=>5,'order'=>'Category.id','page'=>1);    /**     * Components     *     * @var array     */    public $components = array('Auth', 'Session', 'Email', 'Cookie', 'Search.Prg', 'RequestHandler');    public $presetVars = array(        array('field' => 'email', 'type' => 'value'),        array('field' => 'firstname', 'type' => 'value'),        array('field' => 'username', 'type' => 'value'),        array('field' => 'mobile', 'type' => 'value'),        array('field' => 'user_role_id', 'type' => 'value'),        array('field' => 'status', 'type' => 'value')    );//public $presetVars = 	true;    public $user_role = array(        '2' => 'VCO',        '5' => 'DCO',    );    public function beforeFilter() {        parent::beforeFilter();        $this->set('model', $this->modelClass);        $this->loadModel("Farecategory");        $farecategory = $this->Farecategory->find("list", array("conditions" => array("status" => 1)));        $this->set("farecategory", $farecategory);//pr($this->params);    }// Load Company States    function get_state() {// Load Fare Settings        $this->layout = false;        $subcategory = array();        if ($this->request->is('Ajax')) {            if ($this->data) {                $this->loadModel("State");                $subcategory = $this->State->find('list', array(                    'conditions' => array(                        'State.country_id' => $this->data['cat_id'],                        'State.status' => 'A'                    ),                    'fields' => array('State.id', 'State.name'),                ));                /* $data = $this->City->query("SELECT cities.id,cities.name FROM operation_cities                  INNER JOIN cities                  ON                  operation_cities.city_id = cities.id                  WHERE                  operation_cities.company_id = '". $this->data['company_id']."'                  AND                  operation_cities.state_id = '". $this->data['cat_id']."'");                  pr($data); */            }            echo json_encode($subcategory);        }        die;    }// Load Company City    function get_city() {// Load Fare Settings        $this->layout = false;        $subcategory = array();        if ($this->request->is('Ajax')) {            if ($this->data) {                $this->loadModel("City");                $subcategory = $this->City->find('list', array(                    'conditions' => array(                        'City.state_id' => $this->data['cat_id'],                        'City.status' => 'A'                    ),                    'fields' => array('City.id', 'City.name'),                ));                /* $data = $this->City->query("SELECT cities.id,cities.name FROM operation_cities                  INNER JOIN cities                  ON                  operation_cities.city_id = cities.id                  WHERE                  operation_cities.company_id = '". $this->data['company_id']."'                  AND                  operation_cities.state_id = '". $this->data['cat_id']."'");                  pr($data); */            }            echo json_encode($subcategory);        }        die;    }    function get_company() {// Load Fare Settings        $this->layout = false;        $subcategory = array();        if ($this->request->is('Ajax')) {            if ($this->data) {                $this->loadModel("Company");                $subcategory = $this->Company->find('list', array(                    'conditions' => array(                        'Company.user_id' => $this->data['cat_id'],                        'Company.status' => 1                    ),                    'fields' => array('Company.id', 'Company.name'),                ));            }            echo json_encode($subcategory);        }        die;    }    function get_city_state() {// Load Fare Settings        $this->layout = false;        $subcategory = array();        if ($this->request->is('Ajax')) {            if ($this->data) {                $this->loadModel("City");                $subcategory = $this->City->find('list', array(                    'joins' => array(                        array(                            'table' => 'operation_cities',                            'alias' => 'OperationCity',                            'type' => 'INNER',                            'conditions' => array(                                'OperationCity.city_id = City.id'                            )                        )                    ),                    'conditions' => array(                        'OperationCity.state_id' => $this->data['cat_id']                    ),                    'fields' => array('City.id', 'City.name'),                ));                /* $data = $this->City->query("SELECT cities.id,cities.name FROM operation_cities                  INNER JOIN cities                  ON                  operation_cities.city_id = cities.id                  WHERE                  operation_cities.company_id = '". $this->data['company_id']."'                  AND                  operation_cities.state_id = '". $this->data['cat_id']."'");                  pr($data); */            }            echo json_encode($subcategory);        }        die;    }    function get_airport_train() {// Load Fare Settings        $this->layout = false;        $subcategory = array();        if ($this->request->is('Ajax')) {            if ($this->data) {                $this->loadModel("CityAirportTrain");                $subcategory = $this->CityAirportTrain->find('all', array(                    'conditions' => array(                        'CityAirportTrain.city_id' => $this->data['cat_id']                    ),                    'fields' => array('id', 'airport_address', 'train_address'),                ));//$log = $this->CityAirportTrain->getDataSource()->getLog(false, false); //debug($log);exit();                /* $data = $this->City->query("SELECT cities.id,cities.name FROM operation_cities                  INNER JOIN cities                  ON                  operation_cities.city_id = cities.id                  WHERE                  operation_cities.company_id = '". $this->data['company_id']."'                  AND                  operation_cities.state_id = '". $this->data['cat_id']."'");                  pr($data); */            }            echo json_encode($subcategory);            exit();        }        die;    }    /**     *     * Get All Countries List     *     * @return json     */    function get_country() {        $this->layout = false;        $subcategory = array();        if (!empty($this->data)) {            $this->loadModel('Country');            $subcategory = $this->Country->find('list', array(                'joins' => array(                    array(                        'table' => 'companies',                        'alias' => 'Company',                        'type' => 'INNER',                        'conditions' => array(                            'Company.country_id = Country.id'                        )                    )                ),                'conditions' => array(                    'Company.id' => $this->data['cat_id']                ),                'fields' => array('Country.id', 'Country.name'),            ));        }        echo json_encode($subcategory);        die;    }    /**     * Admin Index     *     * @return void     */    function index() {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Employee / CEO'));        $this->set('breadcrumb', $breadcrumb);        if (!empty($this->data) && isset($this->data['recordsPerPage'])) {            $limitValue = $limit = $this->data['recordsPerPage'];            $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);        } else {// pr($this->data);            $this->Prg->commonProcess();        }        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Individual / Company');        $parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        $parsedConditions['user_role_id'] = array(2, 5);        $parsedConditions['id !='] = 1;        $this->paginate = array(            'conditions' => array($parsedConditions),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());    }    function customer() {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Passenger'));        $this->set('breadcrumb', $breadcrumb);        if (!empty($this->data)) {            if (!empty($this->data['id'])) {                $submit_aciton = $this->data['Usermgmt']['my_action'];                foreach ($this->data['id'] as $mainid) {                    if ($mainid != '') {//$this->Usermgmt->delete($mainid);                        if ($submit_aciton == 'delete') {                            $this->Usermgmt->delete($mainid);                            $message = "Deleted Successfully";                        }                        if ($submit_aciton == 'active') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '1'), array('Usermgmt.id' => $mainid));                            $message = "Activated Successfully";                        }                        if ($submit_aciton == 'inactive') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '0'), array('Usermgmt.id' => $mainid));                            $message = "Inactivated Successfully";                        }                    }                }                $this->Session->setFlash($message, 'default', array('class' => 'success'));            } else {                if (!empty($this->data) && isset($this->data['recordsPerPage'])) {                    $limitValue = $limit = $this->data['recordsPerPage'];                    $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);                } else {// pr($this->data);                    $this->Prg->commonProcess();                }            }        }        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Passenger');        $parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        $parsedConditions['user_role_id'] = 3;        $this->paginate = array(            'conditions' => array($parsedConditions),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());    }    function employee() {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Employee / CEO'));        $this->set('breadcrumb', $breadcrumb);        if (!empty($this->data)) {            if (!empty($this->data['id'])) {                $submit_aciton = $this->data['Usermgmt']['my_action'];                foreach ($this->data['id'] as $mainid) {                    if ($mainid != '') {                        if ($submit_aciton == 'delete') {                            $this->Usermgmt->delete($mainid);                            $message = "Deleted Successfully";                        }                        if ($submit_aciton == 'active') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '1'), array('Usermgmt.id' => $mainid));                            $message = "Activated Successfully";                        }                        if ($submit_aciton == 'inactive') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '0'), array('Usermgmt.id' => $mainid));                            $message = "Inactivated Successfully";                        }                    }                }                $this->Session->setFlash($message, 'default', array('class' => 'success'));            } else {                if (!empty($this->data) && isset($this->data['recordsPerPage'])) {                    $limitValue = $limit = $this->data['recordsPerPage'];                    $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);                } else {// pr($this->data);                    $this->Prg->commonProcess();                }            }        }        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Employee / CEO');        $parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        $parsedConditions['user_role_id'] = 6;        $this->paginate = array(            'conditions' => array($parsedConditions),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());    }    function individual() {        Configure::write('debug', 2);        $this->set('tab_open', 'partners');        $this->loadModel("Company");        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Individual'));        $this->set('breadcrumb', $breadcrumb);        $limitValue = $limit = 25;        if (!empty($this->data)) {            if (!empty($this->data['id'])) {                $submit_aciton = $this->data['Usermgmt']['my_action'];                foreach ($this->data['id'] as $mainid) {                    if ($mainid != '') {                        if ($submit_aciton == 'delete') {                            $this->Usermgmt->delete($mainid);                            $message = "Deleted Successfully";                        }                        if ($submit_aciton == 'active') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '1'), array('Usermgmt.id' => $mainid));                            $message = "Activated Successfully";                        }                        if ($submit_aciton == 'inactive') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '0'), array('Usermgmt.id' => $mainid));                            $message = "Inactivated Successfully";                        }                    }                }                $this->Session->setFlash($message, 'default', array('class' => 'success'));            } else {                if (!empty($this->data) && isset($this->data['recordsPerPage'])) {                    $limitValue = $limit = $this->data['recordsPerPage'];                    $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);                } else {// pr($this->data);                    $this->Prg->commonProcess();                }            }        }//$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $conditions = array();        array_push($conditions, array('user_role_id' => array(2)));        if (!empty($this->request->query)) {            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => $this->request->query['state_id']));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }//	    if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {//		array_push($conditions, array(//		    'OR' => array(//			'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['firstname']) . "%",//			'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['firstname']) . "%",//			"LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['firstname']) . "%",//		    )//		));//		$this->set("firstname", $this->request->query['firstname']);//	    }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));                $this->set("firstname", $this->request->query['firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));                $this->set("mobile", $this->request->query['mobile']);            }                        if (isset($this->request->query['hold_payment']) && $this->request->query['hold_payment'] != "") {                array_push($conditions, array('Usermgmt.hold_payment' => $this->request->query['hold_payment']));                $this->set("hold_payment", $this->request->query['hold_payment']);            }                        if (isset($this->request->query['ac_holder_name']) && $this->request->query['ac_holder_name'] != "") {                array_push($conditions, array('Company.ac_holder_name LIKE' =>  "%" . $this->request->query['ac_holder_name'] . "%"));                $this->set("ac_holder_name", $this->request->query['ac_holder_name']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['tax_registeration_no']) && $this->request->query['tax_registeration_no'] != "") {                if ($this->request->query['tax_registeration_no'] == 1) {                    array_push($conditions, array('Company.tax_registeration_no !=' => ''));                } else {                    array_push($conditions, array('Company.tax_registeration_no' => ''));                }                $this->set("tax_registeration_no", $this->request->query['tax_registeration_no']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $pageHeading = __('Individual / Company');        $this->{$this->modelClass}->belongsTo = array(            'State' => array(                'className' => 'State',                'foreignKey' => 'state_id'            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'            )        );               // pr($conditions);        $this->paginate = array(            'conditions' => array($conditions),            'joins' => array(                array(                    'table' => 'companies',                    'alias' => 'Company',                    'type' => 'INNER',                    'conditions' => array(                        'Company.user_id = Usermgmt.id'                    )                )            ),            'fields' => array(                'Usermgmt.status', 'Usermgmt.mgf_vendor', 'Usermgmt.created', 'Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.email', 'Usermgmt.address', 'Usermgmt.status_by_admin', 'Usermgmt.status', 'Usermgmt.verified',                'Usermgmt.mobile', 'Usermgmt.image','Company.ac_holder_name','Usermgmt.hold_payment', 'Usermgmt.uniqid', 'Usermgmt.type', 'Usermgmt.state_id', 'Usermgmt.city_id', 'State.name', 'City.name', 'Company.*'            ),            'recursive' => 5,            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());        $state = Cache::read('Vstate');        if ($state == "") {            $this->loadModel("State");            $country = $this->State->find("list");            Cache::write('Vstate', $state);        }        $this->set("states", $country);        $city = Cache::read('Vcity');        if ($city == "") {            $this->loadModel("City");            $city = $this->City->find("list");            Cache::write('Vcity', $city);        }        $this->set("city", $city);        $this->set('page', $page);        $this->set('title_for_layout', 'Vendor Partners');        $companyarray = array();        $companyarray = Cache::read('Vcompanyarray');        if ($companyarray == "") {            $this->loadModel("Company");            $company = $this->Company->find('all', array(                'conditions' => array(                    "Company.status" => 1                ),                'joins' => array(                    array(                        'table' => 'users',                        'alias' => 'User',                        'type' => 'LEFT',                        'conditions' => array(                            'Company.user_id = User.id'                        )                    )),                'order' => array('Company.name' => 'asc'),                'fields' => array(                    'Company.id', 'User.id', 'User.uniqid', 'Company.name',                )            ));            if (!empty($company)) {                foreach ($company as $key => $vl) {                    $companyarray[$vl['User']['id']] = $vl['Company']['name'] . ' (' . $vl['User']['uniqid'] . ')';                }            }            Cache::write('Vcompanyarray', $companyarray);        }        $this->set("company", $companyarray);    }    public function getpdf($value) {        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);        $conditions = array();        $limitValue = $limit = 25;//$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $conditions = array();        array_push($conditions, array('user_role_id' => array(2, 5)));        if (!empty($this->request->query)) {            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => $this->request->query['state_id']));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));//                array_push($conditions, array(//                    'OR' => array(//                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['firstname']) . "%",//                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['firstname']) . "%",//                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['firstname']) . "%",//                    )//                ));                $this->set("firstname", $this->request->query['firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));                $this->set("mobile", $this->request->query['mobile']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->{$this->modelClass}->belongsTo = array(            'State' => array(                'className' => 'State',                'foreignKey' => 'state_id'            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'        ));        $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array(                'Usermgmt.status', 'Usermgmt.created', 'Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.email', 'Usermgmt.address',                'Usermgmt.mobile', 'Usermgmt.image', 'Usermgmt.uniqid', 'Usermgmt.type', 'Usermgmt.state_id', 'Usermgmt.city_id', 'State.name', 'City.name'            ),            'recursive' => 5,            'order' => array($this->modelClass . '.created' => 'desc')        ));        //$result = $this->paginate();        $this->set('page', $page);        $count_new_bookings = count($result);//        $count_new_bookings = $this->Usermgmt->find('count', array(//            'conditions' => $conditions//        ));        $this->set("count_new_bookings", $count_new_bookings);//pr($result);exit;        $header = array('S.No.', 'Vendor ID', 'Vendor Name', 'Company Name', 'Mobile No.', 'Email ID', 'State', 'City', 'Registered On', 'Status');        $result_value = array();        $i = 1;        if (!empty($result)) {            $header = array('S.No.', 'Vendor ID', 'Vendor Name', 'Company Name', 'Mobile No.', 'Email ID', 'State', 'City', 'Registered On', 'Status');            if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }            foreach ($result as $key => $res) {                if ($res['Usermgmt']['status'] == 1) {                    $chang = "Active";                } else {                    $chang = "Inactive";                }                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Company Name'] = ((isset($res['Company'][0]['name']) && $res['Company'][0]['name'] != NULL) ? $res['Company'][0]['name'] : '---');                $result_value[$key]['Mobile No.'] = $res['Usermgmt']['mobile'] ? $res['Usermgmt']['mobile'] : "---";                $result_value[$key]['Email ID'] = $res['Usermgmt']['email'] ? $res['Usermgmt']['email'] : "---";                $result_value[$key]['state'] = isset($res['OperationCity'][0]['City']['State']['name']) ? $res['OperationCity'][0]['City']['State']['name'] : '----';                $result_value[$key]['city'] = isset($res['OperationCity'][0]['City']['name']) ? $res['OperationCity'][0]['City']['name'] : '----';                $result_value[$key]['Registered On'] = date(DATE_FORMAT, strtotime($res['Usermgmt']['created']));                $result_value[$key]['Status'] = $chang;                $i--;            }        }        $this->export_file($header, $result_value, 'pdf');        die;    }    public function getcsv($value) {        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);        $conditions = array();        $conditions = array();        $limitValue = $limit = 25;//$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $conditions = array();        array_push($conditions, array('user_role_id' => array(2, 5)));        if (!empty($this->request->query)) {            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => $this->request->query['state_id']));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {//                array_push($conditions, array(//                    'OR' => array(//                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['firstname']) . "%",//                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['firstname']) . "%",//                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['firstname']) . "%",//                    )//                ));                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));                $this->set("firstname", $this->request->query['firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));                $this->set("mobile", $this->request->query['mobile']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->{$this->modelClass}->belongsTo = array(            'State' => array(                'className' => 'State',                'foreignKey' => 'state_id'            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'        ));		 $this->{$this->modelClass}->virtualFields = array(           			'total_booking' => 'select count(vendor_id) from bookings where bookings.vendor_id=Usermgmt.id and booking_status=5'                             );        $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array(                'Usermgmt.status', 'Usermgmt.created', 'Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.email', 'Usermgmt.address',                'Usermgmt.mobile', 'Usermgmt.image','Usermgmt.total_booking', 'Usermgmt.pen_card', 'Usermgmt.uniqid', 'Usermgmt.type', 'Usermgmt.state_id', 'Usermgmt.city_id', 'State.name', 'City.name'            ),            'recursive' => 5,            'order' => array($this->modelClass . '.created' => 'desc')        ));        //$result = $this->paginate();        $this->set('page', $page);        $count_new_bookings = $this->Usermgmt->find('count', array(            'conditions' => $conditions        ));        $this->set("count_new_bookings", $count_new_bookings);//pr($result);exit;        $header = array('S.No.', 'Vendor ID', 'Vendor Name', 'Pan Card Number', 'Company Name', 'Mobile No.', 'Email ID', 'State', 'City','Total Booking', 'Registered On', 'Status');        $result_value = array();        $i = 1;        if (!empty($result)) {            if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }            foreach ($result as $key => $res) {                if ($res['Usermgmt']['status'] == 1) {                    $chang = "Active";                } else {                    $chang = "Inactive";                }                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Pan Card Number'] = $res['Usermgmt']['pen_card'];                $result_value[$key]['Company Name'] = ((isset($res['Company'][0]['name']) && $res['Company'][0]['name'] != NULL) ? $res['Company'][0]['name'] : '---');                $result_value[$key]['Mobile No.'] = $res['Usermgmt']['mobile'] ? $res['Usermgmt']['mobile'] : "---";                $result_value[$key]['Email ID'] = $res['Usermgmt']['email'] ? $res['Usermgmt']['email'] : "---";                $result_value[$key]['state'] = isset($res['OperationCity'][0]['City']['State']['name']) ? $res['OperationCity'][0]['City']['State']['name'] : '----';                $result_value[$key]['city'] = isset($res['OperationCity'][0]['City']['name']) ? $res['OperationCity'][0]['City']['name'] : '----';				$result_value[$key]['Total Booking'] = $res['Usermgmt']['total_booking'] ? $res['Usermgmt']['total_booking'] : "---";                $result_value[$key]['Registered On'] = date(DATE_FORMAT, strtotime($res['Usermgmt']['created']));                $result_value[$key]['Status'] = $chang;                $i--;            }        }        $this->export_file($header, $result_value, 'csv');        die;    }    function driver($id = null) {        $limitValue = $limit = 25;        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        if ($id != null) {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('My Profile'));            $this->set('breadcrumb', $breadcrumb);        } else {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('Driver'));            $this->set('breadcrumb', $breadcrumb);        }        $this->update_alert_seen("usermgmt", "index");        $conditions = array();        array_push($conditions, array('Usermgmt.user_role_id' => 4, 'Usermgmt.driver_type' => 0));        if (!empty($this->request->query)) {            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => "" . $this->request->query['state_id'] . ""));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['driver_firstname']) && $this->request->query['driver_firstname'] != "") {                array_push($conditions, array(                    'OR' => array(                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['driver_firstname']) . "%",                    )                ));                $this->set("driver_firstname", $this->request->query['driver_firstname']);            }            if (isset($this->request->query['driver_uniqid']) && $this->request->query['driver_uniqid'] != "") {                /* array_push($conditions, array('Usermgmt.uniqid' => $this->request->query['driver_uniqid']));                  $this->set("driver_uniqid", $this->request->query['driver_uniqid']); */                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['driver_uniqid'] . "%"));                $this->set("driver_uniqid", $this->request->query['driver_uniqid']);            }            if (isset($this->request->query['driver_mobile']) && $this->request->query['driver_mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['driver_mobile']));                $this->set("driver_mobile", $this->request->query['driver_mobile']);            }            if (isset($this->request->query['license_no']) && $this->request->query['license_no'] != "") {                array_push($conditions, array('Usermgmt.license_no' => $this->request->query['license_no']));                $this->set("license_no", $this->request->query['license_no']);            }//           /vendor_id            if (isset($this->request->query['vendor_firstname']) && $this->request->query['vendor_firstname'] != "") {//                array_push($conditions, array(//                    'OR' => array(//                        'LOWER(Vendor.firstname) LIKE' => "%" . strtolower($this->request->query['vendor_firstname']) . "%",//                        'LOWER(Vendor.lastname) LIKE' => "%" . strtolower($this->request->query['vendor_firstname']) . "%",//                        "LOWER(CONCAT_WS(' ',Vendor.firstname,Vendor.lastname)) LIKE" => "%" . strtolower($this->request->query['vendor_firstname']) . "%",//                    )//                ));                array_push($conditions, array('Usermgmt.vendor_id' => $this->request->query['vendor_firstname']));                $this->set("vendor_firstname", $this->request->query['vendor_firstname']);            }            if (isset($this->request->query['vendor_uniqid']) && $this->request->query['vendor_uniqid'] != "") {                array_push($conditions, array('Vendor.uniqid' => $this->request->query['vendor_uniqid']));                $this->set("vendor_uniqid", $this->request->query['vendor_uniqid']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['verified']) && $this->request->query['verified'] != "") {                array_push($conditions, array('Usermgmt.verified' => $this->request->query['verified']));                $this->set("verified", $this->request->query['verified']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        if (!empty($this->data)) {            if (!empty($this->data['id'])) {                $submit_aciton = $this->data['Usermgmt']['my_action'];                foreach ($this->data['id'] as $mainid) {                    if ($mainid != '') {                        if ($submit_aciton == 'delete') {                            $this->Usermgmt->delete($mainid);                            $message = "Deleted Successfully";                        }                        if ($submit_aciton == 'active') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '1'), array('Usermgmt.id' => $mainid));                            $message = "Activated Successfully";                        }                        if ($submit_aciton == 'inactive') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '0'), array('Usermgmt.id' => $mainid));                            $message = "Inactivated Successfully";                        }                    }                }                $this->Session->setFlash($message, 'default', array('class' => 'success'));            } else {                if (!empty($this->data) && isset($this->data['recordsPerPage'])) {//$limitValue = $limit = $this->data['recordsPerPage'];                    $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);                } else {// pr($this->data);                    $this->Prg->commonProcess();                }            }        }//$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Driver');        $this->Usermgmt->unbindModel(array('hasMany' => array('Company', 'DriverInformation', 'OperationCity', 'CompanyInformation')), false);        $this->{$this->modelClass}->virtualFields = array(            // 'un_verified' => 'select count(driver_id) from driver_logs where driver_logs.driver_id=Usermgmt.id and status=5 and user_id IN(1,37)'            //'country_name' => 'Select name From countries Where id= Usermgmt.country_id',            //'state_name' => 'Select name From states Where id= Usermgmt.state_id',            //'city_name' => 'Select name From cities Where id= Usermgmt.city_id',            // 'vendor_uniq_id' => 'Select uniqid From users Where id= Usermgmt.vendor_id',            // 'vendor_firstname' => 'Select firstname From users Where id= Usermgmt.vendor_id',            // 'vendor_lastname' => 'Select lastname From users Where id= Usermgmt.vendor_id',            // 'total_booking' => 'select count(driver_id) from bookings where bookings.driver_id=Usermgmt.id and booking_status=5'            // 'total_booking' => 'select count(assigned_drivers.bookingid) from assigned_drivers where assigned_drivers.driverid=Usermgmt.id',            'avgRating' => 'select AVG(rating) from customer_ratings where customer_ratings.driver_id=Usermgmt.id',        );        //$parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        //$parsedConditions['user_role_id'] = 4;        if ($id != null) {            $conditions['id'] = $id;        }        $this->paginate = array(            'conditions' => array($conditions),            'fields' => array("Usermgmt.id", "Usermgmt.uniqid", "Usermgmt.firstname", "Usermgmt.status_by_admin", "Usermgmt.lastname", "Usermgmt.mobile", "Usermgmt.license_no", "Usermgmt.dob", "Usermgmt.avgRating", "Usermgmt.created", "Usermgmt.status", "Usermgmt.verified", "UserState.state_name", "UserCity.city_name", "Vendor.id", "Vendor.firstname", "Vendor.lastname", "Vendor.uniqid",),            'joins' => array(                array(                    'table' => 'user_states',                    'alias' => 'UserState',                    'type' => 'LEFT',                    'conditions' => array(                        'UserState.state_id = Usermgmt.state_id'                    )                ),                array(                    'table' => 'user_cities',                    'alias' => 'UserCity',                    'type' => 'LEFT',                    'conditions' => array(                        'UserCity.city_id = Usermgmt.city_id'                    )                ),                array(                    'table' => 'users',                    'alias' => 'Vendor',                    'type' => 'LEFT',                    'conditions' => array(                        'Vendor.id = Usermgmt.vendor_id'                    )                ),            ),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        //Configure::write('debug', 2);        //	 pr($this->paginate());        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());        $this->set('tab_open', 'partners');        $state = Cache::read('state');        if ($state == "") {            $this->loadModel("UserState");            $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));            Cache::write('state', $state);        }        $this->set("states", $state);        $city = Cache::read('city');        if ($city == "") {            $this->loadModel("UserCity");            $city = $this->UserCity->find("list", array("fields" => array("city_id", "city_name")));            Cache::write('city', $city);        }        $this->set("city", $city);        $this->set('page', $page);        $this->set('title_for_layout', 'Driver List');        $companyarray = Cache::read('CompanyarrayUsers');        if ($companyarray == "") {            $this->loadModel("Company");            $company = $this->Company->find('all', array(                'conditions' => array(                    "Company.status" => 1                ),                'joins' => array(                    array(                        'table' => 'users',                        'alias' => 'User',                        'type' => 'LEFT',                        'conditions' => array(                            'Company.user_id = User.id'                        )                    )),                'order' => array('Company.name' => 'asc'),                'fields' => array(                    'Company.id', 'User.id', 'User.uniqid', 'Company.name',                )            ));            if (!empty($company)) {                foreach ($company as $key => $vl) {                    $companyarray[$vl['User']['id']] = $vl['Company']['name'] . ' (' . $vl['User']['uniqid'] . ')';                }            }            Cache::write('CompanyarrayUsers', $companyarray);        }        $this->set("company", $companyarray);    }    public function getpdf_driver($value) {        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);        $conditions = array();        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $conditions = array();        array_push($conditions, array('Usermgmt.user_role_id' => 4));        if (!empty($this->request->query)) {            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => "" . $this->request->query['state_id'] . ""));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['driver_firstname']) && $this->request->query['driver_firstname'] != "") {                array_push($conditions, array(                    'OR' => array(                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['driver_firstname']) . "%",                    )                ));                $this->set("driver_firstname", $this->request->query['driver_firstname']);            }            if (isset($this->request->query['driver_uniqid']) && $this->request->query['driver_uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid' => $this->request->query['driver_uniqid']));                $this->set("driver_uniqid", $this->request->query['driver_uniqid']);            }            if (isset($this->request->query['driver_mobile']) && $this->request->query['driver_mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['driver_mobile']));                $this->set("driver_mobile", $this->request->query['driver_mobile']);            }            if (isset($this->request->query['license_no']) && $this->request->query['license_no'] != "") {                array_push($conditions, array('Usermgmt.license_no' => $this->request->query['license_no']));                $this->set("license_no", $this->request->query['license_no']);            }            if (isset($this->request->query['vendor_firstname']) && $this->request->query['vendor_firstname'] != "") {//                array_push($conditions, array(//                    'OR' => array(//                        'LOWER(Vendor.firstname) LIKE' => "%" . strtolower($this->request->query['vendor_firstname']) . "%",//                        'LOWER(Vendor.lastname) LIKE' => "%" . strtolower($this->request->query['vendor_firstname']) . "%",//                        "LOWER(CONCAT_WS(' ',Vendor.firstname,Vendor.lastname)) LIKE" => "%" . strtolower($this->request->query['vendor_firstname']) . "%",//                    )//                ));                array_push($conditions, array('Usermgmt.vendor_id' => $this->request->query['vendor_firstname']));                $this->set("vendor_firstname", $this->request->query['vendor_firstname']);            }            if (isset($this->request->query['vendor_uniqid']) && $this->request->query['vendor_uniqid'] != "") {                array_push($conditions, array('Vendor.uniqid' => $this->request->query['vendor_uniqid']));                $this->set("vendor_uniqid", $this->request->query['vendor_uniqid']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['verified']) && $this->request->query['verified'] != "") {                array_push($conditions, array('Usermgmt.verified' => $this->request->query['verified']));                $this->set("verified", $this->request->query['verified']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $limitValue = $limit = 25;//$this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $this->{$this->modelClass}->virtualFields = array(            'country_name' => 'Select name From countries Where id= Usermgmt.country_id',            'state_name' => 'Select name From states Where id= Usermgmt.state_id',            'city_name' => 'Select name From cities Where id= Usermgmt.city_id',            'vendor_uniq_id' => 'Select uniqid From users Where id= Usermgmt.vendor_id',            'vendor_firstname' => 'Select firstname From users Where id= Usermgmt.vendor_id',            'vendor_lastname' => 'Select lastname From users Where id= Usermgmt.vendor_id',            'total_booking' => 'select count(assigned_drivers.bookingid) from assigned_drivers where assigned_drivers.driverid=Usermgmt.id',        );        $this->paginate = array(            'conditions' => array($conditions),            'joins' => array(                array(                    'table' => 'countries',                    'alias' => 'Country',                    'type' => 'LEFT',                    'conditions' => array(                        'Country.id = Usermgmt.country_id'                    )                ),                array(                    'table' => 'states',                    'alias' => 'State',                    'type' => 'LEFT',                    'conditions' => array(                        'State.id = Usermgmt.state_id'                    )                ),                array(                    'table' => 'cities',                    'alias' => 'City',                    'type' => 'LEFT',                    'conditions' => array(                        'City.id = Usermgmt.city_id'                    )                ),                array(                    'table' => 'users',                    'alias' => 'Vendor',                    'type' => 'LEFT',                    'conditions' => array(                        'Vendor.id = Usermgmt.vendor_id'                    )                ),            ),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('page', $page);        $count_new_bookings = $this->Usermgmt->find('count', array(            'conditions' => $conditions,            'joins' => array(                array(                    'table' => 'countries',                    'alias' => 'Country',                    'type' => 'LEFT',                    'conditions' => array(                        'Country.id = Usermgmt.country_id'                    )                ),                array(                    'table' => 'states',                    'alias' => 'State',                    'type' => 'LEFT',                    'conditions' => array(                        'State.id = Usermgmt.state_id'                    )                ),                array(                    'table' => 'cities',                    'alias' => 'City',                    'type' => 'LEFT',                    'conditions' => array(                        'City.id = Usermgmt.city_id'                    )                ),                array(                    'table' => 'users',                    'alias' => 'Vendor',                    'type' => 'LEFT',                    'conditions' => array(                        'Vendor.id = Usermgmt.vendor_id'                    )                ),            ),        ));        $result = $this->paginate();//pr($result);exit;        $header = array('S.No.', 'State', 'City', 'Driver ID', 'Driver Name', 'Mobile Number', 'Driving License Number', 'Registered On', 'Vendor ID', 'Vendor Name', 'Total Booking', 'Status', 'Verified');        $result_value = array();        $i = 1;        if (!empty($result)) {            $header = array('S.No.', 'State', 'City', 'Driver ID', 'Driver Name', 'Mobile Number', 'Driving License Number', 'Age', 'Registered On', 'Vendor ID', 'Vendor Name', 'Total Booking', 'Status', 'Verified');            if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }            foreach ($result as $key => $res) {                if ($res['Usermgmt']['status'] == 1) {                    $status = "Active";                } else {                    $status = "Inactive";                }                if ($res['Usermgmt']['verified'] == 1) {                    $verified = "Verified";                } else {                    $verified = "UnVerified";                }                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['state'] = $res['Usermgmt']['state_name'] ? $res['Usermgmt']['state_name'] : '----';                $result_value[$key]['city'] = $res['Usermgmt']['city_name'] ? $res['Usermgmt']['city_name'] : '----';                $result_value[$key]['Driver ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Driver Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Mobile Number'] = $res['Usermgmt']['mobile'];                $result_value[$key]['Driving License Number'] = $res['Usermgmt']['license_no'];                $current_year = date('Y');                $dob_year = date('Y', strtotime($res['Usermgmt']['dob']));                $result_value[$key]['Age'] = $current_year - $dob_year;                $result_value[$key]['Registered On'] = date(DATE_FORMAT, strtotime($res['Usermgmt']['created']));                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['vendor_uniq_id'] ? $res['Usermgmt']['vendor_uniq_id'] : "---";                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['vendor_firstname'] . ' ' . $res['Usermgmt']['vendor_lastname'];                $result_value[$key]['Total Booking'] = $res['Usermgmt']['total_booking'];                $result_value[$key]['Status'] = $status;                $result_value[$key]['Verified'] = $verified;                $i--;            }        }        $this->export_file($header, $result_value, 'pdf');        die;    }    public function getcsv_driver($value) {        Configure::write('debug', 2);        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);        $conditions = array();        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $conditions = array();        array_push($conditions, array('Usermgmt.user_role_id' => 4));        if (!empty($this->request->query)) {            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => "" . $this->request->query['state_id'] . ""));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['driver_firstname']) && $this->request->query['driver_firstname'] != "") {                array_push($conditions, array(                    'OR' => array(                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['driver_firstname']) . "%",                    )                ));                $this->set("driver_firstname", $this->request->query['driver_firstname']);            }            if (isset($this->request->query['driver_uniqid']) && $this->request->query['driver_uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid' => $this->request->query['driver_uniqid']));                $this->set("driver_uniqid", $this->request->query['driver_uniqid']);            }            if (isset($this->request->query['driver_mobile']) && $this->request->query['driver_mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['driver_mobile']));                $this->set("driver_mobile", $this->request->query['driver_mobile']);            }            if (isset($this->request->query['license_no']) && $this->request->query['license_no'] != "") {                array_push($conditions, array('Usermgmt.license_no' => $this->request->query['license_no']));                $this->set("license_no", $this->request->query['license_no']);            }            if (isset($this->request->query['vendor_firstname']) && $this->request->query['vendor_firstname'] != "") {                 array_push($conditions, array('Usermgmt.vendor_id' => $this->request->query['vendor_firstname']));                $this->set("vendor_firstname", $this->request->query['vendor_firstname']);            }            if (isset($this->request->query['vendor_uniqid']) && $this->request->query['vendor_uniqid'] != "") {                array_push($conditions, array('Vendor.uniqid' => $this->request->query['vendor_uniqid']));                $this->set("vendor_uniqid", $this->request->query['vendor_uniqid']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['verified']) && $this->request->query['verified'] != "") {                array_push($conditions, array('Usermgmt.verified' => $this->request->query['verified']));                $this->set("verified", $this->request->query['verified']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        $limitValue = $limit = 25;         $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $this->{$this->modelClass}->virtualFields = array(            'country_name' => 'Select name From countries Where id= Usermgmt.country_id',            'state_name' => 'Select name From states Where id= Usermgmt.state_id',            'city_name' => 'Select name From cities Where id= Usermgmt.city_id',            'comp_name' => 'Select name From companies Where user_id= Usermgmt.vendor_id',            'vendor_uniq_id' => 'Select uniqid From users Where id= Usermgmt.vendor_id',            'vendor_firstname' => 'Select firstname From users Where id= Usermgmt.vendor_id',            'vendor_lastname' => 'Select lastname From users Where id= Usermgmt.vendor_id',            'total_booking' => 'select count(assigned_drivers.bookingid) from assigned_drivers where assigned_drivers.driverid=Usermgmt.id',                //'total_booking' => 'select count(driver_id) from bookings where bookings.driver_id=Usermgmt.id and booking_status=5'        );           $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'joins' => array(                array(                    'table' => 'countries',                    'alias' => 'Country',                    'type' => 'LEFT',                    'conditions' => array(                        'Country.id = Usermgmt.country_id'                    )                ),                array(                    'table' => 'states',                    'alias' => 'State',                    'type' => 'LEFT',                    'conditions' => array(                        'State.id = Usermgmt.state_id'                    )                ),                array(                    'table' => 'cities',                    'alias' => 'City',                    'type' => 'LEFT',                    'conditions' => array(                        'City.id = Usermgmt.city_id'                    )                ),                array(                    'table' => 'users',                    'alias' => 'Vendor',                    'type' => 'LEFT',                    'conditions' => array(                        'Vendor.id = Usermgmt.vendor_id'                    )                ),            ),            //'limit' => $limit,            'order' => array('total_booking' => 'desc')        ));        //pr($result); exit;        $this->set('page', $page);        $count_new_bookings = count($result);        $result_value = array();        $i = 1;        if (!empty($result)) {            $header = array('S.No.', 'State', 'City', 'Driver ID', 'Driver Name', 'Mobile Number', 'Driving License Number', 'Age', 'Registered On', 'Vendor ID', 'Vendor Name', 'Company Name', 'Total Booking', 'Status', 'Verified');            if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }            foreach ($result as $key => $res) {                if ($res['Usermgmt']['status'] == 1) {                    $status = "Active";                } else {                    $status = "Inactive";                }                if ($res['Usermgmt']['verified'] == 1) {                    $verified = "Verified";                } else {                    $verified = "UnVerified";                }                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['state'] = $res['Usermgmt']['state_name'] ? $res['Usermgmt']['state_name'] : '----';                $result_value[$key]['city'] = $res['Usermgmt']['city_name'] ? $res['Usermgmt']['city_name'] : '----';                $result_value[$key]['Driver ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Driver Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Mobile Number'] = $res['Usermgmt']['mobile'];                $result_value[$key]['Driving License Number'] = $res['Usermgmt']['license_no'];                $current_year = date('Y');                $dob_year = date('Y', strtotime($res['Usermgmt']['dob']));                $result_value[$key]['Age'] = $current_year - $dob_year;                $result_value[$key]['Registered On'] = date(DATE_FORMAT, strtotime($res['Usermgmt']['created']));                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['vendor_uniq_id'] ? $res['Usermgmt']['vendor_uniq_id'] : "---";                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['vendor_firstname'] . ' ' . $res['Usermgmt']['vendor_lastname'];                $result_value[$key]['Company Name'] = $res['Usermgmt']['comp_name'];                $result_value[$key]['Total Booking'] = $res['Usermgmt']['total_booking'];                $result_value[$key]['Status'] = $status;                $result_value[$key]['Verified'] = $verified;                $i--;            }        }        $this->export_file($header, $result_value, 'csv');        die;    }			 public function getcsv_dco($value) {        Configure::write('debug', 2);        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);		$this->request->query = $value;        $conditions = array();        $limitValue = $limit = 25;        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->set('limitValue', $limitValue);        $page = ((isset($value['page']) && $value['page'] != NULL) ? $value['page'] : 0);		        $conditions = array();        array_push($conditions, array('Usermgmt.driver_type' => '1', 'Usermgmt.user_role_id' => array(4)));        if (!empty($this->request->query)) {            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));                $this->set("mobile", $this->request->query['mobile']);            }            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => "" . $this->request->query['state_id'] . ""));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['driver_firstname']) && $this->request->query['driver_firstname'] != "") {                array_push($conditions, array(                    'OR' => array(                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['driver_firstname']) . "%",                    )                ));                $this->set("driver_firstname", $this->request->query['driver_firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                /* array_push($conditions, array('Usermgmt.uniqid' => $this->request->query['driver_uniqid']));                  $this->set("driver_uniqid", $this->request->query['driver_uniqid']); */                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['verified']) && $this->request->query['verified'] != "") {                array_push($conditions, array('Usermgmt.verified' => $this->request->query['verified']));                $this->set("verified", $this->request->query['verified']);            }            if (isset($this->request->query['license_no']) && $this->request->query['license_no'] != "") {                array_push($conditions, array('Usermgmt.license_no' => $this->request->query['license_no']));                $this->set("license_no", $this->request->query['license_no']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }            $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;               $this->Usermgmt->virtualFields = array(            'city_name' => 'Select city_name From user_cities Where city_id= Usermgmt.city_id limit 1',            'state_name' => 'Select state_name From user_states Where state_id= Usermgmt.state_id limit 1',            'plate_no' => 'Select plate_no From taxis Where user_id= Usermgmt.id limit 1',            //'created_by' => 'Select user_name From driver_logs Where driver_id= Usermgmt.id AND status="0" limit 1',            //'verified_by' => 'Select user_name From driver_logs Where driver_id= Usermgmt.id AND status=4 order by id desc limit 1',		    'comp_name' => 'Select name From companies Where user_id= Usermgmt.vendor_id',		    'vendor_uniq_id' => 'Select uniqid From users Where id= Usermgmt.vendor_id',		    'vendor_firstname' => 'Select firstname From users Where id= Usermgmt.vendor_id',            'vendor_lastname' => 'Select lastname From users Where id= Usermgmt.vendor_id',            'total_booking' => 'select count(assigned_drivers.bookingid) from assigned_drivers where assigned_drivers.driverid=Usermgmt.id',        );        $this->Usermgmt->unbindModel(array('hasMany' => array('Company', 'OperationCity', 'CompanyInformation', 'DriverInformation')), false);        $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array("city_name", "plate_no", "id", "uniqid", "firstname", 'mgf_vendor', "status_by_admin", "lastname", "mobile", "license_no", "dob", "created", "status", "verified", "comp_name", "vendor_uniq_id", "vendor_firstname", "vendor_lastname", "total_booking", "state_name"),            //'limit' => $limit,            'order' => array('Usermgmt.id' => 'desc'),        ));		//pr($result); exit;        $this->set('page', $page);        $count_new_bookings = count($result);        $result_value = array();       // $i = 1;	    $header = array('S.No.', 'State', 'City', 'Driver ID', 'Driver Name', 'Mobile Number', 'Driving License Number', 'Age', 'Registered On', 'Vendor ID', 'Vendor Name', 'Company Name', 'Total Booking', 'Status', 'Verified');	           if (!empty($result)) {            $header = array('S.No.', 'State', 'City', 'Driver ID', 'Driver Name', 'Mobile Number', 'Driving License Number', 'Age', 'Registered On', 'Vendor ID', 'Vendor Name', 'Company Name', 'Total Booking', 'Status', 'Verified');             if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }  						//$i = $count_new_bookings;			            foreach ($result as $key => $res) {                if ($res['Usermgmt']['status'] == 1) {                    $status = "Active";                } else {                    $status = "Inactive";                }                if ($res['Usermgmt']['verified'] == 1) {                    $verified = "Verified";                } else {                    $verified = "UnVerified";                }                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['state'] = $res['Usermgmt']['state_name'] ? $res['Usermgmt']['state_name'] : '----';                $result_value[$key]['city'] = $res['Usermgmt']['city_name'] ? $res['Usermgmt']['city_name'] : '----';                $result_value[$key]['Driver ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Driver Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Mobile Number'] = $res['Usermgmt']['mobile'];                $result_value[$key]['Driving License Number'] = $res['Usermgmt']['license_no'];                $current_year = date('Y');                $dob_year = date('Y', strtotime($res['Usermgmt']['dob']));                $result_value[$key]['Age'] = $current_year - $dob_year;                $result_value[$key]['Registered On'] = date(DATE_FORMAT, strtotime($res['Usermgmt']['created']));                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['vendor_uniq_id'] ? $res['Usermgmt']['vendor_uniq_id'] : "---";                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['vendor_firstname'] . ' ' . $res['Usermgmt']['vendor_lastname'];                $result_value[$key]['Company Name'] = $res['Usermgmt']['comp_name'];                $result_value[$key]['Total Booking'] = $res['Usermgmt']['total_booking'];                $result_value[$key]['Status'] = $status;                $result_value[$key]['Verified'] = $verified;								                $i--;            }        }        $this->export_file($header, $result_value, 'csv');        die;    }		public function getpdf_dco($value) {        Configure::write('debug', 2);        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);		$this->request->query = $value;        $conditions = array();        $limitValue = $limit = 25;        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->set('limitValue', $limitValue);        $page = ((isset($value['page']) && $value['page'] != NULL) ? $value['page'] : 0);		        $conditions = array();        array_push($conditions, array('Usermgmt.driver_type' => '1', 'Usermgmt.user_role_id' => array(4)));        if (!empty($this->request->query)) {            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));                $this->set("mobile", $this->request->query['mobile']);            }            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => "" . $this->request->query['state_id'] . ""));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['driver_firstname']) && $this->request->query['driver_firstname'] != "") {                array_push($conditions, array(                    'OR' => array(                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['driver_firstname']) . "%",                    )                ));                $this->set("driver_firstname", $this->request->query['driver_firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                /* array_push($conditions, array('Usermgmt.uniqid' => $this->request->query['driver_uniqid']));                  $this->set("driver_uniqid", $this->request->query['driver_uniqid']); */                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['verified']) && $this->request->query['verified'] != "") {                array_push($conditions, array('Usermgmt.verified' => $this->request->query['verified']));                $this->set("verified", $this->request->query['verified']);            }            if (isset($this->request->query['license_no']) && $this->request->query['license_no'] != "") {                array_push($conditions, array('Usermgmt.license_no' => $this->request->query['license_no']));                $this->set("license_no", $this->request->query['license_no']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }            $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;               $this->Usermgmt->virtualFields = array(            'city_name' => 'Select city_name From user_cities Where city_id= Usermgmt.city_id limit 1',            'state_name' => 'Select state_name From user_states Where state_id= Usermgmt.state_id limit 1',            'plate_no' => 'Select plate_no From taxis Where user_id= Usermgmt.id limit 1',            //'created_by' => 'Select user_name From driver_logs Where driver_id= Usermgmt.id AND status="0" limit 1',            //'verified_by' => 'Select user_name From driver_logs Where driver_id= Usermgmt.id AND status=4 order by id desc limit 1',		    'comp_name' => 'Select name From companies Where user_id= Usermgmt.vendor_id',		    'vendor_uniq_id' => 'Select uniqid From users Where id= Usermgmt.vendor_id',		    'vendor_firstname' => 'Select firstname From users Where id= Usermgmt.vendor_id',            'vendor_lastname' => 'Select lastname From users Where id= Usermgmt.vendor_id',            'total_booking' => 'select count(assigned_drivers.bookingid) from assigned_drivers where assigned_drivers.driverid=Usermgmt.id',        );        $this->Usermgmt->unbindModel(array('hasMany' => array('Company', 'OperationCity', 'CompanyInformation', 'DriverInformation')), false);        $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array("city_name", "plate_no", "id", "uniqid", "firstname", 'mgf_vendor', "status_by_admin", "lastname", "mobile", "license_no", "dob", "created", "status", "verified", "comp_name", "vendor_uniq_id", "vendor_firstname", "vendor_lastname", "total_booking", "state_name"),            //'limit' => $limit,            'order' => array('Usermgmt.id' => 'desc'),        ));		//pr($result); exit;        $this->set('page', $page);        $count_new_bookings = count($result);        $result_value = array();       // $i = 1;        if (!empty($result)) {            $header = array('S.No.', 'State', 'City', 'Driver ID', 'Driver Name', 'Mobile Number', 'Driving License Number', 'Age', 'Registered On', 'Vendor ID', 'Vendor Name', 'Company Name', 'Total Booking', 'Status', 'Verified');             if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }  						//$i = $count_new_bookings;			            foreach ($result as $key => $res) {                if ($res['Usermgmt']['status'] == 1) {                    $status = "Active";                } else {                    $status = "Inactive";                }                if ($res['Usermgmt']['verified'] == 1) {                    $verified = "Verified";                } else {                    $verified = "UnVerified";                }                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['state'] = $res['Usermgmt']['state_name'] ? $res['Usermgmt']['state_name'] : '----';                $result_value[$key]['city'] = $res['Usermgmt']['city_name'] ? $res['Usermgmt']['city_name'] : '----';                $result_value[$key]['Driver ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Driver Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Mobile Number'] = $res['Usermgmt']['mobile'];                $result_value[$key]['Driving License Number'] = $res['Usermgmt']['license_no'];                $current_year = date('Y');                $dob_year = date('Y', strtotime($res['Usermgmt']['dob']));                $result_value[$key]['Age'] = $current_year - $dob_year;                $result_value[$key]['Registered On'] = date(DATE_FORMAT, strtotime($res['Usermgmt']['created']));                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['vendor_uniq_id'] ? $res['Usermgmt']['vendor_uniq_id'] : "---";                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['vendor_firstname'] . ' ' . $res['Usermgmt']['vendor_lastname'];                $result_value[$key]['Company Name'] = $res['Usermgmt']['comp_name'];                $result_value[$key]['Total Booking'] = $res['Usermgmt']['total_booking'];                $result_value[$key]['Status'] = $status;                $result_value[$key]['Verified'] = $verified;								                $i--;            }        }        $this->export_file($header, $result_value, 'pdf');        die;    }	    public function vendor_driverlist($id = null) {        if ($id != null) {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('My Profile'));            $this->set('breadcrumb', $breadcrumb);        } else {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('Driver'));            $this->set('breadcrumb', $breadcrumb);        }        if (!empty($this->data)) {            if (!empty($this->data['id'])) {                $submit_aciton = $this->data['Usermgmt']['my_action'];                foreach ($this->data['id'] as $mainid) {                    if ($mainid != '') {                        if ($submit_aciton == 'delete') {                            $this->Usermgmt->delete($mainid);                            $message = "Deleted Successfully";                        }                        if ($submit_aciton == 'active') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '1'), array('Usermgmt.id' => $mainid));                            $message = "Activated Successfully";                        }                        if ($submit_aciton == 'inactive') {                            $this->Usermgmt->updateAll(array('Usermgmt.status' => '0'), array('Usermgmt.id' => $mainid));                            $message = "Inactivated Successfully";                        }                    }                }                $this->Session->setFlash($message, 'default', array('class' => 'success'));            } else {                if (!empty($this->data) && isset($this->data['recordsPerPage'])) {                    $limitValue = $limit = $this->data['recordsPerPage'];                    $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);                } else {					// pr($this->data);                    $this->Prg->commonProcess();                }            }        }        $page = ((isset($this->params['named']['page']) && $this->params['named']['page'] != NULL) ? $this->params['named']['page'] : 0);        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->set('id', $id);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Driver');        $parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        $parsedConditions[$this->modelClass . '.user_role_id'] = 4;        if ($id != null) {            $parsedConditions[$this->modelClass . '.vendor_id'] = $id;        }        $this->{$this->modelClass}->bindModel(                array('belongsTo' => array(                        'User' => array(                            'className' => $this->modelClass,                            'foreignKey' => 'vendor_id	',                        )                    )                )        );        $this->paginate = array(            'conditions' => array($parsedConditions),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));//        $count_new_bookings = $this->{$this->modelClass}->find('count', array(//            'conditions' => $parsedConditions//        ));//        $this->set("count_new_bookings", $count_new_bookings);        $this->set("page", $page);        $this->set('back', $pageHeading);        $this->loadModel('Company');        $vendor_company = $this->Company->findByUserId($id, array('fields' => 'Company.name'));        $this->set('vendor_company', $vendor_company);        $this->loadModel('User');        $uniqid = $this->User->findById($id, array('fields' => 'User.uniqid'));        $this->set('uniqid', $uniqid);        $this->set('result', $this->paginate());        $this->set('tab_open', 'partners');        if (!empty($vendor_company) && !empty($uniqid)) {            $Vname = $vendor_company['Company']['name'] . "  (" . $uniqid['User']['uniqid'] . ")";        } else {            $Vname = "My";        }        $this->set('title_for_layout', $Vname . ' List of Drivers');    }    function manager($id = null) {        if ($id != null) {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('My Profile'));            $this->set('breadcrumb', $breadcrumb);        } else {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('manager'));            $this->set('breadcrumb', $breadcrumb);        }        if (!empty($this->data) && isset($this->data['recordsPerPage'])) {            $limitValue = $limit = $this->data['recordsPerPage'];            $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);        } else {// pr($this->data);            $this->Prg->commonProcess();        }        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('manager');        $parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        $parsedConditions['user_role_id'] = 5;        if ($id != null) {            $parsedConditions['id'] = $id;        }        $this->paginate = array(            'conditions' => array($parsedConditions),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());    }    function company($id = null) {        if ($id != null) {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('My Profile'));            $this->set('breadcrumb', $breadcrumb);        } else {            $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');            $breadcrumb = array('pages' => $pages, 'active' => __('company'));            $this->set('breadcrumb', $breadcrumb);        }        if (!empty($this->data)) {            if (!empty($this->data['id'])) {                foreach ($this->data['id'] as $mainid) {                    if ($mainid != '') {                        $this->Usermgmt->delete($mainid);                    }                }                $this->Session->setFlash('Deleted successfully', 'default', array('class' => 'success'));            } else {                if (!empty($this->data) && isset($this->data['recordsPerPage'])) {                    $limitValue = $limit = $this->data['recordsPerPage'];                    $this->Session->write($this->name . '.' . $this->action . '.recordsPerPage', $limit);                } else {// pr($this->data);                    $this->Prg->commonProcess();                }            }        }        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Company');        $parsedConditions = $this->{$this->modelClass}->parseCriteria($this->passedArgs);        $parsedConditions['user_role_id'] = 2;        if ($id != null) {            $parsedConditions['id'] = $id;        }        $this->paginate = array(            'conditions' => array($parsedConditions),            'limit' => $limit,            'order' => array($this->modelClass . '.created' => 'desc')        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());    }    public function getcustomers() {// Check cakephp ajax request        if ($this->request->is('Ajax')) {// Load users model            $this->loadModel('Users');// Fire custom query to get all users count by each month and each year.            $res = $this->Users->query("select		year(`created`) as 'YEAR',		sum(month(`created`) = 1) as '1',		sum(month(`created`) = 2) as '2',		sum(month(`created`) = 3) as '3',		sum(month(`created`) = 4) as '4',		sum(month(`created`) = 5) as '5',		sum(month(`created`) = 6) as '6',		sum(month(`created`) = 7) as '7',		sum(month(`created`) = 8) as '8',		sum(month(`created`) = 9) as '9',		sum(month(`created`) = 10) as '10',		sum(month(`created`) = 11) as '11',		sum(month(`created`) = 12) as '12'		FROM `users`		WHERE user_role_id = '3'		AND year(`created`) = '" . date('Y') . "'		GROUP BY 1");// Unset year column            unset($res[0][0]['YEAR']);// Set new array            $cdata = array();            if (count($res) != 0) {                foreach ($res[0][0] as $ydata) {                    $cdata[]['count'] = $ydata;                }                echo '{"success":{"users":' . json_encode($cdata) . '}}';                exit();            } else {                echo '{"success":{"users":[{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"},{"count":"0"}]}}';            }        }        exit();    }    function add() {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Employee', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'index');        $breadcrumb = array('pages' => $pages, 'active' => __('Add Employee', true));        $this->set('breadcrumb', $breadcrumb);        if (!empty($this->data)) {            $image = '';            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->validates()) {                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = '';                    }                } else {                    $image = '';                }                $data = array();                $data['user_role_id'] = 2;                $data['status'] = 1;                $data['firstname'] = $this->data{$this->modelClass}['firstname'];                $data['lastname'] = $this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['username'];                $data['email'] = $this->data{$this->modelClass}['email'];                $data['password'] = AuthComponent::password($this->data{$this->modelClass}['user_password']);                $data['active'] = 1;                $data['image'] = $image;//pr($data); die;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('Employee has been added'), 'success');                    $this->redirect(array('action' => 'index'));                } else {                    $this->Session->setFlash(__('Employee has not been added.'), 'error');                }            }        }    }    function add_customer() {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Passenger', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'customer');        $breadcrumb = array('pages' => $pages, 'active' => __('Add Passenger', true));        $this->set('breadcrumb', $breadcrumb);        $this->loadModel('Country');        $country = $this->Country->find('list', array('order' => 'created desc'));        $this->set('country', $country);        if (!empty($this->data)) {            $image = '';            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->validates()) {//pr($this->data); die;                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = '';                    }                } else {                    $image = '';                }                $data = array();                $data['user_role_id'] = 3;                $data['firstname'] = $this->data{$this->modelClass}['firstname'];//$data['lastname']		=	$this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['firstname'];                $data['email'] = $this->data{$this->modelClass}['email'];                $data['password'] = AuthComponent::password($this->data{$this->modelClass}['password']);                $data['status'] = $this->data{$this->modelClass}['status'];                $data['active'] = 1;                $data['image'] = $image;//pr($data); die;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('Passenger has been added'), 'success');                    $this->redirect(array('action' => 'customer'));                } else {                    $this->Session->setFlash(__('Passenger has not been added.'), 'error');                }            }        }    }    function add_more_address() {        $this->layout = false;        $this->autoRender = false;        $count = $this->data['count'];        $lat = $this->data['lat'];        $lng = $this->data['lng'];        $this->set("count", $count);        $this->set("lat", $lat);        $this->set("lng", $lng);        $this->loadModel("State");        $state = $this->State->find("list", array("conditions" => array("status" => 1)));        $this->set("state", $state);        $this->loadModel("City");        $city = $this->City->find("list", array("conditions" => array("state_id" => $this->data['state'])));        $this->set("city", $city);        $this->set("page_type", $this->data['page_type']);        $this->set("state_id", $this->data['state']);        $this->set("city_id", $this->data['city']);        $this->set("address", $this->data['address']);        $this->set("address_id", $this->data['address_id']);        $data = $this->render('add_more_address');        echo $data;        die();    }    function test_mail() {        $email = "1988rajeshkumar@gmail.com";        $pass = "3232323";        $message = '<table border="0" cellpadding="0" cellspacing="0" border="0">';        $message .= '<tr><td align="left"><h3>Welcome to the Super Cabz</h3></td></tr>                                <tr><td align="left">Your account has been created successfully, Following are your temporary login credentials, you can update your credentials later after login.</h3></td></tr>                                <tr>                                    <td align="left">                                        <table border="0" cellpadding="0" cellspacing="0" width="100%">                                            <tr>                                                <td align="left" width="25%"><strong>Email</strong></td>                                                <td align="left" width="75%">' . $email . '</td>                                            </tr>                                            <tr>                                                <td align="left" width="25%"><strong>Password</strong></td>                                                <td align="left" width="75%">' . $pass . '</td>                                            </tr>                                        </table>                                    </td>                                </tr>                                <tr><td align="left"><strong>Regards,<br/> Super Cabz</strong></td></tr>';        $message .= '</table>';        $mail = new CakeEmail();        $mail->from(array(Configure::read('Site.email') => Configure::read('Site.title')));        $mail->to($email);        $mail->emailFormat('html');        $mail->subject('Welcome to the ' . Configure::read('Site.title') . ' - Your account created successfully');        try {            $res = $mail->send($message);        } catch (Exception $ex) {            $res = $ex;        }        pr($res);        exit;    }    function add_individual() {		//pr($this->request->data); die;        $this->set('tab_open', 'partners');        $lat = '26.826651';        $lng = '75.999';        $this->set("lat", $lat);        $this->set("lng", $lng);        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Customer', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'individual');        $breadcrumb = array('pages' => $pages, 'active' => __('Add Individual', true));        $this->set('breadcrumb', $breadcrumb);        $this->loadModel('Country');        $country = $this->Country->find('list', array('order' => 'created desc'));        $this->loadModel("Zone");        $zone_list = $this->Zone->find("list", array(            'conditions' => array(                "Zone.status" => 1,                "Zone.zone_type" => 1        )));        $this->set("zones", $zone_list);        $this->loadModel("City");        $city_list = $this->City->find("list", array('conditions' => array('City.status' => 'A'), 'order' => array('City.name' => 'Asc')));        $this->set("city_list", $city_list);        $state = array();        $city = array();        $is_success = 1;        if ($this->request->is('post')) {            //pr($this->request->data); exit;            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $this->request->data['Usermgmt']['mobile'],                    'User.user_role_id' => 2                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                $this->Session->setFlash(__('This mobile number already exist.'), 'error');                $this->redirect(array('plugin' => false, 'controller' => 'individual', 'action' => 'add'));            }            /* debug($this->request->data);              die; */			//pr($this->data); die;            $data_chk['firstname'] = $this->data{$this->modelClass}['firstname'];            $data_chk['lastname'] = $this->data{$this->modelClass}['lastname'];            $data_chk['mobile'] = $this->data{$this->modelClass}['mobile'];			//$data_chk['license_no'] = $this->data{$this->modelClass}['license_no'];            $this->{$this->modelClass}->set($data_chk);			//pr($this->Usermgmt->addDriver());exit;            if ($this->Usermgmt->addVendor()) {                $upload_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . DS . 'uploads' . DS . 'photos';                $thumb_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . DS . 'uploads' . DS . 'photos';                if (isset($this->request->data['Usermgmt']['image']) && $this->request->data['Usermgmt']['image']['name'] != "") {                    $allowed_extensions = array('jpg', 'jpeg', 'png', 'gif');                    $uploaded_image = $this->request->data['Usermgmt']['image']['name'];                    $imgExtension = pathinfo($uploaded_image, PATHINFO_EXTENSION);                    $uploadedImagesize = getimagesize($this->request->data['Usermgmt']['image']['tmp_name']);                    $uploadedImageWidth = $uploadedImagesize[0];                    $uploadedImageHeight = $uploadedImagesize[1];                    if (!in_array($imgExtension, $allowed_extensions)) {                        $this->data = $this->request->data;                        $is_success = 0;                        $this->Session->setFlash(__('Photo extension should be of ' . implode(",", $allowed_extensions) . ' only'), 'error');                    }                    $uploadimageArray = $this->request->data['Usermgmt']['image'];                    unset($this->request->data['User']['image']);                } else {                    unset($this->request->data['User']['image']);                }                //identity proof                if (isset($this->request->data['Usermgmt']['identity_proof_img']) && $this->request->data['Usermgmt']['identity_proof_img']['name'] != "") {                    $allowed_extensions_proof = array('jpg', 'jpeg', 'png', 'gif');                    $uploaded_image_proof = $this->request->data['Usermgmt']['identity_proof_img']['name'];                    $imgExtension_proof = pathinfo($uploaded_image_proof, PATHINFO_EXTENSION);                    $uploadedImagesize_proof = getimagesize($this->request->data['Usermgmt']['identity_proof_img']['tmp_name']);                    $uploadedImageWidth_proof = $uploadedImagesize_proof[0];                    $uploadedImageHeight_proof = $uploadedImagesize_proof[1];                    if (!in_array($imgExtension_proof, $allowed_extensions_proof)) {                        $this->data = $this->request->data;                        $is_success = 0;                        $this->Session->setFlash(__('Photo extension should be of ' . implode(",", $allowed_extensions_proof) . ' only'), 'error');                    }                    $uploadimageArray_proof = $this->request->data['Usermgmt']['identity_proof_img'];                    unset($this->request->data['User']['identity_proof_img']);                } else {                    unset($this->request->data['User']['identity_proof_img']);                }                // passport_proof_img id                if (isset($this->request->data['Usermgmt']['passport_proof_img']) && $this->request->data['Usermgmt']['passport_proof_img']['name'] != "") {                    $allowed_extensions_proof = array('jpg', 'jpeg', 'png', 'gif');                    $uploaded_image_proof = $this->request->data['Usermgmt']['passport_proof_img']['name'];                    $imgExtension_proof = pathinfo($uploaded_image_proof, PATHINFO_EXTENSION);                    $uploadedImagesize_proof = getimagesize($this->request->data['Usermgmt']['passport_proof_img']['tmp_name']);                    $uploadedImageWidth_proof = $uploadedImagesize_proof[0];                    $uploadedImageHeight_proof = $uploadedImagesize_proof[1];                    if (!in_array($imgExtension_proof, $allowed_extensions_proof)) {                        $this->data = $this->request->data;                        $is_success = 0;                        $this->Session->setFlash(__('Photo extension should be of ' . implode(",", $allowed_extensions_proof) . ' only'), 'error');                    }                    $uploadimageArray_proof_passport = $this->request->data['Usermgmt']['passport_proof_img'];                    unset($this->request->data['User']['passport_proof_img']);                } else {                    unset($this->request->data['User']['passport_proof_img']);                }                // end//                //$uploadimageArray_proof_aadhar                if (isset($this->request->data['Usermgmt']['aadhar_proof_img']) && $this->request->data['Usermgmt']['aadhar_proof_img']['name'] != "") {                    $allowed_extensions_proof = array('jpg', 'jpeg', 'png', 'gif');                    $uploaded_image_proof = $this->request->data['Usermgmt']['aadhar_proof_img']['name'];                    $imgExtension_proof = pathinfo($uploaded_image_proof, PATHINFO_EXTENSION);                    $uploadedImagesize_proof = getimagesize($this->request->data['Usermgmt']['aadhar_proof_img']['tmp_name']);                    $uploadedImageWidth_proof = $uploadedImagesize_proof[0];                    $uploadedImageHeight_proof = $uploadedImagesize_proof[1];                    if (!in_array($imgExtension_proof, $allowed_extensions_proof)) {                        $this->data = $this->request->data;                        $is_success = 0;                        $this->Session->setFlash(__('Photo extension should be of ' . implode(",", $allowed_extensions_proof) . ' only'), 'error');                    }                    $uploadimageArray_proof_aadhar = $this->request->data['Usermgmt']['aadhar_proof_img'];                    unset($this->request->data['User']['aadhar_proof_img']);                } else {                    unset($this->request->data['User']['aadhar_proof_img']);                }                //                if (isset($this->request->data['Usermgmt']['license_proof_img']) && $this->request->data['Usermgmt']['license_proof_img']['name'] != "") {                    $allowed_extensions_proof = array('jpg', 'jpeg', 'png', 'gif');                    $uploaded_image_proof = $this->request->data['Usermgmt']['license_proof_img']['name'];                    $imgExtension_proof = pathinfo($uploaded_image_proof, PATHINFO_EXTENSION);                    $uploadedImagesize_proof = getimagesize($this->request->data['Usermgmt']['license_proof_img']['tmp_name']);                    $uploadedImageWidth_proof = $uploadedImagesize_proof[0];                    $uploadedImageHeight_proof = $uploadedImagesize_proof[1];                    if (!in_array($imgExtension_proof, $allowed_extensions_proof)) {                        $this->data = $this->request->data;                        $is_success = 0;                        $this->Session->setFlash(__('Photo extension should be of ' . implode(",", $allowed_extensions_proof) . ' only'), 'error');                    }                    $uploadimageArray_proof_license = $this->request->data['Usermgmt']['license_proof_img'];                    unset($this->request->data['User']['license_proof_img']);                } else {                    unset($this->request->data['User']['license_proof_img']);                }                // check duplicate email                $this->loadModel('User');                $check_duplicate_email = $this->User->find('count', array(                    'conditions' => array(                        'User.email' => $this->request->data['Usermgmt']['email']                    ),                    'recursive' => -1                ));                $email_user = $this->request->data['Usermgmt']['email'];                if ($check_duplicate_email > 0) {                    $this->data = $this->request->data;                    $is_success = 0;                    $this->Session->setFlash(__('Email already exists, please use other email'), 'error');                }                $this->loadModel('City');                $cityData = $this->City->findById($this->data['Company']['city_id']);                //$cityname = substr($cityData['City']['name'], 0, 2);                $citycode = $cityData['City']['city_code'];                $unid = time();                $data['uniqid'] = $unid;                $pass = rand(000000, 999999);                // vendor name                 $vendor_name = $this->data{$this->modelClass}['firstname'] . ' ' . $this->data{$this->modelClass}['lastname'];                $vendor_phone = $this->data{$this->modelClass}['mobile'];                $data['user_role_id'] = 2;                //pr($this->data); exit;                $data['company_id']         = isset($this->data{$this->modelClass}['company_id']) ? $this->data{$this->modelClass}['company_id'] : "";                $data['firstname']          = $this->data{$this->modelClass}['firstname'];                $data['lastname']           = $this->data{$this->modelClass}['lastname'];                $data['mobile'] 			= $this->data{$this->modelClass}['mobile'];				$data['alternate_mobile']   = @$this->data{$this->modelClass}['alternate_mobile'];                $data['username']           = $this->data{$this->modelClass}['firstname'];                $data['gender']             = $this->data{$this->modelClass}['gender'];                $data['address']            = $this->data{$this->modelClass}['address'];                $data['residence_address']  = $this->data{$this->modelClass}['residence_address'];                $data['pen_card']           = $this->data{$this->modelClass}['pen_card'];                $data['email']              = $this->data{$this->modelClass}['email'];                $data['city_id']            = $this->data['Company']['city_id'];                $data['state_id']           = $this->data['Company']['state_id'];                $data['country_id']         = 1;                $data['mgf_vendor']         = isset($this->data['Usermgmt']['mgf_vendor']) && $this->data['Usermgmt']['mgf_vendor'] ? $this->data['Usermgmt']['mgf_vendor'] : 0;                $data['allow_corporate_booking'] = isset($this->data['Usermgmt']['allow_corporate_booking']) && $this->data['Usermgmt']['allow_corporate_booking'] ? $this->data['Usermgmt']['allow_corporate_booking'] : 0;                // $data['password'] = AuthComponent::password($this->data{$this->modelClass}['password']);                $data['password']        = AuthComponent::password($pass);                $data['status']          = $this->data{$this->modelClass}['status'];                $data['active'] = 1;                // $sfrom = date("H:i", strtotime($this->data['Company']['sfrom']));                // $sto = date("H:i", strtotime($this->data['Company']['sto']));                //  $this->request->data["Company"]["sfrom"] = $sfrom;                // $this->request->data["Company"]["sto"] = $sto;                $this->request->data["Company"]["sfrom"] = '';                $this->request->data["Company"]["sto"] = '';                $this->request->data["Company"]["gaddress"] = '';                $this->loadModel('User');                //count //                $count_vendor = $this->User->find('count', array(                    'conditions' => array(                        'User.user_role_id' => 2                    ),                ));                //end                if ($is_success == 1) {                    if ($this->{$this->modelClass}->save($data, false)) {                        $c_id = $this->{$this->modelClass}->id;                        //log                        $insert_id = $this->{$this->modelClass}->getLastInsertId();                        $text_action = "added";                        $json_data = json_encode($this->request->data);                        $this->global_logs("usermgmts", $insert_id, 0, $text_action, $json_data);                        $last_id_logic = str_pad($count_vendor + 1, 4, "0", STR_PAD_LEFT);                        $unique_id_vendor = 'VP' . $citycode . $last_id_logic;                        $update_vp_data[$this->modelClass]['uniqid'] = $unique_id_vendor;                        $update_vp_data[$this->modelClass]['id'] = $c_id;                        $update_vp_data[$this->modelClass]['agreement_date'] = date("Y-m-d H:i:s");                        $this->{$this->modelClass}->save($update_vp_data, false);                        $this->loadModel("Company");                        $this->request->data["Company"]["user_id"] = $c_id;                        $this->Company->save($this->data["Company"], false);                        $company_id = $this->Company->getLastInsertID();                        // save vendor fare                        if (!empty($this->data{$this->modelClass}['company_id'])) {                            $this->loadModel("Company");                            $this->Company->id = $this->data{$this->modelClass}['company_id'];                            $this->Company->saveField('assign', 1);                        }                        $this->loadModel("OperationCity");                        if (isset($uploadimageArray) && $uploadimageArray['name'] != "") {                            $file_name = $this->{$this->modelClass}->id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray['name']));                            if (move_uploaded_file($uploadimageArray['tmp_name'], $upload_folder . DS . $file_name)) {                                //$this->resize($file_name, 200, 150, $upload_folder, $thumb_folder);                                /* echo $file_name.'>>>'.$this->{$this->modelClass}->id;                                  die; */                                $this->User->updateAll(array('User.image' => "'" . $file_name . "'"), array('User.id' => $this->{$this->modelClass}->id));                                //unlink($upload_folder . DS . $file_name);                            } else {                                $is_file_uploaded = 0;                            }                        }                        if (isset($uploadimageArray_proof) && $uploadimageArray_proof['name'] != "") {                            $file_name_proof = $this->{$this->modelClass}->id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof['name']));                            if (move_uploaded_file($uploadimageArray_proof['tmp_name'], $upload_folder . DS . $file_name_proof)) {                                //$this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                                $this->User->updateAll(array('User.identity_proof_img' => "'" . $file_name_proof . "'"), array('User.id' => $this->{$this->modelClass}->id));                            } else {                                $is_file_uploaded_proof = 0;                            }                        }                        if (isset($uploadimageArray_proof_passport) && $uploadimageArray_proof_passport['name'] != "") {                            $file_name_proof = $this->{$this->modelClass}->id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof_passport['name']));                            if (move_uploaded_file($uploadimageArray_proof_passport['tmp_name'], $upload_folder . DS . $file_name_proof)) {                                // $this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                                $this->User->updateAll(array('User.passport_proof_img' => "'" . $file_name_proof . "'"), array('User.id' => $this->{$this->modelClass}->id));                            } else {                                $is_file_uploaded_proof = 0;                            }                        }                        if (isset($uploadimageArray_proof_aadhar) && $uploadimageArray_proof_aadhar['name'] != "") {                            $file_name_proof = $this->{$this->modelClass}->id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof_aadhar['name']));                            if (move_uploaded_file($uploadimageArray_proof_aadhar['tmp_name'], $upload_folder . DS . $file_name_proof)) {                                //$this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                                $this->User->updateAll(array('User.aadhar_proof_img' => "'" . $file_name_proof . "'"), array('User.id' => $this->{$this->modelClass}->id));                            } else {                                $is_file_uploaded_proof = 0;                            }                        }						//$uploadimageArray_proof_license                        if (isset($uploadimageArray_proof_license) && $uploadimageArray_proof_license['name'] != "") {                            $file_name_proof = $this->{$this->modelClass}->id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof_license['name']));                            if (move_uploaded_file($uploadimageArray_proof_license['tmp_name'], $upload_folder . DS . $file_name_proof)) {                                // $this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                                $this->User->updateAll(array('User.license_proof_img' => "'" . $file_name_proof . "'"), array('User.id' => $this->{$this->modelClass}->id));                            } else {                                $is_file_uploaded_proof = 0;                            }                        }                        if (isset($this->data['OperationCity']["state_id"][0]) && !empty($this->data['OperationCity']["state_id"][0])) {                            $operationcity = array();                            $oc = 0;                            foreach ($this->data['OperationCity']["state_id"] as $key => $value) {                                $this->OperationCity->create();                                $operationcity["OperationCity"]['user_id'] = $c_id;                                $operationcity["OperationCity"]['company_id'] = $company_id;                                $operationcity["OperationCity"]["state_id"] = $this->data['OperationCity']['state_id'][$oc];                                $operationcity["OperationCity"]["city_id"] = $this->data['OperationCity']['city_id'][$oc];                                $operationcity["OperationCity"]["garage_address"] = @$this->data['OperationCity']['garage_address'][$oc];                                $operationcity["OperationCity"]["lat"] = @$this->data['OperationCity']['lat'][$oc];                                $operationcity["OperationCity"]["lng"] = @$this->data['OperationCity']['lng'][$oc];                                $operationcity["OperationCity"]["status"] = 1;                                // Save All Data                                $this->OperationCity->saveAll($operationcity);                                $oc++;                            }                        }                        if (isset($this->data['OperationArea']["zones"])) {                            $this->loadModel("OperationArea");                            $this->OperationArea->create();                            $OperationArea["OperationArea"]['user_id'] = $c_id;                            //$OperationArea["OperationArea"]["zone_ids"] = $this->data['OperationArea']['zone_ids'];                            $OperationArea["OperationArea"]["zone_ids"] = @$this->data['OperationArea']['zones'];                            $OperationArea["OperationArea"]["city_ids"] = @$this->data['OperationArea']['cities'];                            $this->OperationArea->saveAll($OperationArea);                            $this->show_to_all($c_id);                        }                        $this->loadModel('CompanyInformation');                        if (isset($this->data["CompanyInformation"]['image']) && !empty($this->data["CompanyInformation"]['image'])) {                            $images = array();                            $i = 0;                            $c_id = $this->{$this->modelClass}->id;                            foreach ($this->data["CompanyInformation"]['image'] as $key => $value) {                                if (!empty($value["tmp_name"])) {                                    $filename = time() . str_replace(" ", "_", $value['name']);                                    $filename = time() . str_replace("/", "_", $filename);                                    move_uploaded_file($this->data['CompanyInformation']['image'][$i]['tmp_name'], USER_DOC_STORE_PATH . $filename);                                    $images["CompanyInformation"]['user_id'] = $c_id;                                    $images["CompanyInformation"]['company_id'] = $this->Company->getLastInsertID();                                    $images["CompanyInformation"]["image"] = $filename;                                    $this->CompanyInformation->saveAll($images);                                }                                $i++;                            }                        }//email//                        $email = $email_user;                        $this->VendorSingupMail($email, $pass, $vendor_name, $vendor_phone, $unique_id_vendor);                        //end mail//                        $this->Session->setFlash(__('Vendor partner has been added'), 'success');                        $this->redirect(array('action' => 'Individual'));                    } else {                        $this->data = $this->request->data;                        $this->loadModel('Country');                        $country = $this->Country->find('list', array('order' => 'created desc'));                        $this->loadModel('State');                        $state = $this->State->find("list", array("conditions" => array("country_id" => 1)), array("order" => "created desc"));                        $this->loadModel('City');                        $city = $this->City->find("list", array("conditions" => array("state_id" => $this->request->data['Company']['state_id'])), array("order" => "created desc"));                    }                } else {                    $this->data = $this->request->data;                    $this->loadModel('Country');                    $country = $this->Country->find('list', array('order' => 'created desc'));                    $this->loadModel('State');                    $state = $this->State->find("list", array("conditions" => array("country_id" => 1)), array("order" => "created desc"));                    $this->loadModel('City');                    $city = $this->City->find("list", array("conditions" => array("state_id" => $this->request->data['Company']['state_id'])), array("order" => "created desc"));                    //$this->Session->setFlash(__('Corporate business has not been added.'), 'error');                }            }        } else {            $this->loadModel('State');            $state = $this->State->find("list", array("conditions" => array("country_id" => '1')), array("order" => "created desc"));        }        $this->set('country', $country);        $this->set('state', $state);        $this->set('city', $city);        $this->loadModel("Company");        $company = $this->Company->find("list", array("conditions" => array("status" => 1, "assign" => 0)));        $this->set("company", $company);//		  $this->loadModel("MotorType");//        $motortype = $this->MotorType->find("list", array("conditions" => array("status" => 1)));//        $this->set("motortype", $motortype);//        $this->loadModel("Airport");//        $airports = $this->Airport->find("list", array("conditions" => array("status" => 'A')));//        $this->set("airports", $airports);//        $this->loadModel("Timemgmt");//        $timemgmt = $this->Timemgmt->find("list", array("conditions" => array("status" => 1)));//        $this->set("timemgmt", $timemgmt);        $this->set('title_for_layout', 'Add New Vendor');    }    public function VendorSingupMail($email = '', $pass = '', $vendor_name = '', $vendor_phone = '', $unique_id_vendor = '') {        /* $email = "deepakgaur9889@gmail.com";         $pass = 123456;        $vendor_name = "deepak";        $vendor_phone = "90001209889";        $unique_id_vendor="dddddd";  */ 		$email2   = "upenparida0@gmail.com";		        $arr_var  = array();        $arr_var['User']['email'] = $email;        $arr_var['User']['vendor_name'] = $vendor_name;        $arr_var['User']['pass'] = $pass;        $arr_var['User']['vendor_phone'] = $vendor_phone;        $arr_var['User']['unique_id_vendor'] = $unique_id_vendor;        $Email = new CakeEmail();        $Email->from(Configure::read("Site.email"))                ->to($email)				->cc($email2)                ->subject('Welcome to ' . Configure::read('Site.title') . '!')                ->template("register")                ->emailFormat("html")                ->viewVars(array('arr_var' => $arr_var))                ->send();        return true;    }    function update_pass() {        $email = "ankkit.raghav@supercabz.com";        //$email = "rajesh.kumar@supercabz.com";        $pass = 123456;        $vendor_name = "Test";        $vendor_phone = "90001209889";        $unique_id_vendor = "VPDH0034";        $arr_var = array();        $arr_var['User']['email'] = $email;        $arr_var['User']['vendor_name'] = $vendor_name;        $arr_var['User']['pass'] = $pass;        $arr_var['User']['vendor_phone'] = $vendor_phone;        $arr_var['User']['unique_id_vendor'] = $unique_id_vendor;        $Email = new CakeEmail();        $Email->from(Configure::read("Site.email"))                ->to($email)                ->subject('Welcome to ' . Configure::read('Site.title') . '!')                ->template("register")                ->emailFormat("html")                ->viewVars(array('arr_var' => $arr_var))                ->send();        exit;        $this->loadModel('User');        $check_duplicate = $this->User->find('all', array(            'conditions' => array(                'User.user_role_id' => 4            ),            'fields' => array('mobile', 'id'),            'recursive' => -1        ));//pr($check_duplicate);//exit;        foreach ($check_duplicate as $datas) {            $this->User->create();            $pass = $datas['User']['mobile'];            $password = AuthComponent::password($pass);            $this->User->updateAll(array('User.password' => "'$password'"), array('User.id' => $datas['User']['id']));        }        exit;    }    function insert_driver_log($driver_id, $description = '', $status = '', $user_type = '', $user_id = '', $user_name = '', $all_data = '') {        if ($driver_id) {            $this->loadModel("DriverLog");            $ArrIns = array();            $ArrIns['DriverLog']['driver_id'] = $driver_id;            $ArrIns['DriverLog']['description'] = $description;            $ArrIns['DriverLog']['status'] = $status;            $ArrIns['DriverLog']['user_type'] = $user_type;            $ArrIns['DriverLog']['user_id'] = $user_id;            $ArrIns['DriverLog']['user_name'] = $user_name;            $ArrIns['DriverLog']['created'] = date("Y-m-d H:i:s");            $ArrIns['DriverLog']['all_data'] = $all_data ? json_encode($all_data) : "";            $this->DriverLog->save($ArrIns);        }        return true;    }    function add_driver() {        $this->set('tab_open', 'partners');        $is_success = 1;        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Driver', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'driver');        $breadcrumb = array('pages' => $pages, 'active' => __('Add Driver', true));        $this->set('breadcrumb', $breadcrumb);        if (!empty($this->data)) {            //pr($this->data); exit;            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $this->request->data['Usermgmt']['mobile'],                    'User.user_role_id' => 4                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                $this->Session->setFlash(__('This mobile number already exist.'), 'error');                $this->redirect(array('plugin' => false, 'controller' => 'driver', 'action' => 'add'));            }            //pr($this->request->data);die;            $image = '';            $data_chk['firstname'] = $this->data{$this->modelClass}['firstname'];            $data_chk['lastname'] = $this->data{$this->modelClass}['lastname'];            $data_chk['mobile'] = $this->data{$this->modelClass}['mobile'];            //$data_chk['license_no'] = $this->data{$this->modelClass}['license_no'];            $this->{$this->modelClass}->set($data_chk);            //pr($this->Usermgmt->addDriver());exit;            if ($this->Usermgmt->addDriver()) {                unset($this->request->data{$this->modelClass}['image']);                $upload_image_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'photos';                $upload_address_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'address';                $upload_currentaddress_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'currentaddress';                $upload_criminal_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'criminal';                $upload_reference_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'reference';                $upload_dl_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'dl';                $upload_adhaar_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'adhaar';                $upload_voter_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'voter';                $rationcard_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'rationcard';                $data = array();                $upload_folder = USERDOCS;                $data['user_role_id'] = 4;                $phone_no = $this->data{$this->modelClass}['mobile'];                $pass = $phone_no;                $data['password'] = AuthComponent::password($pass);                $this->loadModel('Company');                $cdata = $this->Company->findById($this->data['Usermgmt']['company_id']);                $udata = $this->{$this->modelClass}->findById($cdata['Company']['user_id']);                if ($udata['Usermgmt']['user_role_id'] == 5) {                    $data['type'] = 1;                }                $data['firstname'] = $this->data{$this->modelClass}['firstname'];                $data['vendor_id'] = $cdata['Company']['user_id'];                $data['dob'] = $this->data{$this->modelClass}['dob'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['dob'])) : "";                $data['license_to'] = $this->data{$this->modelClass}['license_to'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['license_to'])) : "";                $data['batch_start_date'] = $this->data{$this->modelClass}['batch_start_date'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['batch_start_date'])) : "";                $data['batch_end_date'] = $this->data{$this->modelClass}['batch_end_date'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['batch_end_date'])) : "";                $data['license_from'] = $this->data{$this->modelClass}['license_from'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['license_from'])) : "";                $data['license_to'] = $this->data{$this->modelClass}['license_to'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['license_to'])) : "";                $data['lastname'] 			= $this->data{$this->modelClass}['lastname'];				$data['alternate_mobile']   = @$this->data{$this->modelClass}['alternate_mobile'];                 if ($this->Auth->user('user_role_id') == 6) {                    $this->request->data['Usermgmt']['verified'] = 2;                    $this->request->data['Usermgmt']['status'] = 2;				} else {                    $this->request->data['Usermgmt']['verified'] = 2;                    $this->request->data['Usermgmt']['status'] = 2;                }                $data['verified'] = $this->request->data['Usermgmt']['verified'];                $data['status'] = $this->request->data['Usermgmt']['status'];                             $unid = time();                $data['uniqid'] = $unid;                $this->loadModel('User');                $count_vendor = $this->User->find('count', array(                    'conditions' => array(                        'User.user_role_id' => 4                    ),                ));                //end                //pr($data); die;                $this->{$this->modelClass}->set($this->request->data);                if ($is_success == 1) {                    if ($this->{$this->modelClass}->save($data, false)) {                        $newly_added_driver_id = $this->{$this->modelClass}->id;                        $last_add_driver_id = str_pad($count_vendor + 1, 4, "0", STR_PAD_LEFT);                        $citycode = "";                        $update_driver_data[$this->modelClass]['uniqid'] = 'DR' . $citycode . $last_add_driver_id;                        $update_driver_data[$this->modelClass]['id'] = $newly_added_driver_id;                        $this->{$this->modelClass}->save($update_driver_data, false);                        //insert into logs and alerts//                        if ($this->Auth->user('user_role_id') == 1) {                            $user_type = 0;                        } else {                            $user_type = 1;                        }                        $description = "Driver Added";                        $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                        $all_data = $this->request->data;                        $this->insert_driver_log($newly_added_driver_id, $description, 0, $user_type, $this->Auth->user('id'), $user_name, $all_data);                        if ($this->Auth->user('user_role_id') == 6) {                            if ($this->Auth->user('driver_verification') != 1) {                                $this->insert_alerts("usermgmt", "index", 'partners', 'New Driver Added', 'driver_verification');                            }                        }                        //ends//                        //// sending message to driver for login info                         //// sending message to driver for login info                         $name_driver = $this->data{$this->modelClass}['firstname'];                        $msg = "Hello " . $name_driver . ", Welcome to Super Cabz! Click on http://www.supercabz.com/app_download/SuperCabz.apk to download Super Cabz mobile app. Login with your username " . $update_driver_data[$this->modelClass]['uniqid'] . " and password " . $phone_no;                        //$msg = "Welcome to Supercabz your Login ID " . $update_driver_data[$this->modelClass]['uniqid'] . " and password " . $phone_no;                        $phone_no = '+91' . $phone_no;                        $res = $this->send_message($phone_no, $msg, 1);                        $this->loadModel('UserDocument');                        if (isset($this->data['UserDocument']['image']) && !empty($this->data['UserDocument']['image'])) {                            $value = $this->data["UserDocument"]['image'];                            foreach ($value as $value) {                                //	pr($value); exit;                                $i = 1;                                $this->UserDocument->create();                                if (!empty($value["tmp_name"])) {                                    $filename = time() . $i . 'userimag' . str_replace(" ", "_", $value['name']);                                    $filename = time() . $i . 'userimag' . str_replace("/", "_", $filename);                                    move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                    $UserDocument["UserDocument"]["document_image"] = $filename;                                    $UserDocument["UserDocument"]["user_id"] = $newly_added_driver_id;                                    $UserDocument["UserDocument"]["type"] = 8;                                    $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                    $this->UserDocument->saveAll($UserDocument);                                }                                $i++;                            }                        }                        //	pr( $this->data["Usermgmt"]['license_proof_img']); exit;                        if (isset($this->data['UserDocument']['license_proof_img']) && !empty($this->data['UserDocument']['license_proof_img'])) {                            $value = $this->data["UserDocument"]['license_proof_img'];                            foreach ($value as $value) {                                //pr($value); exit;                                $i = 1;                                $this->UserDocument->create();                                if (!empty($value["tmp_name"])) {                                    $filename = time() . $i . 'lpi' . str_replace(" ", "_", $value['name']);                                    $filename = time() . $i . 'lpi' . str_replace("/", "_", $filename);                                    move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                    $UserDocument["UserDocument"]["document_image"] = $filename;                                    $UserDocument["UserDocument"]["user_id"] = $newly_added_driver_id;                                    $UserDocument["UserDocument"]["type"] = 1;                                    $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                    $this->UserDocument->saveAll($UserDocument);                                }                                $i++;                            }                        }                        if (isset($this->data['UserDocument']['pancard_img']) && !empty($this->data['UserDocument']['pancard_img'])) {                            $value = $this->data["UserDocument"]['pancard_img'];                            foreach ($value as $value) {                                //pr($value); exit;                                $i = 1;                                $this->UserDocument->create();                                if (!empty($value["tmp_name"])) {                                    $filename = time() . $i . 'pi' . str_replace(" ", "_", $value['name']);                                    $filename = time() . $i . 'pi' . str_replace("/", "_", $filename);                                    move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                    $UserDocument["UserDocument"]["document_image"] = $filename;                                    $UserDocument["UserDocument"]["user_id"] = $newly_added_driver_id;                                    $UserDocument["UserDocument"]["type"] = 7;                                    $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                    $this->UserDocument->saveAll($UserDocument);                                }                                $i++;                            }                        }                        if (isset($this->data['UserDocument']['aadhar_proof_img']) && !empty($this->data['UserDocument']['aadhar_proof_img'])) {                            $value = $this->data["UserDocument"]['aadhar_proof_img'];                            foreach ($value as $value) {                                //pr($value); exit;                                $i = 1;                                $this->UserDocument->create();                                if (!empty($value["tmp_name"])) {                                    $filename = time() . $i . 'api' . str_replace(" ", "_", $value['name']);                                    $filename = time() . $i . 'api' . str_replace("/", "_", $filename);                                    move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                    $UserDocument["UserDocument"]["document_image"] = $filename;                                    $UserDocument["UserDocument"]["user_id"] = $newly_added_driver_id;                                    $UserDocument["UserDocument"]["type"] = 2;                                    $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                    $this->UserDocument->saveAll($UserDocument);                                }                                $i++;                            }                        }                        $this->Session->setFlash(__('Driver has been added'), 'success');                        $this->redirect(array('action' => 'driver'));                    }                } else {                    //$this->Session->setFlash(__('Driver has not been added.'), 'error');                }            }        }        //$this->loadModel("Country");        //$this->loadModel("User");        //$this->loadModel("State");        //$country = $this->Country->find("list", array("conditions" => array("status" => "A")));        //$company = $this->Company->find("list", array("conditions" => array("status" => 1)));        $companyarray = array();        $companyarray = Cache::read('companyarrayusmagmt');        //if ($companyarray == "") {        $this->loadModel("Company");        $company = $this->Company->find('all', array(            'conditions' => array(                "Company.status" => 1            ),            'joins' => array(                array(                    'table' => 'users',                    'alias' => 'User',                    'type' => 'LEFT',                    'conditions' => array(                        'Company.user_id = User.id'                    )                )),            'fields' => array(                'Company.id', 'User.uniqid', 'Company.name',            )        ));        if (!empty($company)) {            foreach ($company as $key => $vl) {                $companyarray[$vl['Company']['id']] = $vl['Company']['name'] . ' ( ' . $vl['User']['uniqid'] . ' ) ';            }        }        Cache::write('companyarrayusmagmt', $companyarray);        // }        $this->set("company", $companyarray);//        $vlarray = array();//        $vlarray = Cache::read('vlarrayUser');//        if ($vlarray == "") {//            $vendors_list = $this->User->find('all', array(//                'conditions' => array(//                    'User.user_role_id' => 2//                ),//                'fields' => array(//                    'User.id', 'User.uniqid', 'User.email', 'User.firstname', 'User.lastname'//                )//            ));//////            if (!empty($vendors_list)) {//                foreach ($vendors_list as $key => $vl) {//                    $vlarray[$vl['User']['id']] = $vl['User']['firstname'] . ' ' . $vl['User']['lastname'] . ' ( ' . $vl['User']['uniqid'] . ' ) ';//                }//            }//            Cache::write('vlarrayUser', $vlarray);//        }//        //$this->set("country", $country);//        //$this->set("vendors_list", $vendors_list);//        $this->set("vendors_list", $vlarray);        $state = Cache::read('UserStateDr');        if ($state == "") {            $this->loadModel("UserState");            $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));            Cache::write('UserStateDr', $state);        }        $this->set("state", $state);        $this->set('title_for_layout', 'Add New Driver');    }    function add_company() {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('company', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'company');        $breadcrumb = array('pages' => $pages, 'active' => __('Add company', true));        $this->set('breadcrumb', $breadcrumb);        if (!empty($this->data)) {            $image = '';            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->validates()) {                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = '';                    }                } else {                    $image = '';                }                $data = array();                $data['user_role_id'] = 2;                $data['firstname'] = $this->data{$this->modelClass}['firstname'];                $data['lastname'] = $this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['username'];                $data['email'] = $this->data{$this->modelClass}['email'];                $data['password'] = AuthComponent::password($this->data{$this->modelClass}['password']);                $data['status'] = $this->data{$this->modelClass}['status'];                $data['active'] = 1;                $data['image'] = $image;//pr($data); die;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('company has been added'), 'success');                    $this->redirect(array('action' => 'company'));                } else {                    $this->Session->setFlash(__('company has not been added.'), 'error');                }            }        }        $this->loadModel("Country");        $this->loadModel("User");        $country = $this->Country->find("list", array("conditions" => array("status" => 1)));        $company = $this->User->find("list", array("conditions" => array("status" => 1, "user_role_id" => 2)));        $this->set("country", $country);        $this->set("company", $company);    }    function edit($user_id = 0, $id = null) {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Employee', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'index');        $breadcrumb = array('pages' => $pages, 'active' => __('Edit Employee', true));        $this->set('breadcrumb', $breadcrumb);        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $users = $this->{$this->modelClass}->find('list', array('fields' => array('username'))); // to get list for dropdowns        $this->set("users", $users);        $this->set("result", $parentdata);        if (!empty($this->data)) {            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->EditValidate()) {                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = $parentdata{$this->modelClass}['image'];                    }                } else {                    $image = $parentdata{$this->modelClass}['image'];                }                $data['firstname'] = $this->data{$this->modelClass}['firstname'];                $data['lastname'] = $this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['username'];                $data['email'] = $this->data{$this->modelClass}['email'];                $data['status'] = $this->data{$this->modelClass}['status'];                $data['image'] = $image;                $this->{$this->modelClass}->id = $user_id;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('Employee has been edited'), 'success');                } else {                    $this->Session->setFlash(__('Error saving Employee.'), 'error');                }                $this->redirect(array('action' => 'index'));            }        } else {            if ($user_id == null)                die(__("No ID received"));            $data = $this->{$this->modelClass}->read(null, $user_id);            unset($data['Usermgmt']['password']);            $this->data = $data;//pr($this->data);        }    }    function edit_customer($user_id = 0, $id = null) {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Passenger', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'customer');        $breadcrumb = array('pages' => $pages, 'active' => __('Edit Passenger', true));        $this->set('breadcrumb', $breadcrumb);        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $users = $this->{$this->modelClass}->find('list', array('fields' => array('username'))); // to get list for dropdowns        $this->set("users", $users);        $this->set("result", $parentdata);        $this->loadModel('Country');        $country = $this->Country->find('list', array('order' => 'created desc'));        $this->set('country', $country);        if (!empty($this->data)) {            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->EditValidate()) {//pr($this->data); die;                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = $parentdata{$this->modelClass}['image'];                    }                } else {                    $image = $parentdata{$this->modelClass}['image'];                }                $data = array();                $data['firstname'] = $this->data{$this->modelClass}['firstname'];//$data['lastname']		=	$this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['firstname'];                $data['email'] = $this->data{$this->modelClass}['email'];//$data['password']		=	AuthComponent::password($this->data{$this->modelClass}['password']);                $data['status'] = $this->data{$this->modelClass}['status'];                $data['active'] = 1;                $data['image'] = $image;                $this->{$this->modelClass}->id = $user_id;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('Passenger has been updated'), 'success');                } else {                    $this->Session->setFlash(__('Error updating Passenger.'), 'error');                }                $this->redirect(array('action' => 'customer'));            }        } else {            if ($user_id == null)                die(__("No ID received"));            $data = $this->{$this->modelClass}->read(null, $user_id);            unset($data['Usermgmt']['password']);            $this->data = $data;//pr($this->data);        }    }    function edit_employee($user_id = 0, $id = null) {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Passenger', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'employee');        $breadcrumb = array('pages' => $pages, 'active' => __('Edit employee', true));        $this->set('breadcrumb', $breadcrumb);        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $users = $this->{$this->modelClass}->find('list', array('fields' => array('username'))); // to get list for dropdowns        $this->set("users", $users);        $this->set("result", $parentdata);        $this->loadModel('Country');        $country = $this->Country->find('list', array('order' => 'created desc'));        $this->set('country', $country);        if (!empty($this->data)) {            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->EditValidate()) {                unset($this->request->data['User']['emp_id']);                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = $parentdata{$this->modelClass}['image'];                    }                } else {                    $image = $parentdata{$this->modelClass}['image'];                }                $data = array();                $data['firstname'] = $this->data{$this->modelClass}['firstname'];//$data['lastname']		=	$this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['firstname'];                $data['email'] = $this->data{$this->modelClass}['email'];//$data['password']		=	AuthComponent::password($this->data{$this->modelClass}['password']);                $data['status'] = $this->data{$this->modelClass}['status'];                $data['active'] = 1;                $data['image'] = $image;                $this->{$this->modelClass}->id = $user_id;//pr($data);die;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('employee has been updated'), 'success');                } else {                    $this->Session->setFlash(__('Error updating employee.'), 'error');                }                $this->redirect(array('action' => 'employee'));            }        } else {            if ($user_id == null)                die(__("No ID received"));            $data = $this->{$this->modelClass}->read(null, $user_id);            unset($data['Usermgmt']['password']);            $this->data = $data;//pr($this->data);        }    }    function edit_individual($user_id = 0, $id = null) {        //Configure::write('debug', 2);        $this->set('tab_open', 'partners');        $this->{$this->modelClass}->hasOne = array("Company" => array("className" => "Company", "foreignKey" => "user_id"));        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $pages[__('Customer', true)] = array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'individual');        $breadcrumb = array('pages' => $pages, 'active' => __('Edit Individual', true));        $this->set('breadcrumb', $breadcrumb);        $this->{$this->modelClass}->unbindModel(array('belongsTo' => array('Company')), false);        $this->{$this->modelClass}->bindModel(array('hasOne' => array('OperationArea' => array(                    'className' => 'OperationArea',                    'foreignKey' => 'user_id',        ))));        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $users = $this->{$this->modelClass}->find('list', array('fields' => array('username'))); // to get list for dropdowns        $this->set("users", $users);        $parentdata['OperationArea']['city_ids'] = @$parentdata['OperationArea']['city_ids'];        $parentdata['OperationArea']['zones'] = @$parentdata['OperationArea']['zone_ids'];        $parentdata['OperationArea']['to_cities_id'] = @$parentdata['OperationArea']['city_ids'] ? explode(",", @$parentdata['OperationArea']['city_ids']) : "";        $parentdata['OperationArea']['to_zone_ids'] = @$parentdata['OperationArea']['zone_ids'] ? explode(",", @$parentdata['OperationArea']['zone_ids']) : "";        //pr($parentdata);        $this->loadModel("City");        $city_list = $this->City->find("list", array('conditions' => array('City.status' => 'A'), 'order' => array('City.name' => 'Asc')));        $this->set("cities_list", $city_list);        $this->set("default_cities_list", $parentdata['OperationArea']['to_cities_id']);        $this->set("default_zone_ids", $parentdata['OperationArea']['to_zone_ids']);        //pr( $city_list); exit;        $this->set("result", $parentdata);        //pr($parentdata);         if (!empty($result['OperationCity'])) {            $lat = $result['OperationCity'][0]['lat'];            $lng = $result['OperationCity'][0]['lng'];        } else {            $lat = '26.826651';            $lng = '75.999';        }        $this->set("lat", $lat);        $this->set("lng", $lng);        $d = $this->{$this->modelClass}->findById($user_id);        $this->loadModel('OperationCity');        $oData = $this->OperationCity->find('all', array('conditions' => array('user_id' => $d['Usermgmt']['id'])));        $this->set('oData', $oData);        $this->loadModel("Zone");        $zone_list = $this->Zone->find("list", array(            'conditions' => array(                "Zone.status" => 1,                "Zone.zone_type" => 1        )));        $this->set("zones", $zone_list);        $this->loadModel("City");        $city_list = $this->City->find("list", array('conditions' => array('City.status' => 'A'), 'order' => array('City.name' => 'Asc')));        $this->set("city_list", $city_list);        if (!empty($this->data)) {            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $this->request->data['Usermgmt']['mobile'],                    'User.user_role_id' => 2,                    'User.id !=' => $user_id                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                $this->Session->setFlash(__('This mobile number already exist.'), 'error');                $this->redirect(array('plugin' => "usermgmt", 'controller' => 'usermgmt', 'action' => 'edit_individual', $user_id));            }            $this->request->data{$this->modelClass}['id'] = $user_id;            $data_chk[$this->modelClass]['firstname'] = $this->data{$this->modelClass}['firstname'];            $data_chk[$this->modelClass]['lastname'] = $this->data{$this->modelClass}['lastname'];            $data_chk[$this->modelClass]['mobile'] = $this->data{$this->modelClass}['mobile'];            $this->{$this->modelClass}->set($data_chk);            if ($this->Usermgmt->EditValidate()) {                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = $parentdata{$this->modelClass}['image'];                    }                } else {                    $image = $parentdata{$this->modelClass}['image'];                }                $filename_identity_proof = $this->data{$this->modelClass}['identity_proof_img']['name'];                if ($filename_identity_proof != '') {                    $tempPath_proof = $this->data{$this->modelClass}['identity_proof_img']['tmp_name'];                    $new_file_name_proof = time() . '_' . $filename_identity_proof;                    if (move_uploaded_file($tempPath_proof, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name_proof)) {                        $image_proof = $new_file_name_proof;                    } else {                        $image_proof = $parentdata{$this->modelClass}['identity_proof_img'];                    }                } else {                    $image_proof = $parentdata{$this->modelClass}['identity_proof_img'];                }                $filename_identity_proof = $this->data{$this->modelClass}['passport_proof_img']['name'];                if ($filename_identity_proof != '') {                    $tempPath_proof = $this->data{$this->modelClass}['passport_proof_img']['tmp_name'];                    $new_file_name_proof = time() . '_' . $filename_identity_proof;                    if (move_uploaded_file($tempPath_proof, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name_proof)) {                        $image_proof_passport = $new_file_name_proof;                    } else {                        $image_proof_passport = $parentdata{$this->modelClass}['passport_proof_img'];                    }                } else {                    $image_proof_passport = $parentdata{$this->modelClass}['passport_proof_img'];                }                $filename_identity_proof = $this->data{$this->modelClass}['aadhar_proof_img']['name'];                if ($filename_identity_proof != '') {                    $tempPath_proof = $this->data{$this->modelClass}['aadhar_proof_img']['tmp_name'];                    $new_file_name_proof = time() . '_' . $filename_identity_proof;                    if (move_uploaded_file($tempPath_proof, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name_proof)) {                        $image_proof_aadhar = $new_file_name_proof;                    } else {                        $image_proof_aadhar = $parentdata{$this->modelClass}['aadhar_proof_img'];                    }                } else {                    $image_proof_aadhar = $parentdata{$this->modelClass}['aadhar_proof_img'];                }                $filename_identity_proof = $this->data{$this->modelClass}['license_proof_img']['name'];                if ($filename_identity_proof != '') {                    $tempPath_proof = $this->data{$this->modelClass}['license_proof_img']['tmp_name'];                    $new_file_name_proof = time() . '_' . $filename_identity_proof;                    if (move_uploaded_file($tempPath_proof, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name_proof)) {                        $image_proof_license = $new_file_name_proof;                    } else {                        $image_proof_license = $parentdata{$this->modelClass}['license_proof_img'];                    }                } else {                    $image_proof_license = $parentdata{$this->modelClass}['license_proof_img'];                }                $data = array();                $this->loadModel('CompanyInformation');                if (isset($this->data["CompanyInformation"]['image']) && !empty($this->data["CompanyInformation"]['image'])) {                    $images = array();                    $i = 0;                    foreach ($this->data["CompanyInformation"]['image'] as $key => $value) {                        if (!empty($value["tmp_name"])) {                            $filename = time() . str_replace(" ", "_", $value['name']);                            $filename = time() . str_replace("/", "_", $filename);                            //pr($value['tmp_name']);exit();                            //pr($this->data["CompanyInformation"]['image']);exit();                            $fileData = fread(fopen($this->params['form']['File']['tmp_name'], "r"), $this->params['form']['File']['size']);                            //pr(TAXI_IMAGE_STORE_PATH);exit();                            //pr(base64_decode($value['name']));exit();                            move_uploaded_file($this->data['CompanyInformation']['image'][$i]['tmp_name'], USER_DOC_STORE_PATH . $filename);                            $images["CompanyInformation"]["user_id"] = $user_id;                            $images["CompanyInformation"]["company_id"] = $parentdata['Company']['id'];                            $images["CompanyInformation"]["image"] = $filename;                            $this->CompanyInformation->saveAll($images);                        }                        $i++;                    }                }                $this->loadModel("Company");                $this->request->data["Company"]["user_id"] = $user_id;                $this->request->data["Company"]["sfrom"] = '';                $this->request->data["Company"]["sto"] = '';                $this->Company->id = $d["Company"]["id"];                $this->Company->save($this->data["Company"], false);                $data['firstname']  = $this->data{$this->modelClass}['firstname'];                $data['username']   = $this->data{$this->modelClass}['firstname'];                $data['email']      = $this->data{$this->modelClass}['email'];                $data['status']     = $this->data{$this->modelClass}['status'];				$data['alternate_mobile']   = @$this->data{$this->modelClass}['alternate_mobile'];                $data['active'] = 1;                $data['image'] = $image;                $data['identity_proof_img'] = $image_proof;                $data['passport_proof_img'] = $image_proof_passport;                $data['aadhar_proof_img'] = $image_proof_aadhar;                $data['license_proof_img'] = $image_proof_license;                $u_id = $this->{$this->modelClass}->id;                $this->{$this->modelClass}->id = $u_id;                $this->loadModel("OperationCity");                if (isset($this->data['OperationCity']["state_id"][0]) && !empty($this->data['OperationCity']["state_id"][0])) {                    $operationcity = array();                    $noperationcity = array();                    $this->OperationCity->deleteAll(array('OperationCity.user_id ' => $u_id));                    $oc = 0;                    foreach ($this->data['OperationCity']["state_id"] as $key => $value) {                        $operationcity["user_id"] = $u_id;                        $operationcity["company_id"] = $d["Company"]["id"];                        $operationcity["state_id"] = $this->data['OperationCity']['state_id'][$oc];                        if (isset($this->data['OperationCity']['state_id'][$oc])) {                            $operationcity["state_id"] = $this->data['OperationCity']['state_id'][$oc];                        }                        if (isset($this->data['OperationCity']['city_id'][$oc])) {                            $operationcity["city_id"] = $this->data['OperationCity']['city_id'][$oc];                        }                        if (isset($this->data['OperationCity']['garage_address'][$oc])) {                            $operationcity["garage_address"] = $this->data['OperationCity']['garage_address'][$oc];                        }                        if (isset($this->data['OperationCity']['lat'][$oc])) {                            $operationcity["lat"] = $this->data['OperationCity']['lat'][$oc];                        }                        if (isset($this->data['OperationCity']['lng'][$oc])) {                            $operationcity["lng"] = $this->data['OperationCity']['lng'][$oc];                        }                        if (@$this->data["OperationCity"]["id"][$oc] != '') {                            $this->OperationCity->id = $this->data["OperationCity"]["id"][$oc];                            $this->OperationCity->save($operationcity, false);                        } else {                            $operationcity["OperationCity"]['user_id'] = $u_id;                            $operationcity["OperationCity"]['company_id'] = $d["Company"]["id"];                            $operationcity["OperationCity"]["state_id"] = $this->data['OperationCity']['state_id'][$oc];                            $operationcity["OperationCity"]["city_id"] = $this->data['OperationCity']['city_id'][$oc];                            $operationcity["OperationCity"]["garage_address"] = @$this->data['OperationCity']['garage_address'][$oc];                            $operationcity["OperationCity"]["lat"] = @$this->data['OperationCity']['lat'][$oc];                            $operationcity["OperationCity"]["lng"] = @$this->data['OperationCity']['lng'][$oc];                            $operationcity["OperationCity"]["created"] = date('Y-m-d h:i:s');                            $operationcity["OperationCity"]["modified"] = date('Y-m-d h:i:s');                            $operationcity["OperationCity"]["status"] = 1;                            $this->OperationCity->saveAll($operationcity);                        }                        $oc++;                    }                }                $this->loadModel("City");                $citycodeData = $this->City->findById($this->data['Company']['city_id']);                $citycode = $citycodeData['City']['city_code'];                $data['city_id'] = $this->data['Company']['city_id'];                $data['state_id'] = $this->data['Company']['state_id'];                $data['pen_card'] = $this->data['Usermgmt']['pen_card'];                $data['mgf_vendor'] = isset($this->data['Usermgmt']['mgf_vendor']) && $this->data['Usermgmt']['mgf_vendor'] ? $this->data['Usermgmt']['mgf_vendor'] : 0;                $data['address'] = $this->data['Usermgmt']['address'];                $data['residence_address'] = $this->data['Usermgmt']['residence_address'];                $data['allow_corporate_booking'] = isset($this->data['Usermgmt']['allow_corporate_booking']) && $this->data['Usermgmt']['allow_corporate_booking'] ? $this->data['Usermgmt']['allow_corporate_booking'] : 0;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->loadModel("OperationArea");                    $checkOperationArea = $this->OperationArea->find('list', array('conditions' => array('OperationArea.user_id' => $user_id))); // to get list for dropdowns                    if (empty($checkOperationArea)) {                        $this->loadModel("OperationArea");                        $this->OperationArea->create();                        if (isset($this->data['OperationArea']["id"]) && !empty($this->data['OperationArea']["id"])) {                            $OperationArea["OperationArea"]['id'] = $this->data['OperationArea']["id"];                        }                        $OperationArea["OperationArea"]['user_id'] = $user_id;                        $OperationArea["OperationArea"]["zone_ids"] = $this->data['OperationArea']['zones'];                        $OperationArea["OperationArea"]["city_ids"] = $this->data['OperationArea']['city_ids'];                        $this->OperationArea->saveAll($OperationArea);                    } else {                        if (isset($this->data['OperationArea']["zones"]) && !empty($this->data['OperationArea']["zones"])) {                            $this->OperationArea->updateAll(array('OperationArea.zone_ids' => "'" . $this->data['OperationArea']['zones'] . "'"), array('OperationArea.user_id' => $user_id));                        }                        if (isset($this->data['OperationArea']["city_ids"]) && !empty($this->data['OperationArea']["city_ids"])) {                            $this->OperationArea->updateAll(array('OperationArea.city_ids' => "'" . $this->data['OperationArea']['city_ids'] . "'"), array('OperationArea.user_id' => $user_id));                        }                    }                    $this->show_to_all($user_id);              //log                    $text_action = "updated";                    $json_data = json_encode($this->request->data);                    $this->global_logs("usermgmts", $u_id, 1, $text_action, $json_data);                    //$update_vp_data[$this->modelClass]['uniqid'] = 'VP' . $citycode . $u_id;                    $update_vp_data[$this->modelClass]['id'] = $u_id;                    $this->{$this->modelClass}->save($update_vp_data, false);                    $this->Session->setFlash(__('Vendor Partner has been updated'), 'success');                } else {                    $this->Session->setFlash(__('Error updating Individual.'), 'error');                }                $this->redirect(array('action' => 'individual'));            }        } else {            if ($user_id == null)                die(__("No ID received"));            $data = $this->{$this->modelClass}->read(null, $user_id);            unset($data['Usermgmt']['password']);            $this->loadModel('Country');            $country = $this->Country->find('list', array('order' => 'created desc'));            $this->set('country', $country);            $this->loadModel('State');            $state = $this->State->find('list', array('conditions' => array('State.country_id' => 1), array('order' => 'created desc')));            $this->set('state', $state);            $this->loadModel('City');            $city = $this->City->find('list', array(                'conditions' => array(                    'City.state_id' => $data['Usermgmt']['state_id']                ), array(                    'order' => 'created desc'                )            ));            $this->set('city', $city);            $data['Company']['vrerify_bank'] = $data['Company']['bank'];            $this->data = $data;        }        $this->loadModel("State");        $this->loadModel("City");        //pr($user);        $state = $this->State->find("list", array("conditions" => array("country_id" => 1)));        $city = $this->City->find("list", array("conditions" => array("state_id" => $d['Company']["state_id"])));        $this->set("state", $state);        $this->set("city", $city);        $this->set('title_for_layout', 'Edit Vendor Partner');    }    function edit_driver($user_id = 0, $id = null) {		Configure::write('debug', 2);		        $this->set('tab_open', 'partners');        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $is_success = 1;        $breadcrumb = array('pages' => $pages, 'active' => __('Edit Driver', true));        $this->set('breadcrumb', $breadcrumb);        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $user = $this->{$this->modelClass}->findById($user_id);        $this->set("result", $parentdata);        $this->loadModel("Company");        $this->loadModel("UserState");        $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));        $this->set("state", $state);        $this->loadModel("UserCity");        $city = $this->UserCity->find("list", array("fields" => array("city_id", "city_name")));        $this->set("city", $city);        if (!empty($this->data)) {            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $this->request->data['Usermgmt']['mobile'],                    'User.user_role_id' => 4,                    'User.id !=' => $user_id                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                $this->Session->setFlash(__('This mobile number already exist.'), 'error');                $this->redirect(array('plugin' => false, 'controller' => 'driver', 'action' => 'edit', $user_id));            }            // pr($this->data);exit();	            $data_chk[$this->modelClass]['firstname']	 = $this->data{$this->modelClass}['firstname'];            $data_chk[$this->modelClass]['lastname']	 = $this->data{$this->modelClass}['lastname'];            $data_chk[$this->modelClass]['mobile'] 		 = $this->data{$this->modelClass}['mobile'];			$data_chk['alternate_mobile']  				 = @$this->data{$this->modelClass}['alternate_mobile'];            //$data_chk['license_no'] = $this->data{$this->modelClass}['license_no'];            $this->{$this->modelClass}->set($data_chk);            if ($this->Usermgmt->EditDriverValidate()) {                $upload_image_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'photos';                $upload_address_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'address';                $upload_currentaddress_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'currentaddress';                $upload_criminal_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'criminal';                $upload_reference_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'reference';                $upload_dl_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'dl';                $upload_adhaar_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'adhaar';                $upload_voter_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'voter';                $upload_voter_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'voter';                $rationcard_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . 'uploads' . DS . 'drivers' . DS . 'rationcard';                $data = array();                $data['user_role_id'] = 4;                $this->loadModel('Company');                $cdata = $this->Company->findById($this->data['Usermgmt']['company_id']);                $udata = $this->{$this->modelClass}->findById($cdata['Company']['user_id']);                if ($udata['Usermgmt']['user_role_id'] == 5) {                    $data['type'] = 1;                }                $data['firstname'] 			= $this->data{$this->modelClass}['firstname'];                $data['lastname'] 			= $this->data{$this->modelClass}['lastname'];				$data['alternate_mobile']   = @$this->data{$this->modelClass}['alternate_mobile'];                $this->request->data{$this->modelClass}['status'] = 1;                $this->request->data{$this->modelClass}['active'] = 1;                $unid = time();                //$data['uniqid'] = $unid;                $data['vendor_id'] = $cdata['Company']['user_id'];                $data['dob'] = $this->data{$this->modelClass}['dob'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['dob'])) : "";                $data['license_to'] = date("Y-m-d", strtotime($this->data{$this->modelClass}['license_to']));                $data['batch_start_date'] = date("Y-m-d", strtotime($this->data{$this->modelClass}['batch_start_date']));                $data['batch_end_date'] = date("Y-m-d", strtotime($this->data{$this->modelClass}['batch_end_date']));                $data['license_from'] = date("Y-m-d", strtotime($this->data{$this->modelClass}['license_from']));                $data['license_to'] = date("Y-m-d", strtotime($this->data{$this->modelClass}['license_to']));                if ($this->Auth->user('user_role_id') == 6) {                    //if ($this->Auth->user('driver_verification') != 1) {                    $this->request->data['Usermgmt']['verified'] = 2;                    $this->request->data['Usermgmt']['status'] = $user['Usermgmt']['status'];                    //}                }                $pass = $this->data{$this->modelClass}['mobile'];                $data['password'] = AuthComponent::password($pass);                $this->{$this->modelClass}->set($this->request->data);                //pr($data); die;                if ($this->{$this->modelClass}->save($data, false)) {                    $description = "Driver Updated";                    $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                    $all_data = $this->request->data;                    if ($this->Auth->user('user_role_id') == 1) {                        $user_type = 0;                    } else {                        $user_type = 1;                    }                    $this->insert_driver_log($user_id, $description, 1, $user_type, $this->Auth->user('id'), $user_name, $all_data);                    if ($this->Auth->user('user_role_id') == 6) {                        if ($this->Auth->user('driver_verification') != 1) {                            $this->insert_alerts("usermgmt", "index", 'partners', 'Driver Updated', 'driver_verification');                        }                    }                    //pr($data); die;                    //$update_driver_data[$this->modelClass]['uniqid'] = 'D' . $citycode . $user_id;                    $update_driver_data[$this->modelClass]['id'] = $user_id;                    $this->{$this->modelClass}->save($update_driver_data, false);                    $this->loadModel('UserDocument');                    $driver_id = $this->{$this->modelClass}->id;                    $driver_id = $this->{$this->modelClass}->id;                    if (isset($this->data['UserDocument']['image'][0]['name']) && !empty($this->data['UserDocument']['image'][0]['name'])) {                        $getOldimageData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $driver_id, "UserDocument.type" => 8)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $driver_id, "UserDocument.type" => 8));                        $value = $this->data["UserDocument"]['image'];                        foreach ($value as $value) {                            //	pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'userimag' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'userimag' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $driver_id;                                $UserDocument["UserDocument"]["type"] = 8;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");								//pr($UserDocument);exit;                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldimageData)) {                            foreach ($getOldimageData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    //	pr( $this->data["Usermgmt"]['license_proof_img']); exit;                    if (isset($this->data['UserDocument']['license_proof_img'][0]['name']) && !empty($this->data['UserDocument']['license_proof_img'][0]['name'])) {                        $getOldlicenseData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $driver_id, "UserDocument.type" => 1)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $driver_id, "UserDocument.type" => 1));                        $value = $this->data["UserDocument"]['license_proof_img'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'lpi' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'lpi' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $driver_id;                                $UserDocument["UserDocument"]["type"] = 1;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldlicenseData)) {                            foreach ($getOldlicenseData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    if (isset($this->data['UserDocument']['pancard_img'][0]['name']) && !empty($this->data['UserDocument']['pancard_img'][0]['name'])) {                        $getOldPancardData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $driver_id, "UserDocument.type" => 7)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $driver_id, "UserDocument.type" => 7));                        $value = $this->data["UserDocument"]['pancard_img'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'pi' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'pi' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $driver_id;                                $UserDocument["UserDocument"]["type"] = 7;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldPancardData)) {                            foreach ($getOldPancardData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    if (isset($this->data['UserDocument']['aadhar_proof_img'][0]['name']) && !empty($this->data['UserDocument']['aadhar_proof_img'][0]['name'])) {                        $getOldAadharData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $driver_id, "UserDocument.type" => 2)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $driver_id, "UserDocument.type" => 2));                        $value = $this->data["UserDocument"]['aadhar_proof_img'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'api' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'api' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $driver_id;                                $UserDocument["UserDocument"]["type"] = 2;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldAadharData)) {                            foreach ($getOldAadharData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    $this->Session->setFlash(__('Driver has been edited'), 'success');                } else {                    $this->Session->setFlash('Error saving Driver.', 'error');                }                $this->redirect(array('plugin' => false, 'controller' => 'driver', 'action' => 'index'));            }        } else {            if ($user_id == null)                die(__("No ID received"));            //pr($data); exit;            $data = $this->{$this->modelClass}->read(null, $user_id);            $data['Usermgmt']['dob'] = @$data['Usermgmt']['dob'] ? date("d-m-Y", strtotime(@$data['Usermgmt']['dob'])) : "";            $data['Usermgmt']['license_from'] = @$data['Usermgmt']['license_from'] ? date("Y-m-d", strtotime(@$data['Usermgmt']['license_from'])) : "";            $data['Usermgmt']['license_to'] = @$data['Usermgmt']['license_to'] ? date("Y-m-d", strtotime(@$data['Usermgmt']['license_to'])) : "";            $data['Usermgmt']['batch_start_date'] = @$data['Usermgmt']['batch_start_date'] ? date("Y-m-d", strtotime(@$data['Usermgmt']['batch_start_date'])) : "";            $data['Usermgmt']['batch_end_date'] = @$data['Usermgmt']['batch_end_date'] ? date("Y-m-d", strtotime(@$data['Usermgmt']['batch_end_date'])) : "";            $data['Usermgmt']['old_mobile'] = @$data['Usermgmt']['mobile'];            unset($data['Usermgmt']['password']);            $this->data = $data;            $this->set('edit_driver_data', $data);            //pr($this->data);        }        $companyarray = array();        $companyarray = Cache::read('companyarrayusmagmt');        if ($companyarray == "") {            $company = $this->Company->find('all', array(                'conditions' => array(                    "Company.status" => 1                ),                'joins' => array(                    array(                        'table' => 'users',                        'alias' => 'User',                        'type' => 'LEFT',                        'conditions' => array(                            'Company.user_id = User.id'                        )                    )),                'fields' => array(                    'Company.id', 'User.uniqid', 'Company.name',                )            ));            if (!empty($company)) {                foreach ($company as $key => $vl) {                    $companyarray[$vl['Company']['id']] = $vl['Company']['name'] . ' ( ' . $vl['User']['uniqid'] . ' ) ';                }            }            Cache::write('companyarrayusmagmt', $companyarray);        }        $this->set("company", $companyarray);        $this->set('title_for_layout', 'Edit Driver');    }    function edit_company($user_id = 0, $id = null) {        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');//$pages[__('Driver', true)]		=	array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'driver');		        $breadcrumb = array('pages' => $pages, 'active' => __('Edit company', true));        $this->set('breadcrumb', $breadcrumb);        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $users = $this->{$this->modelClass}->find('list', array('fields' => array('username'))); // to get list for dropdowns        $user = $this->{$this->modelClass}->findById($user_id);        $this->set("users", $users);        $this->set("result", $parentdata);        if (!empty($this->data)) {            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->EditValidate()) {                $filename = $this->data{$this->modelClass}['image']['name'];                if ($filename != '') {                    $tempPath = $this->data{$this->modelClass}['image']['tmp_name'];                    $new_file_name = time() . '_' . $filename;                    if (move_uploaded_file($tempPath, ALBUM_UPLOAD_IMAGE_PATH . $new_file_name)) {                        $image = $new_file_name;                    } else {                        $image = $parentdata{$this->modelClass}['image'];                    }                } else {                    $image = $parentdata{$this->modelClass}['image'];                }                $data['firstname'] = $this->data{$this->modelClass}['firstname'];                $data['lastname'] = $this->data{$this->modelClass}['lastname'];                $data['username'] = $this->data{$this->modelClass}['username'];                $data['email'] = $this->data{$this->modelClass}['email'];                $data['status'] = $this->data{$this->modelClass}['status'];                $data['image'] = $image;                $this->{$this->modelClass}->id = $user_id;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('company has been edited'), 'success');                } else {                    $this->Session->setFlash('Error saving company.', 'error');                }                $this->redirect($this->referer());            }        } else {            if ($user_id == null)                die(__("No ID received"));            $data = $this->{$this->modelClass}->read(null, $user_id);            unset($data['Usermgmt']['password']);            $this->data = $data;//pr($this->data);        }        $this->loadModel("Country");        $this->loadModel("State");        $this->loadModel("City");        $this->loadModel("User");        $company = $this->User->find("list", array("conditions" => array("status" => 1, "user_role_id" => 2)));//pr($user);        $state = $this->State->find("list", array("conditions" => array("country_id" => $user['Usermgmt']["country_id"])));        $city = $this->City->find("list", array("conditions" => array("state_id" => $user['Usermgmt']["state_id"])));        $country = $this->Country->find("list", array("conditions" => array("status" => 1)));        $this->set("country", $country);        $this->set("state", $state);        $this->set("city", $city);        $this->set("company", $company);    }    function change_password($user_id = 0, $id = null) {        $this->set('tab_open', 'partners');        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Change Password', true));        $this->set('breadcrumb', $breadcrumb);        $parentdata = $this->{$this->modelClass}->read(null, $user_id);        $this->set("id", $user_id);        $users = $this->{$this->modelClass}->find('list', array('fields' => array('username')));        $this->set("users", $users);        $this->set("result", $parentdata);        if (!empty($this->data)) {//pr($this->data); exit;            $this->{$this->modelClass}->set($this->data);            if ($this->{$this->modelClass}->ChangePassword()) {                $data = array();                $data['password'] = AuthComponent::password($this->data{$this->modelClass}['password']);                $this->{$this->modelClass}->id = $user_id;                if ($this->{$this->modelClass}->save($data, false)) {                    $this->Session->setFlash(__('Password has been successfully changed'), 'success');                } else {                    $this->Session->setFlash(__('Error updating password.'), 'error');                }                $this->redirect($this->referer());            }        } else {            if ($user_id == null)                die(__("No ID received"));            $data = $this->{$this->modelClass}->read(null, $user_id);            unset($data['Usermgmt']['password']);            $this->data = $data;        }    }    public function remove_operation_address() {        if ($this->request->is('Ajax')) {//$this->data['cities_id'] is OperationCity id            if ($this->data['cities_id'] != null) {// Load OperationCity Model                $this->loadModel('OperationCity');// Remove Data from unique id or OperationCity id                if ($this->OperationCity->delete($this->data['cities_id'])) {//$this->Session->setFlash(__('Operational Cities has been deleted'),'success');                    echo '1';                } else {//$this->Session->setFlash(__('Operational Cities has not been deleted'),'success');                    echo '2';                }            }        }        exit;    }    function delete_doc() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] == null) {                echo json_encode(array('succ' => 0, 'msg' => 'Some error occurred!'));                die;            } else {                $this->loadModel('CompanyInformation');                $this->CompanyInformation->id = $this->data['id'];                $this->CompanyInformation->saveField("status", 0);                $this->CompanyInformation->delete($this->data['id']);                $this->Session->setFlash(__('Docs has been deleted.'), 'success');                echo json_encode(array('succ' => 1, 'msg' => 'Docs has been deleted'));                die;            }        }        exit;    }    function delete_driver_doc() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] == null) {                echo 'error';            } else {                $this->loadModel('DriverInformation');                $this->DriverInformation->id = $this->data['id'];                $this->DriverInformation->saveField("status", 0);                $this->DriverInformation->delete($this->data['id']);                $this->Session->setFlash(__('Docs has been deleted.'), 'success');                echo 'Success';            }        }        exit;    }    public function delete() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                if ($this->{$this->modelClass}->delete($this->data['id'])) {                    $this->Session->setFlash(__('User has been deleted'), 'success');                    echo 'Success';                } else {                    $this->Session->setFlash(__('User has not been deleted'), 'success');                    echo 'error';                }            }        }        exit;    }    public function delete_company() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $this->loadModel("Company");////		$this->{$this->modelClass}->hasOne = array("Company" => array("className" => "Company", "foreignKey" => "user_id", 'dependent' => true));////		$this->Company->virtualFields = array(//		    'count_taxi' => 'select count(company_id) from taxis where taxis.company_id=Company.id',//		    'count_driver' => 'select count(company_id) from users where users.company_id=Company.id',//		    //'count_assign' => 'select count(company_id) from assigns where assigns.company_id=Company.id and assigns.to >= now()'//		);////		$data = $this->{$this->modelClass}->findById($this->data['id']);////		//pr($data);////		if ($data["Company"]["count_taxi"] >= 1 || $data["Company"]["count_driver"] >= 1) {////		    echo "Dependent";//		    die;//		}                if ($this->{$this->modelClass}->delete($this->data['id'])) {                    $this->loadModel("Assign");                    $this->Company->deleteAll(array("user_id" => $this->data['id']));// $this->loadModel("Rating");//$this->Rating->deleteAll(array("rat_id"=>$this->data['id']),false);                    /* 					$condition	=	array("rat_id"=>$this->data['id']);                      $this->Rating->deleteAll($condition, false);                     */// $this->Rating->query("DELETE FROM ratings WHERE rat_id=" . $data["Company"]['id'] . " and rating_type=1;");                    echo json_encode(array('succ' => 1, 'msg' => 'Business has been deleted'));                    die;                } else {                    echo json_encode(array('succ' => 1, 'msg' => 'Business has not been deleted'));                    die;                }            }        }        exit;    }    public function delete_driver() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $this->loadModel("User");                if ($this->{$this->modelClass}->delete($this->data['id'])) {                    echo json_encode(array('succ' => 1, 'msg' => 'Driver has been deleted'));                    die;                } else {                    echo json_encode(array('succ' => 0, 'msg' => 'Some error occurred!'));                    die;                }            }        }        exit;    }    function _send_verify_mail($driver_no, $type) {        if ($this->Auth->user('id') != 37) {            $subject = $type . " Document for " . $driver_no;            $to_mail = "vijay.patwal@supercabz.com";            //$to_mail = "rajesh.kumar@supercabz.com";            $pData = array(                'unique_no' => $driver_no,                'name_emp' => "Vijay",                'noti_type' => "Driver",                'text_body' => "Please check document for Driver ID: " . $driver_no . " that is verified by some one else",            );            if ($to_mail) {                $Email = new CakeEmail();                $Email->from(Configure::read("Site.emailbooking"))                        ->to($to_mail)                        ->subject($subject)                        ->template("notification")                        ->emailFormat("html")                        ->viewVars($pData)                        ->send();                $Email = new CakeEmail();            }        }    }    public function verified_ajax() {        //Configure::write('debug', 2);        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $this->Usermgmt->unbindModel(array('hasMany' => array('OperationCity', 'CompanyInformation', 'DriverInformation', 'UserDocument', 'Company')));                $this->{$this->modelClass}->virtualFields = array(                    'un_verified' => 'select count(driver_id) from driver_logs where driver_logs.driver_id=Usermgmt.id and status=5 and user_id IN(1,37)'                );                $all_data = $this->Usermgmt->find('first', array(                    'conditions' => array('Usermgmt.id' => $this->data['id']),                    'fields' => array("Usermgmt.verified", "Usermgmt.un_verified", "Usermgmt.driver_type", "Usermgmt.uniqid", "Usermgmt.firstname", "Usermgmt.mobile", "Usermgmt.vendor_id"),                        )                );                //pr($all_data); exit;                $userData = $all_data;                $on = date("d-m-y h:i A");                if ($all_data[$this->modelClass]['verified'] == 1) {                    $new_value = 0;                    $data['verified'] = 0;                    $status = 5;                    $description = "Driver Unverified";                    $msg = "Driver Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been Unverified on " . $on . "";                } else {                    $un_verified = $all_data[$this->modelClass]['un_verified'];                    if ($un_verified >= 1 && ($this->Auth->user('id') != 37 && $this->Auth->user('id') != 1)) {                        echo 2;                        exit;                    }                    if ($userData['Usermgmt']['driver_type'] == 1) {                        $driver_type = "DCO";                    } else {                        $driver_type = "Driver";                    }                    $this->_send_verify_mail($userData['Usermgmt']['uniqid'], $driver_type);                    $new_value = 1;                    $data['verified'] = 1;                    $status = 6; // blocked                    $description = "Driver Verified";                    $msg = "Driver Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been Verified on " . $on . "";                }                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                $all_data = $data;                if ($this->Auth->user('user_role_id') == 1) {                    $user_type = 0;                } else {                    $user_type = 1;                }                $vendor_id = $userData['Usermgmt']['vendor_id'];                $this->Usermgmt->unbindModel(array('hasMany' => array('OperationCity', 'CompanyInformation', 'DriverInformation', 'UserDocument', 'Company')));                $vendorData = $this->Usermgmt->find('first', array(                    'conditions' => array('Usermgmt.id' => $vendor_id),                    'fields' => array("Usermgmt.device_token"),                        )                );                if ($vendorData) {                    if ($vendorData['Usermgmt']['device_token']) {                        $device_token = $vendorData['Usermgmt']['device_token'];                        $API_KEY = VENDOR_API_KEY;                        $this->SendPushNotification($device_token, $API_KEY, $msg);                    }                }                $this->insert_driver_log($this->data['id'], $description, $status, $user_type, $this->Auth->user('id'), $user_name, $all_data);                echo true;            }        }        exit;    }			public function block_driver() {        //Configure::write('debug', 2);        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $this->Usermgmt->unbindModel(array('hasMany' => array('OperationCity', 'CompanyInformation', 'DriverInformation', 'UserDocument', 'Company')));                $this->{$this->modelClass}->virtualFields = array(                    'un_verified' => 'select count(driver_id) from driver_logs where driver_logs.driver_id=Usermgmt.id and status=5 and user_id IN(1,37)'                );                $all_data = $this->Usermgmt->find('first', array(                    'conditions' => array('Usermgmt.id' => $this->data['id']),                    'fields' => array("Usermgmt.verified", "Usermgmt.un_verified", "Usermgmt.driver_type", "Usermgmt.uniqid", "Usermgmt.firstname", "Usermgmt.mobile", "Usermgmt.vendor_id"),                        )                );				                $userData = $all_data;                $on = date("d-m-y h:i A");               				$new_value = 0;				$data['verified'] = 3;				$status = 5;				$description = "Driver blocked";				$msg = "Driver Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been blocked on " . $on . "";                				$data['verified'] = 3;                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                $all_data  = $data;                if ($this->Auth->user('user_role_id') == 1) {                    $user_type = 0;                } else {                    $user_type = 1;                }                               $this->insert_driver_log($this->data['id'], $description, $status, $user_type, $this->Auth->user('id'), $user_name, $all_data);                echo 1; exit;            }else{				echo 0; exit;			}        }        exit;    }	    public function SendPushNotification($deviceToken = '', $API_KEY = '', $msg) {        $fields = array();        //$API_KEY = 'AIzaSyD6qtUxHZfVIwHkzry0Rjuxs1P4-PFj0So';			        $url = 'https://fcm.googleapis.com/fcm/send';        $fields = array(            'registration_ids' => array($deviceToken),            'data' => array("message" => $msg)        );        $fields = json_encode($fields);        $headers = array('Authorization: key=' . $API_KEY, 'Content-Type: application/json');        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_POST, true);        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);        curl_setopt($ch, CURLOPT_POSTFIELDS, $fields);        $result = curl_exec($ch);        //print_r($result); exit;        curl_close($ch);        //return $result;        return true;    }    public function change_status() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {//$getdata = $this->{$this->modelClass}->find('first', array('conditions' => array('id' => $this->data['id'])));                $getdata = $this->{$this->modelClass}->findById($this->data['id']);                if ($getdata[$this->modelClass]['status'] == 1) {                    $data['status'] = 0;                    $data['status_by_admin'] = 0;                    $status = 3;                    $description = "Driver Inactivated";                } else {                    $data['status'] = 1;                    $data['status_by_admin'] = 1;                    $status = 2;                    $description = "Driver Activated";                }                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                $all_data = $data;                if ($this->Auth->user('user_role_id') == 1) {                    $user_type = 0;                } else {                    $user_type = 1;                }//                //log//                    $text_action = ($getdata[$this->modelClass]['status']=='1')?"activated":"inactivated";//                    $action_type = ($getdata[$this->modelClass]['status']=='1')?"2":"3";//                    $json_data = json_encode($this->request->data);//                    $this->global_logs("usermgmts", $this->data['id'], $action_type, $text_action, $json_data);//					                $this->insert_driver_log($this->data['id'], $description, $status, $user_type, $this->Auth->user('id'), $user_name, $all_data);                echo json_encode(array('succ' => 1, 'msg' => 'Status changed successfully'));                die;            }        }        exit;    }    function detail_customer($id = 0) {        $result = $this->{$this->modelClass}->findById($id);        $this->set("result", $result);    }    function detail_employee($id = 0) {        $result = $this->{$this->modelClass}->findById($id);        $this->set("result", $result);    }    public function payment_status() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                if ($this->data['hold_payment'] == 1) {                    $data['hold_payment'] = 0;                    $status = 3;                    $description = "payment continue";                    $msg = "From tomorrow payment will continue";                } else {                    $data['hold_payment'] = 1;                    $status = 2;                    $description = "payment stopped";                    $msg = "From tomorrow payment will stop";                }                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $this->global_logs("usermgmts", $this->data['id'], $status, $description, $json_data);                echo json_encode(array('succ' => 1, 'msg' => $msg));                die;            }        }        exit;    }    function detail_individual($id = 0) {        //Configure::write('debug', 2);        //$this->{$this->modelClass}->unbindModel(array('hasMany' => array("City")), false);        //  $result = $this->{$this->modelClass}->findById($id);        $this->loadModel("Company");        $this->set('tab_open', 'partners');        $this->{$this->modelClass}->virtualFields = array(            'country' => 'select name from countries where countries.id=Company.country_id',            'state' => 'select name from states where states.id=Company.state_id',            'city' => 'select name from cities where cities.id=Company.city_id',        );        //        //$this->Company->hasMany = array("Taxi" => array("className" => "Taxi", "foreignKey" => "company_id"));        $this->{$this->modelClass}->unbindModel(array('hasMany' => array('Company')), false);        $this->{$this->modelClass}->hasOne = array("Company" => array("className" => "Company", "foreignKey" => "user_id"));        //$result = $this->{$this->modelClass}->findById($id);        $this->{$this->modelClass}->bindModel(array('hasOne' => array('OperationArea' => array(                    'className' => 'OperationArea',                    'foreignKey' => 'user_id',        ))));        $result = $this->{$this->modelClass}->find('first', array('conditions' => array('Usermgmt.id' => $id), 'fields' => array('Usermgmt.id', 'Usermgmt.image', 'Usermgmt.firstname', 'Usermgmt.email', 'Usermgmt.mobile','Usermgmt.alternate_mobile', 'Usermgmt.address', 'Usermgmt.created', 'Usermgmt.lastname', 'Usermgmt.gender', 'Usermgmt.status', 'Usermgmt.modified', 'Usermgmt.user_role_id', 'Company.name', 'Usermgmt.pen_card', 'Company.register_no', 'Company.address', 'Company.bank', 'Company.country_id', 'Company.city_id', 'Company.city_id', 'Usermgmt.state', 'Usermgmt.city', 'Usermgmt.country', 'Usermgmt.passport_proof_img', 'Usermgmt.identity_proof_img', 'Usermgmt.aadhar_proof_img', 'Usermgmt.license_proof_img', 'Usermgmt.aadhar_proof_img', 'OperationArea.city_ids', 'OperationArea.zone_ids',)));        if ($result) {            $city_ids = @$result['OperationArea']['city_ids'] ? explode(",", $result['OperationArea']['city_ids']) : "";            $zone_ids = @$result['OperationArea']['zone_ids'] ? explode(",", $result['OperationArea']['zone_ids']) : "";            if ($city_ids) {                $this->loadModel("City");                $city_list = $this->City->find("all", array('conditions' => array('City.id' => $city_ids), 'fields' => array('City.name',), 'order' => array('City.name' => 'Asc')));                $this->set("cities_list", $city_list);                //pr($city_list);            }            if ($zone_ids) {                $this->loadModel("Zone");                $Zone_list = $this->Zone->find("all", array('conditions' => array('Zone.id' => $zone_ids), 'order' => array('Zone.name' => 'Asc')));                $this->set("Zone_list", $Zone_list);                //pr($Zone_list);            }        }        //pr($result);        $this->set("result", $result);    }    function detail_individual_driver($id = 0) {        //Configure::write('debug', 2);        $this->{$this->modelClass}->unbindModel(array('belongsTo' => array('Company')), false);        //$this->{$this->modelClass}->unbindModel(array('hasMany' => array("City")), false);        $result = $this->{$this->modelClass}->findById($id);        $this->loadModel("Company");        $this->set('tab_open', 'partners');        $this->Company->virtualFields = array(            'country' => 'select name from countries where countries.id=Company.country_id',            'state' => 'select name from states where states.id=Company.state_id',            'city' => 'select name from cities where cities.id=Company.city_id',        );        $this->{$this->modelClass}->hasOne = array("Company" => array("className" => "Company", "foreignKey" => "user_id"));        $this->{$this->modelClass}->bindModel(array('hasOne' => array('OperationArea' => array(                    'className' => 'OperationArea',                    'foreignKey' => 'user_id',        ))));        $result = $this->{$this->modelClass}->findById($id);        $this->set("result", $result);        //pr($result); exit;        if ($result) {            $city_ids = @$result['OperationArea']['city_ids'] ? explode(",", $result['OperationArea']['city_ids']) : "";            $zone_ids = @$result['OperationArea']['zone_ids'] ? explode(",", $result['OperationArea']['zone_ids']) : "";            if ($city_ids) {                $this->loadModel("City");                $city_list = $this->City->find("all", array('conditions' => array('City.id' => $city_ids), 'fields' => array('City.name',), 'order' => array('City.name' => 'Asc')));                $this->set("cities_list", $city_list);                //pr($city_list);            }            if ($zone_ids) {                $this->loadModel("Zone");                $Zone_list = $this->Zone->find("all", array('conditions' => array('Zone.id' => $zone_ids), 'order' => array('Zone.name' => 'Asc')));                $this->set("Zone_list", $Zone_list);                //pr($Zone_list);            }        }        $this->Company->virtualFields = array(            'country' => 'select name from countries where countries.id=Company.country_id',            'state' => 'select name from states where states.id=Company.state_id',            'city' => 'select name from cities where cities.id=Company.city_id',        );        $this->Company->hasMany = array("Taxi" => array("className" => "Taxi", "foreignKey" => "company_id"));        $company = $this->Company->find("first", array('conditions' => array('Company.id' => $result['Usermgmt']['company_id'])));        $this->set("company", $company);    }    function detail_driver($id = 0) {        $this->set('tab_open', 'partners');        //$result = $this->{$this->modelClass}->findById($id);        $result = $this->Usermgmt->find('first', array(            'conditions' => array(                'Usermgmt.id' => $id,            ),            'joins' => array(                array(                    'table' => 'users',                    'alias' => 'Vendor',                    'type' => 'LEFT',                    'conditions' => array(                        'Vendor.id = Usermgmt.vendor_id'                    )                )),            'fields' => array(                'Usermgmt.*', 'Vendor.firstname', 'Vendor.lastname', 'Vendor.uniqid'            )        ));        $this->set("result", $result);        $this->loadModel('UserDocument');        $RegistrationCertificate = $this->UserDocument->find('all', array('conditions' => array('UserDocument.user_id' => $id, 'UserDocument.type' => 1)));        $this->set("RegistrationCertificate", $RegistrationCertificate);        $AdhaarCard = $this->UserDocument->find('all', array('conditions' => array('UserDocument.user_id' => $id, 'UserDocument.type' => 2)));        $this->set("AdhaarCard", $AdhaarCard);        $RationCard = $this->UserDocument->find('all', array('conditions' => array('UserDocument.user_id' => $id, 'UserDocument.type' => 3)));        //pr($RationCard);        $this->set("RationCard", $RationCard);        $VoterId = $this->UserDocument->find('all', array('conditions' => array('UserDocument.user_id' => $id, 'UserDocument.type' => 4)));        $this->set("VoterId", $VoterId);        $PanCard = $this->UserDocument->find('all', array('conditions' => array('UserDocument.user_id' => $id, 'UserDocument.type' => 7)));        $this->set("PanCard", $PanCard);        $DriverImage = $this->UserDocument->find('all', array('conditions' => array('UserDocument.user_id' => $id, 'UserDocument.type' => 8)));        $this->set("DriverImage", $DriverImage);    }    function detail_company($id = 0) {        $result = $this->{$this->modelClass}->findById($id);        $this->set("result", $result);    }    public function status_ajax() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $all_data = $this->{$this->modelClass}->findById($this->data['id']);                $userData = $all_data;                $on = date("d-m-y h:i A");                if ($all_data[$this->modelClass]['status'] == 1) {                    $new_value = 0;                    $data['status'] = 0;                    $status = 4;                    $description = 'Driver Inactivated';                    $msg = "Driver Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been Inactivated on " . $on . "";                } else {                    $new_value = 1;                    $description = 'Driver activated';                    $data['status'] = 1;                    $status = 4;                    $msg = "Driver Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been activated on " . $on . "";                }                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                $vendor_id = $userData['Usermgmt']['vendor_id'];                $vendorData = $this->{$this->modelClass}->findById($vendor_id);                if ($vendorData) {                    if ($vendorData['Usermgmt']['device_token']) {                        $device_token = $vendorData['Usermgmt']['device_token'];                        $API_KEY = VENDOR_API_KEY;                        $this->SendPushNotification($device_token, $API_KEY, $msg);                    }                }                if ($this->Auth->user('user_role_id') == 1) {                    $user_type = 0;                } else {                    $user_type = 1;                }                $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                $all_data = $all_data{$this->modelClass};                $this->insert_driver_log($this->data['id'], $description, $status, $user_type, $this->Auth->user('id'), $user_name, $all_data);                echo $new_value;            }        }        exit;    }    public function mgf_status_ajax() {        if ($this->request->is('Ajax')) {            if ($this->data['id'] != null) {                $all_data = $this->{$this->modelClass}->findById($this->data['id']);                $userData = $all_data;                $on = date("d-m-y h:i A");                if ($all_data[$this->modelClass]['mgf_vendor'] == 1) {                    $new_value = 0;                    $data['mgf_vendor'] = 0;                    $status = 4;                    $description = 'Pair booking Inactivated';                    $msg = "Vendor Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been Inactivated on " . $on . "";                } else {                    $new_value = 1;                    $description = 'Pair booking activated';                    $data['mgf_vendor'] = 1;                    $status = 4;                    $msg = "Vendor Name " . $userData['Usermgmt']['firstname'] . " Mobile No " . $userData['Usermgmt']['mobile'] . " has been activated on " . $on . "";                }                $this->{$this->modelClass}->id = $this->data['id'];                $this->{$this->modelClass}->save($data, false);                if ($this->data['user_role_id'] == 5) {                    $vendor_id = $userData['Usermgmt']['vendor_id'];                    $vendorData = $this->{$this->modelClass}->findById($vendor_id);                    if ($vendorData) {                        if ($vendorData['Usermgmt']['device_token']) {                            $mgf_vendor = $data['mgf_vendor'];                            $this->{$this->modelClass}->updateAll(array('User.mgf_vendor' => $mgf_vendor), array('User.id' => $vendor_id));                        }                    }                }                if ($this->Auth->user('user_role_id') == 1) {                    $user_type = 0;                } else {                    $user_type = 1;                }                $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                $all_data = $all_data{$this->modelClass};                $this->insert_driver_log($this->data['id'], $description, $status, $user_type, $this->Auth->user('id'), $user_name, $all_data);                echo $new_value;            }        }        exit;    }    function dateRange($first, $last, $step = '+1 day', $format = 'm/d/Y') {        $dates = array();        $current = strtotime($first);        $last = strtotime($last);        while ($current <= $last) {            $dates[] = date($format, $current);            $current = strtotime($step, $current);        }        return $dates;    }    function showevents($tid = null) {        if (isset($tid)) {            $this->loadModel('Assigns');            $date = $this->Assigns->find('all', array(                'conditions' => array('driver_id' => $tid), //array of conditions                'fields' => array('from', 'to') //array of field names            ));            $total = $this->Assigns->find('count', array(                'conditions' => array('driver_id' => $tid), //array of conditions                'fields' => array('from', 'to') //array of field names            ));            if ($total == 0) {                echo '<p class="alert alert-warning" style="line-height: 20px; margin: 30px 0;"><i class="icon icon-info"></i> Sorry there are no booking founds!</p>';                exit();            } else {                $edate = array();                foreach ($date as $ndate) {                    $edate['from'] = date('m/d/Y', strtotime($ndate['Assigns']['from']));                    $edate['to'] = date('m/d/Y', strtotime($ndate['Assigns']['to']));                }                ?>                <div id="neventCal"></div>                <script>                    //var myevents = ["08/23/2014","08/25/2014"];                    var myevents = <?php echo stripslashes(json_encode($this->dateRange($edate['from'], $edate['to']))); ?>                    /*var myevents = [                                                          { Title: "Five K for charity", Date: new Date("08/20/2014")},                                                           { Title: "Dinner", Date: new Date("08/22/2014")},                                                           { Title: "Meeting with manager", Date: new Date("08/21/2014")},                                                          { Title: "Dinner", Date: new Date("09/02/2014")},                                                           { Title: "Meeting with manager", Date: new Date("09/21/2014")}                                                          ];*/                    //console.log(myevents);                    $("#neventCal").datepicker({                        changeMonth: true,                        changeYear: true,                        dateFormat: 'm/d/Y',                        /*minDate: new Date(),                                                                  maxDate: "+3",*/                        beforeShowDay: function (date) {                            var result = [true, '', null];                            var matching = $.grep(myevents, function (event) {                                var f = new Date(event.valueOf());                                if (f.valueOf() == date.valueOf()) {                                    return f.valueOf() == date.valueOf();                                }                            });                            if (matching.length) {                                result = [true, 'yesitisbook', null];                            } else {                                return result = [true, 'noitisnotbook', null];                            }                            return result;                        }                    });                    //dialog.dialog( "open" );                </script>                <?php            }        }        exit;    }    public function show_fav_lo() {        $this->loadModel("FavoriteLocation");        $result = $this->FavoriteLocation->find("all", array("conditions" => array("user_id" => $this->data['id'])));        $this->set("result", $result);        $this->loadModel("FavoriteJourny");        $booking_ids = $this->FavoriteJourny->find("list", array("conditions" => array("user_id" => $this->data['id']), "fields" => array("booking_location_id", "booking_location_id")));//pr($booking_ids);//die;        $this->loadModel("BookingLocation");        $this->BookingLocation->virtualFields = array('pd' => "CONCAT(BookingLocation.pickup_location, ' ', BookingLocation.drop_location)");        $result2 = $this->BookingLocation->find("all", array("conditions" => array("id" => $booking_ids), "group" => "pd", 'fields' => array("pd", "pickup_location", 'drop_location', 'modified', 'created')));        $this->set("result2", $result2);    }    public function check_mobile() {        if ($this->request->is('Ajax')) {            $mobile = $this->request->data['mobile'];            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $mobile                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                echo "NOT_OK";            } else {                echo "OK";            }            exit;        }    }    public function check_mobile_driver() {        if ($this->request->is('Ajax')) {            $mobile = $this->request->data['mobile'];            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $mobile                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                echo "NOT_OK";            } else {                echo "OK";            }            exit;        }    }    function vendors() {        $this->set('tab_open', 'invoice');        $this->loadModel("Company");        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Individual'));        $this->set('breadcrumb', $breadcrumb);        $limitValue = $limit = 25;        $this->update_alert_seen("usermgmt", "vendors");        $this->Prg->commonProcess();        $this->set('user_role', $this->user_role);        $recharge_history = array(            'TO' => 'Today',            'YD' => 'Yesterday',            'LW' => 'Last 7 Days',            'LM' => 'Last 30 Days',            'CM' => 'Current Month',        );        $this->set('recharge_history_list', $recharge_history);        //$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        if (empty($this->request->query)) {            $conditions = array('user_role_id' => array(2, 5));        } else {            $conditions = array();        }        //array_push($conditions, array('user_role_id' => array(2, 5)));        $order_arr = array($this->modelClass . '.created' => 'desc');        if (!empty($this->request->query)) {            //            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {            //                array_push($conditions, array('Usermgmt.state_id' => $this->request->query['state_id']));            //                $this->set("state_id", $this->request->query['state_id']);            //            }            //            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['user_role_id']) && $this->request->query['user_role_id'] != "") {                array_push($conditions, array('Usermgmt.user_role_id' => $this->request->query['user_role_id']));                $this->set("user_role_id", $this->request->query['user_role_id']);            }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));                $this->set("firstname", $this->request->query['firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }//            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {//                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));//                $this->set("mobile", $this->request->query['mobile']);//            }//            if (isset($this->request->query['total_balance_order']) && $this->request->query['total_balance_order'] != "") {                $order_arr = array($this->modelClass . '.total_balance' => $this->request->query['total_balance_order']);                $this->set("total_balance_order", $this->request->query['total_balance_order']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                if ($this->request->query['status'] == 1) {                    array_push($conditions, array('Usermgmt.total_balance > ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 2) {                    array_push($conditions, array('Usermgmt.total_balance < ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 0) {                    array_push($conditions, array('Usermgmt.status' => 0));                }                $this->set("status", $this->request->query['status']);            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);            if ((isset($this->request->query['from_date']) && $this->request->query['from_date']) || (isset($this->request->query['to_date']) && $this->request->query['to_date'])) {                if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));                } else                if (@$this->request->query['from_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ' => $this->request->query['from_date']));                } else                if (@$this->request->query['to_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ' => $this->request->query['to_date']));                }            } else {                if (isset($this->request->query['recharge_history']) && $this->request->query['recharge_history']) {                    $rch = $this->request->query['recharge_history'];                    if ($rch == "TO") {                        $from_date = date("Y-m-d");                        $to_date = date("Y-m-d");                    } else if ($rch == "LW") {                        $from_date = date('Y-m-d', strtotime('-7 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "YD") {                        $from_date = date('Y-m-d', strtotime('-1 days'));                        $to_date = date('Y-m-d', strtotime('-1 days'));                    } else if ($rch == "LM") {                        $from_date = date('Y-m-d', strtotime('-30 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "CM") {                        $current_year = date("Y");                        $current_month = date("n");                        $from_date = $current_year . "-" . $current_month . "-01";                        $to_date = date('Y-m-d');                    }                    //echo $from_date." ".$to_date;                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($from_date, $to_date)));                    $this->set("recharge_history", $this->request->query['recharge_history']);                }            }        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        //	$this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Individual / Company');        ///pr($conditions); exit;        $this->{$this->modelClass}->belongsTo = array(//            'State' => array(//                'className' => 'State',//                'foreignKey' => 'state_id'//            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'        ));        $this->Usermgmt->unbindModel(array('hasMany' => array('OperationCity', 'CompanyInformation', 'DriverInformation', 'UserDocument')));        $this->Usermgmt->bindModel(array('hasMany' => array('Company' => array(                    'className' => 'Company',                    'foreignKey' => 'user_id',                    'fields' => array('name'),        ))));        $this->Usermgmt->virtualFields = array(            'total_recharge' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=4',            //'total_credit' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.amount_type=0',            //'total_debit' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.amount_type=1',            //'urgent_booking_incentive' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=9',            //'monthly_incentive' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=10',            'hold_booking_charges' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=8 AND return_payment=0',            'hold_booking_charges_r' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=8 AND return_payment=1',            'cancellation_charges' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=7 AND return_payment=0',            'cancellation_charges_r' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=7 AND return_payment=1',            'driver_penalties' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=11',        );        $this->paginate = array(            'conditions' => array($conditions),            'fields' => array(                'Usermgmt.status', 'Usermgmt.firstname', 'Usermgmt.lastname',                'Usermgmt.mobile', 'hold_booking_charges_r', 'cancellation_charges_r', 'total_recharge', 'hold_booking_charges', 'cancellation_charges', 'driver_penalties', 'Usermgmt.uniqid', 'Usermgmt.total_balance', 'Usermgmt.last_recharge_date', 'Usermgmt.last_recharge_amount', 'Usermgmt.city_id', 'City.name'            ),            //'recursive' => 5,            'limit' => $limit,            'order' => $order_arr        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        Configure::write('debug', 2);        //pr($this->paginate());        //exit;        $this->set('result', $this->paginate());        $this->loadModel("State");        $country = $this->State->find("list");        $this->set("states", $country);        $this->loadModel("City");        $city = $this->City->find("list");        $this->set("city", $city);        $this->set('page', $page);// pr($this->paginate());//  die; //        $count_new_bookings = $this->Usermgmt->find('count', array(//            'conditions' => $conditions//        ));//        $this->set("count_new_bookings", $count_new_bookings);        $this->set('title_for_layout', 'Vendor SOA');        $this->loadModel("Company");//$company = $this->Company->find("list", array("conditions" => array("status" => 1)));        $companyarray = array();        $companyarray_user = Cache::read('companyarray_user');        if ($companyarray_user == "") {            $company = $this->Company->find('all', array(//                'conditions' => array(//                    "Company.status" => 1//                ),                'joins' => array(                    array(                        'table' => 'users',                        'alias' => 'User',                        'type' => 'LEFT',                        'conditions' => array(                            'Company.user_id = User.id'                        )                    )),                'order' => array('Company.name' => 'asc'),                'fields' => array(                    'Company.id', 'User.id', 'User.uniqid', 'Company.name',                )            ));            if (!empty($company)) {                foreach ($company as $key => $vl) {                    $companyarray_user[$vl['User']['id']] = $vl['Company']['name'] . ' (' . $vl['User']['uniqid'] . ')';                }            }            Cache::write('companyarray_user', $companyarray_user);        }        $this->set("company", $companyarray_user);    }    function driversoa() {        $this->set('tab_open', 'invoice');        $this->loadModel("Company");        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Individual'));        $this->set('breadcrumb', $breadcrumb);        $limitValue = $limit = 25;        $this->update_alert_seen("usermgmt", "Driver SOA");        $this->Prg->commonProcess();        $recharge_history = array(            'TO' => 'Today',            'YD' => 'Yesterday',            'LW' => 'Last 7 Days',            'LM' => 'Last 30 Days',            'CM' => 'Current Month',        );        $this->set('recharge_history_list', $recharge_history);        //$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $conditions = array();        array_push($conditions, array('user_role_id' => array(4)));        $order_arr = array($this->modelClass . '.created' => 'desc');        if (!empty($this->request->query)) {//            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {//                array_push($conditions, array('Usermgmt.state_id' => $this->request->query['state_id']));//                $this->set("state_id", $this->request->query['state_id']);//            }//            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));                $this->set("firstname", $this->request->query['firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }//            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {//                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));//                $this->set("mobile", $this->request->query['mobile']);//            }//            if (isset($this->request->query['total_balance_order']) && $this->request->query['total_balance_order'] != "") {                $order_arr = array($this->modelClass . '.total_balance' => $this->request->query['total_balance_order']);                $this->set("total_balance_order", $this->request->query['total_balance_order']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                if ($this->request->query['status'] == 1) {                    array_push($conditions, array('Usermgmt.total_balance > ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 2) {                    array_push($conditions, array('Usermgmt.total_balance < ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 0) {                    array_push($conditions, array('Usermgmt.status' => 0));                }                $this->set("status", $this->request->query['status']);            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);            if ((isset($this->request->query['from_date']) && $this->request->query['from_date']) || (isset($this->request->query['to_date']) && $this->request->query['to_date'])) {                if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));                } else                if (@$this->request->query['from_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ' => $this->request->query['from_date']));                } else                if (@$this->request->query['to_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ' => $this->request->query['to_date']));                }            } else {                if (isset($this->request->query['recharge_history']) && $this->request->query['recharge_history']) {                    $rch = $this->request->query['recharge_history'];                    if ($rch == "TO") {                        $from_date = date("Y-m-d");                        $to_date = date("Y-m-d");                    } else if ($rch == "LW") {                        $from_date = date('Y-m-d', strtotime('-7 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "YD") {                        $from_date = date('Y-m-d', strtotime('-1 days'));                        $to_date = date('Y-m-d', strtotime('-1 days'));                    } else if ($rch == "LM") {                        $from_date = date('Y-m-d', strtotime('-30 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "CM") {                        $current_year = date("Y");                        $current_month = date("n");                        $from_date = $current_year . "-" . $current_month . "-01";                        $to_date = date('Y-m-d');                    }                    //echo $from_date." ".$to_date;                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($from_date, $to_date)));                    $this->set("recharge_history", $this->request->query['recharge_history']);                }            }        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        //	$this->{$this->modelClass}->data[$this->modelClass] = $this->passedArgs;        $pageHeading = __('Individual / Company');        //pr($conditions); exit;        $this->{$this->modelClass}->belongsTo = array(            'State' => array(                'className' => 'State',                'foreignKey' => 'state_id'            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'        ));        $this->Usermgmt->virtualFields = array(            'total_recharge' => 'Select sum(amount) from driver_sos Where user_id=Usermgmt.id AND driver_sos.type=4',            'total_credit' => 'Select sum(amount) from driver_sos Where user_id=Usermgmt.id AND driver_sos.amount_type=0',            'total_debit' => 'Select sum(amount) from driver_sos Where user_id=Usermgmt.id AND driver_sos.amount_type=1',        );        $this->paginate = array(            'conditions' => array($conditions),            'fields' => array(                'Usermgmt.status', 'Usermgmt.created', 'Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.email', 'Usermgmt.address',                'Usermgmt.mobile', 'Usermgmt.image', 'total_recharge', 'total_credit', 'total_debit', 'Usermgmt.uniqid', 'Usermgmt.total_balance', 'Usermgmt.last_recharge_date', 'Usermgmt.last_recharge_amount', 'Usermgmt.state_id', 'Usermgmt.city_id', 'State.name', 'City.name'            ),            'recursive' => 5,            'limit' => $limit,            'order' => $order_arr        );        $this->set('pageHeading', Inflector::singularize($pageHeading));        $this->set('back', $pageHeading);        $this->set('result', $this->paginate());        $this->loadModel("State");        $country = $this->State->find("list");        $this->set("states", $country);        $this->loadModel("City");        $city = $this->City->find("list");        $this->set("city", $city);        $this->set('page', $page);        $this->set('title_for_layout', 'Vendor SOA');        $this->loadModel("Company");        $companyarray = array();        $company = $this->Company->find('all', array(            'conditions' => array(                "Company.status" => 1            ),            'joins' => array(                array(                    'table' => 'users',                    'alias' => 'User',                    'type' => 'LEFT',                    'conditions' => array(                        'Company.user_id = User.id'                    )                )),            'order' => array('Company.name' => 'asc'),            'fields' => array(                'Company.id', 'User.id', 'User.uniqid', 'Company.name',            )        ));        if (!empty($company)) {            foreach ($company as $key => $vl) {                $companyarray[$vl['User']['id']] = $vl['Company']['name'] . ' (' . $vl['User']['uniqid'] . ')';            }        }        $this->set("company", $companyarray);    }    public function exportsos($value) {        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);        $conditions = array();        $limitValue = $limit = 25;        $conditions = array();        array_push($conditions, array('user_role_id' => array(4)));        $order_arr = array($this->modelClass . '.created' => 'desc');        if (!empty($this->request->query)) {            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));            }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));            }            if (isset($this->request->query['total_balance_order']) && $this->request->query['total_balance_order'] != "") {                $order_arr = array($this->modelClass . '.total_balance' => $this->request->query['total_balance_order']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                if ($this->request->query['status'] == 1) {                    array_push($conditions, array('Usermgmt.total_balance > ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 2) {                    array_push($conditions, array('Usermgmt.total_balance < ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 0) {                    array_push($conditions, array('Usermgmt.status' => 0));                }            }            if ((isset($this->request->query['from_date']) && $this->request->query['from_date']) || (isset($this->request->query['to_date']) && $this->request->query['to_date'])) {                if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));                } else                if (@$this->request->query['from_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ' => $this->request->query['from_date']));                } else                if (@$this->request->query['to_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ' => $this->request->query['to_date']));                }            } else {                if (isset($this->request->query['recharge_history']) && $this->request->query['recharge_history']) {                    $rch = $this->request->query['recharge_history'];                    if ($rch == "TO") {                        $from_date = date("Y-m-d");                        $to_date = date("Y-m-d");                    } else if ($rch == "LW") {                        $from_date = date('Y-m-d', strtotime('-7 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "LM") {                        $from_date = date('Y-m-d', strtotime('-30 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "CM") {                        $current_year = date("Y");                        $current_month = date("n");                        $from_date = $current_year . "-" . $current_month . "-01";                        $to_date = date('Y-m-d');                    }                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($from_date, $to_date)));                }            }        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $export_type = ((isset($this->params->named['export_type']) && $this->params->named['export_type'] != "") ? $this->params->named['export_type'] : 'pdf');        $this->{$this->modelClass}->belongsTo = array(            'State' => array(                'className' => 'State',                'foreignKey' => 'state_id'            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'        ));//pr($order_arr); exit;        $this->Usermgmt->virtualFields = array(            'total_recharge' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=4',            'total_credit' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.amount_type=0',            'total_debit' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.amount_type=1',        );        $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array(                'Usermgmt.status', 'Usermgmt.created', 'Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.email', 'Usermgmt.address',                'Usermgmt.mobile', 'Usermgmt.image', 'total_recharge', 'total_credit', 'total_debit', 'Usermgmt.uniqid', 'Usermgmt.total_balance', 'Usermgmt.last_recharge_date', 'Usermgmt.last_recharge_amount', 'Usermgmt.state_id', 'Usermgmt.city_id', 'State.name', 'City.name'            ),            'recursive' => 5,            'order' => $order_arr        ));        $count_new_bookings = $this->Usermgmt->find('count', array(            'conditions' => $conditions        ));//pr($result);exit;        $header = array('S.No.', 'Vendor ID', 'Vendor Name', 'Company Name', 'Mobile No', 'City', 'Last Recharge Amount', 'Last Recharge Date', 'Total Recharge Amount', 'Total Credit Amount', 'Total Debit Amount', 'Current Balance', 'Account Status');        $i = 1;        if (!empty($result)) {            if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }            foreach ($result as $key => $res) {                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Company Name'] = ((isset($res['Company'][0]['name']) && $res['Company'][0]['name'] != NULL) ? $res['Company'][0]['name'] : 'N.A');                $result_value[$key]['Mobile No'] = $res['Usermgmt']['mobile'] ? $res['Usermgmt']['mobile'] : "N.A";                $result_value[$key]['City'] = isset($res['OperationCity'][0]['City']['name']) ? $res['OperationCity'][0]['City']['name'] : 'N.A';                $result_value[$key]['Last Recharge Amount'] = $res['Usermgmt']['last_recharge_amount'] ? $res['Usermgmt']['last_recharge_amount'] : "N.A";                $result_value[$key]['Last Recharge Date'] = $res['Usermgmt']['last_recharge_date'] ? date("d-m-Y H:i", strtotime($res['Usermgmt']['last_recharge_date'])) : "N.A";                $result_value[$key]['Total Recharge Amount'] = $res['Usermgmt']['total_recharge'] ? number_format($res['Usermgmt']['total_recharge'], 2) : "N.A";                $result_value[$key]['Total Credit Amount'] = $res['Usermgmt']['total_credit'] ? number_format($res['Usermgmt']['total_credit'], 2) : "N.A";                $result_value[$key]['Total Debit Amount'] = $res['Usermgmt']['total_debit'] ? number_format($res['Usermgmt']['total_debit'], 2) : "N.A";                if ($res['Usermgmt']['total_balance'] >= 0) {                    $c_balance = number_format($res['Usermgmt']['total_balance'], 2);                } else {                    $c_balance = "(" . number_format(abs($res['Usermgmt']['total_balance']), 2) . ")";                }                $result_value[$key]['Current Balance'] = $c_balance;                if ($res['Usermgmt']['status'] == 1) {                    if ($res['Usermgmt']['total_balance'] > MINIMUM_AMOUNT_FOR_VENDOR) {                        $status = "Active";                    } else {                        $status = "Hold";                    }                } else {                    $status = "Inactive";                }                $result_value[$key]['Account Status'] = $status;                $i--;            }        }        $this->export_file($header, $result_value, $export_type);        die;    }    public $driver_payment_status = array(        '1' => 'Incentive',        '2' => 'Penalties',    );    public function driver_payment($uid = '') {        $this->set('tab_open', 'invoice');        if ($uid == "") {            $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'vendors'));        }        //echo $first_char;        $limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $limitValue = 25;        $limit = 25;        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $this->set('uid', $uid);        //vendor name//        $this->loadModel("User");        $user_dtls = $this->User->find('first', array(            'conditions' => array(                "User.uniqid" => $uid            ),            'fields' => array(                'User.id', 'User.firstname', 'User.lastname'            )        ));        $this->set('user_dtls', $user_dtls);        ///echo $user_dtls['User']['id'];        $conditions = array("DriverPayment.user_id" => $user_dtls['User']['id']);        if (!empty($this->request->query)) {            if (isset($this->request->query['transaction_id']) && $this->request->query['transaction_id'] != "") {                array_push($conditions, array('DriverPayment.walletSysTransactionId' => "" . $this->request->query['transaction_id'] . ""));                $this->set("transaction_id", $this->request->query['transaction_id']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(DATE_FORMAT(DriverPayment.created, "%Y-%m-%d") >= ? AND DATE_FORMAT(DriverPayment.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('DATE_FORMAT(DriverPayment.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('DATE_FORMAT(DriverPayment.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", @$this->request->query['from_date']);            $this->set("to_date", @$this->request->query['to_date']);        }        $this->loadModel("DriverPayment");        $this->loadModel("DriverPayment");        $this->paginate = array(            'conditions' => $conditions,            'joins' => array(                array(                    'table' => 'driver_sos',                    'alias' => 'DriverSos',                    'type' => 'INNER',                    'conditions' => array(                        'DriverSos.id = DriverPayment.driver_sos_id '                    )                )            ),            'fields' => array('DriverSos.*', 'DriverPayment.*'),            'limit' => $limit,            'page' => $page,            'order' => array('DriverPayment.id' => 'desc')        );        // pr($this->paginate('DriverSos'));        $this->set('invoices_list', $this->paginate('DriverPayment'));        $this->set('page', $page);        $this->set('title_for_layout', $user_dtls['User']['firstname'] . " - Account Statement");        $this->set("payment_status", $this->driver_payment_status);    }    public function export($value) {        $this->layout = false;        $value = base64_decode(base64_decode($value));        $value = json_decode($value, true);        $conditions = array();        $limitValue = $limit = 25;        $conditions = array();        array_push($conditions, array('user_role_id' => array(2, 5)));        $order_arr = array($this->modelClass . '.created' => 'desc');        if (!empty($this->request->query)) {            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));            }            if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                array_push($conditions, array('Usermgmt.id' => $this->request->query['firstname']));            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));            }            if (isset($this->request->query['total_balance_order']) && $this->request->query['total_balance_order'] != "") {                $order_arr = array($this->modelClass . '.total_balance' => $this->request->query['total_balance_order']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                if ($this->request->query['status'] == 1) {                    array_push($conditions, array('Usermgmt.total_balance > ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 2) {                    array_push($conditions, array('Usermgmt.total_balance < ' => MINIMUM_AMOUNT_FOR_VENDOR));                    array_push($conditions, array('Usermgmt.status' => 1));                } else if ($this->request->query['status'] == 0) {                    array_push($conditions, array('Usermgmt.status' => 0));                }            }            if ((isset($this->request->query['from_date']) && $this->request->query['from_date']) || (isset($this->request->query['to_date']) && $this->request->query['to_date'])) {                if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));                } else                if (@$this->request->query['from_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ' => $this->request->query['from_date']));                } else                if (@$this->request->query['to_date']) {                    array_push($conditions, array('date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ' => $this->request->query['to_date']));                }            } else {                if (isset($this->request->query['recharge_history']) && $this->request->query['recharge_history']) {                    $rch = $this->request->query['recharge_history'];                    if ($rch == "TO") {                        $from_date = date("Y-m-d");                        $to_date = date("Y-m-d");                    } else if ($rch == "LW") {                        $from_date = date('Y-m-d', strtotime('-7 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "LM") {                        $from_date = date('Y-m-d', strtotime('-30 days'));                        $to_date = date('Y-m-d');                    } else if ($rch == "CM") {                        $current_year = date("Y");                        $current_month = date("n");                        $from_date = $current_year . "-" . $current_month . "-01";                        $to_date = date('Y-m-d');                    }                    array_push($conditions, array('(date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") >= ? AND date_format(Usermgmt.last_recharge_date, "%Y-%m-%d") <= ?)' => array($from_date, $to_date)));                }            }        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $export_type = ((isset($this->params->named['export_type']) && $this->params->named['export_type'] != "") ? $this->params->named['export_type'] : 'pdf');        $this->{$this->modelClass}->belongsTo = array(            'State' => array(                'className' => 'State',                'foreignKey' => 'state_id'            ),            'City' => array(                'className' => 'City',                'foreignKey' => 'city_id'        ));//pr($order_arr); exit;        $this->Usermgmt->virtualFields = array(            'total_recharge' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.type=4',            'total_credit' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.amount_type=0',            'total_debit' => 'Select sum(amount) from payments Where user_id=Usermgmt.id AND payments.amount_type=1',        );        $result = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array(                'Usermgmt.status', 'Usermgmt.created', 'Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.email', 'Usermgmt.address',                'Usermgmt.mobile', 'Usermgmt.image', 'total_recharge', 'total_credit', 'total_debit', 'Usermgmt.uniqid', 'Usermgmt.total_balance', 'Usermgmt.last_recharge_date', 'Usermgmt.last_recharge_amount', 'Usermgmt.state_id', 'Usermgmt.city_id', 'State.name', 'City.name'            ),            'recursive' => 5,            'order' => $order_arr        ));        $count_new_bookings = count($result);//        $count_new_bookings = $this->Usermgmt->find('count', array(//            'conditions' => $conditions//        ));//pr($result);exit;        $header = array('S.No.', 'Vendor ID', 'Vendor Name', 'Company Name', 'Mobile No', 'City', 'Last Recharge Amount', 'Last Recharge Date', 'Total Recharge Amount', 'Total Credit Amount', 'Total Debit Amount', 'Current Balance', 'Account Status');        $i = 1;        if (!empty($result)) {            if ($page == 0 || $page == 1) {                $i = $count_new_bookings;            } else {                $i = $count_new_bookings - $limit * ($page - 1);            }            foreach ($result as $key => $res) {                $result_value[$key]['S.No.'] = $i;                $result_value[$key]['Vendor ID'] = $res['Usermgmt']['uniqid'];                $result_value[$key]['Vendor Name'] = $res['Usermgmt']['firstname'] . " " . $res['Usermgmt']['lastname'];                $result_value[$key]['Company Name'] = ((isset($res['Company'][0]['name']) && $res['Company'][0]['name'] != NULL) ? $res['Company'][0]['name'] : 'N.A');                $result_value[$key]['Mobile No'] = $res['Usermgmt']['mobile'] ? $res['Usermgmt']['mobile'] : "N.A";                $result_value[$key]['City'] = isset($res['OperationCity'][0]['City']['name']) ? $res['OperationCity'][0]['City']['name'] : 'N.A';                $result_value[$key]['Last Recharge Amount'] = $res['Usermgmt']['last_recharge_amount'] ? $res['Usermgmt']['last_recharge_amount'] : "N.A";                $result_value[$key]['Last Recharge Date'] = $res['Usermgmt']['last_recharge_date'] ? date("d-m-Y H:i", strtotime($res['Usermgmt']['last_recharge_date'])) : "N.A";                $result_value[$key]['Total Recharge Amount'] = $res['Usermgmt']['total_recharge'] ? number_format($res['Usermgmt']['total_recharge'], 2) : "N.A";                $result_value[$key]['Total Credit Amount'] = $res['Usermgmt']['total_credit'] ? number_format($res['Usermgmt']['total_credit'], 2) : "N.A";                $result_value[$key]['Total Debit Amount'] = $res['Usermgmt']['total_debit'] ? number_format($res['Usermgmt']['total_debit'], 2) : "N.A";                if ($res['Usermgmt']['total_balance'] >= 0) {                    $c_balance = number_format($res['Usermgmt']['total_balance'], 2);                } else {                    $c_balance = "(" . number_format(abs($res['Usermgmt']['total_balance']), 2) . ")";                }                $result_value[$key]['Current Balance'] = $c_balance;                if ($res['Usermgmt']['status'] == 1) {                    if ($res['Usermgmt']['total_balance'] > MINIMUM_AMOUNT_FOR_VENDOR) {                        $status = "Active";                    } else {                        $status = "Hold";                    }                } else {                    $status = "Inactive";                }                $result_value[$key]['Account Status'] = $status;                $i--;            }        }        $this->export_file($header, $result_value, $export_type);        die;    }    function send_message_vendors() {        $this->autoRender = false;//$this->set("booking_detail", $booking_detail);        $this->loadModel("City");        $city = $this->City->find("list", array('conditions' => array("status" => 1)));        $this->set("city_list", $city);        $this->render('send_message_vendors');    }    function push_message() {        $message_text = $this->request->data['message_text'];        $cities = $this->request->data['SentMessage']['city_id'];        if (!empty($cities)) {            if ($this->Auth->user('user_role_id') == 1) {                $user_type = 0;            } else {                $user_type = 1;            }            $message = $this->request->data['message_text'];            $user_id = $this->Auth->user('id');            $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');            $this->loadModel("SentMessage");            $this->loadModel('User');            $vendor_details = $this->User->find('all', array(                'conditions' => array(                    'User.user_role_id' => 2,                    'User.status' => 1,                    'User.city_id' => $cities,                ),                'fields' => array(                    'User.id', 'User.mobile')                    )            );            // pr($vendor_details);exit;            $Phone_Arr = array();            $Phone_Arr2 = array();            $sent_to = array();            $mode = 0;            if (!empty($vendor_details)) {                foreach ($vendor_details as $data) {                    if ($data['User']['mobile']) {                        if ($mode % 2 == 0) {                            $Phone_Arr[] = '91' . trim($data['User']['mobile']);                        } else {                            $Phone_Arr2[] = '91' . trim($data['User']['mobile']);                        }                        $sent_to[] = $data['User']['id'];                        $mode++;                    }                }            }            if ($message_text) {                //$Phone_Arr = array();                  $message_text = urldecode($message_text);//                $Phone_Arr[] = "919012333233";                  //$Phone_Arr[] = "919289938326"; //active//                $Phone_Arr[] = "919716335846";//                $Phone_Arr[] = "918587030121";                 //$Phone_Arr[] = "918826355579"; //active//                $Phone_Arr[] = "919310456789";//                $Phone_Arr[] = "919871758925";//                $Phone_Arr[] = "917023311807";//                $Phone_Arr[] = "918058450319";//                $Phone_Arr[] = "918130023094";//                $Phone_Arr[] = "4130023095";//                $Phone_Arr[] = "914130023095";                  //$Phone_Arr[] = "917023311807";                //pr($Phone_Arr); exit;                $response = $this->send_message_multiple($Phone_Arr, $message_text);                $response = $this->send_message_multiple($Phone_Arr2, $message_text);                // pr($response); exit;                $responses = array();                if ($response) {                    $responses = explode("status=1", $response);                }                $new_arr = array();                if (!empty($responses)) {                    foreach ($responses as $i => $text) {                        if ($text) {                            $texts = explode("-", $text);                            if (!empty($texts)) {                                if (isset($texts[1]) && $texts[1]) {                                    $numbers = $texts[1];                                    if ($numbers) {                                        $number_ar = explode(",", $numbers);                                        $mobile_num = $number_ar[0];                                        if ($mobile_num) {                                            $new_arr[] = trim(substr($mobile_num, 2));                                        }                                    }                                }                            }                        }                    }                }                //delivered to//                $vendor_details_dl = $this->User->find('all', array(                    'conditions' => array(                        'User.user_role_id' => 2,                        'User.status' => 1,                        'User.mobile' => $new_arr,                    ),                    'fields' => array(                        'User.id', 'User.mobile')                        )                );                $delivered_arr = array();                if (!empty($vendor_details_dl)) {                    foreach ($vendor_details_dl as $dts) {                        $delivered_arr[] = $dts['User']['id'];                    }                }                $ArrIns = array();                $ArrIns['SentMessage']['city_ids'] = !empty($cities) ? implode(",", $cities) : "";                $ArrIns['SentMessage']['sent_to'] = !empty($sent_to) ? implode(",", $sent_to) : "";                $ArrIns['SentMessage']['delivered_to'] = !empty($delivered_arr) ? implode(",", $delivered_arr) : "";                $ArrIns['SentMessage']['message'] = $message;                $ArrIns['SentMessage']['type'] = 0;                $ArrIns['SentMessage']['user_type'] = $user_type;                $ArrIns['SentMessage']['user_id'] = $user_id;                $ArrIns['SentMessage']['user_name'] = $user_name;                $ArrIns['SentMessage']['created'] = date("Y-m-d H:i:s");                $this->SentMessage->save($ArrIns);                $insert_id = $this->SentMessage->getLastInsertId();                $text_action = "added";                $json_data = json_encode($this->request->data);                $this->global_logs("sent_messages", $insert_id, 0, $text_action, $json_data);                //pr($new_arr);                //save to databse//                $this->Session->setFlash(__('Message sent successfully.'), 'success');                $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'messages'));            } else {                $this->Session->setFlash(__('Please enter message.'), 'error');                $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'messages'));            }        } else {            $this->Session->setFlash(__('Please select atleast one city.'), 'error');            $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'messages'));        }        //exit;    }    function send_otp() {        $mobile = $this->data['mobile'];        $tp_sent = "";        if ($mobile) {            $mobpattrn = "/^[789][0-9]{9}$/";            if (preg_match($mobpattrn, $mobile)) {                $this->loadModel("Otp");                $otp = rand(1000, 9999);                // delete otp once verified                $sql2 = "delete from otps where otps.mobile=$mobile";                $this->Otp->query($sql2);                $this->Otp->create();                $ctime = date("Y-m-d H:i:s ", time());                $expire_time = date('Y-m-d H:i:s', strtotime('+30 minutes', strtotime(date("Y-m-d H:i:s ", time()))));                $datas['Otp']['mobile'] = $mobile;                $datas['Otp']['otp'] = $otp;                $datas['Otp']['created'] = $ctime;                $datas['Otp']['verified'] = 0;                $datas['Otp']['expire_time'] = $expire_time;                $this->Otp->save($datas);                $phone_no = "+91" . $mobile;                $msg = "Your Verification Code is " . $otp . ". This code is applicable for 30 minutes only";                $msg = urldecode($msg);                $this->send_message($phone_no, $msg, 1);                $tp_sent = 1;            }        }        echo $tp_sent;        exit;    }    function verify_otp() {        $mobile = $this->data['mobile'];        $otp = $this->data['code'];        $verified = "";        if ($mobile) {            $mobpattrn = "/^[789][0-9]{9}$/";            if (preg_match($mobpattrn, $mobile)) {                $this->loadModel("Otp");                $ctime = date("Y-m-d H:i:s ", time());                $sql = "select id,expire_time from otps WHERE otps.mobile=$mobile AND otps.otp='$otp' ORDER by otps.id DESC limit 1";                $o = $this->Otp->query($sql);                if (count($o) > 0) {                    $otpdata = $o;                    if (strtotime($ctime) <= strtotime($otpdata[0]['otps']['expire_time'])) {                        // verify customer                        $sql1 = "update otps set otps.verified=1 WHERE otps.mobile=$mobile";                        $this->Otp->query($sql1);                        $verified = 1;                    } else {                        $verified = 2;                    }                }            }        }        echo $verified;        exit;    }    public function messages() {        $this->loadModel('SentMessage');        $limitValue = $limit = 25;        $limitValue = 25;        $this->set('limitValue', $limitValue);        $conditions = array();        if ($this->request->is('get') && !isset($this->request->data['recordsPerPage'])) {            if (!empty($this->request->query)) {                if ($this->request->query['submit_button'] == 'Reset') {                    $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'messages'));                } else {                    if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                        $ct_id = $this->request->query['city_id'];                        array_push($conditions, "FIND_IN_SET($ct_id,SentMessage.city_ids)");                        $this->set("city_id", $this->request->query['city_id']);                    }                    if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                        array_push($conditions, array('(DATE_FORMAT(SentMessage.created, "%Y-%m-%d") >= ? AND DATE_FORMAT(SentMessage.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));                    } else                    if (@$this->request->query['from_date']) {                        array_push($conditions, array('DATE_FORMAT(SentMessage.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));                    } else                    if (@$this->request->query['to_date']) {                        array_push($conditions, array('DATE_FORMAT(SentMessage.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));                    }                    $this->set("from_date", @$this->request->query['from_date']);                    $this->set("to_date", @$this->request->query['to_date']);                    if (isset($this->request->query['firstname']) && $this->request->query['firstname'] != "") {                        //pr($this->request->query['firstname']);                         array_push($conditions, array('SentMessage.user_name LIKE' => "%" . $this->request->query['firstname'] . "%"));                        $this->set("firstname", $this->request->query['firstname']);                    }                }            }        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        //$limit = ((isset($this->request->data['recordsPerPage']) && $this->request->data['recordsPerPage'] != "") ? $this->request->data['recordsPerPage'] : 10);        //pr($conditions);        $this->paginate = array(            'conditions' => $conditions,            'limit' => $limitValue,            'order' => array("id" => "DESC"),        );        $this->set('limit', $limit);        $this->set('users_list', $this->paginate('SentMessage'));//        $count_new_bookings = $this->SentMessage->find('count', array(//            'conditions' => $conditions//        ));//        $this->set("count_new_bookings", $count_new_bookings);        $this->set('tab_open', 'partners');        $this->set('reg_from', $this->reg_from);        $this->set('page', $page);        $this->set('title_for_layout', 'Messages');        ////        $user_list = array();        //admin datas//        $this->loadModel('User');        $user_dttls_ad = $this->User->find('first', array(            'conditions' => array(                'User.id' => 1,            ),            'fields' => array('firstname', 'id', 'lastname'),        ));        if (!empty($user_dttls_ad)) {            $user_list[$user_dttls_ad['User']['firstname'] . " " . $user_dttls_ad['User']['lastname']] = $user_dttls_ad['User']['firstname'] . " " . $user_dttls_ad['User']['lastname'];        }        //ends//        $this->loadModel('AccessRightUser');        $user_dttls = $this->AccessRightUser->find('all', array(            'conditions' => array(                'AccessRightUser.status' => 1,            ),            'fields' => array('firstname', 'id', 'employee_id'),        ));        if (!empty($user_dttls)) {            foreach ($user_dttls as $dts) {                $user_list[$dts['AccessRightUser']['firstname']] = $dts['AccessRightUser']['firstname'];            }        }        $this->set('user_dttls', $user_list);        $this->loadModel("City");        $city = $this->City->find("list", array('conditions' => array("status" => 1)));        $this->set("city", $city);    }    function message_users($id, $type) {        $this->autoRender = false;        $this->loadModel('SentMessage');        $msg_records = $this->SentMessage->find('first', array(            'conditions' => array(                'SentMessage.id' => $id,            ),        ));        //pr($msg_records);        $users_list = array();        if (!empty($msg_records)) {            $title = "";            $conditions = array();            if ($type == 'sent_to') {                $users_list = $msg_records['SentMessage']['sent_to'];                $title = "Sent To";            } else {                $users_list = $msg_records['SentMessage']['delivered_to'];                $title = "Delivered To";            }            $users_Arr = explode(",", $users_list);            $conditions = array(                'Company.user_id' => $users_Arr,            );            $this->loadModel('Company');            $users_list = $this->Company->find('all', array(                'conditions' => $conditions,                'fields' => array('name', 'id'),            ));        }        //pr($users_list);exit;        $this->set('count_new_bookings', count($users_list));        $this->set('title', $title);        $this->set('users_list', $users_list);        $this->render('message_users');    }    function get_city_all() {        // Load Fare Settings        $this->layout = false;        $subcategory = array();        if ($this->request->is('Ajax')) {            if ($this->data) {                $this->loadModel("UserCity");                $subcategory = $this->UserCity->find('list', array(                    'conditions' => array(                        'UserCity.state_id' => $this->data['cat_id'],                    ),                    'fields' => array('UserCity.city_id', 'UserCity.city_name'),                ));                /* $data = $this->City->query("SELECT cities.id,cities.name FROM operation_cities                  INNER JOIN cities                  ON                  operation_cities.city_id = cities.id                  WHERE                  operation_cities.company_id = '". $this->data['company_id']."'                  AND                  operation_cities.state_id = '". $this->data['cat_id']."'");                  pr($data); */            }            echo json_encode($subcategory);        }        die;    }    function get_referred_users() {        $res = '';        $this->loadModel("User");        $this->autoRender = false;        $this->autoLayout = false;        if ($this->request->is('ajax')) {            $term = $this->request->data['term'];            $return_arr = array();            $users = $this->User->find('all', array(                'fields' => array('DISTINCT id', 'mobile', 'firstname', 'lastname'),                'conditions' => array(                    'mobile LIKE' => "%" . trim($term) . "%",                    'mobile !=' => 'null',                ), 'recursive' => -1            ));            //$user_list = implode(',', $users);            $user_detail = array();            if (!empty($users)) {                $res .= '<ul id="user-list" style="height:250px;overflow:hidden; overflow-y:scroll;">';                foreach ($users as $key => $value) {                    $res .= '<li onClick="selectUser(\'' . $value['User']['mobile'] . '\');">' . $value['User']['firstname'] . ' ' . $value['User']['lastname'] . '</li>';                    //array_push($user_detail, $value['Booking']['trip_id']);                }                $res .= '</ul>';            } else {                $res .= '<ul id="user-list" style="height:auto;">';                $res .= '<li>No Records</li>';                $res .= '</ul>';            }            echo $res;            exit;        }    }    function get_driver_suggestion() {        $res = '';        $this->loadModel("User");        $this->autoRender = false;        $this->autoLayout = false;        if ($this->request->is('ajax')) {            $term = $this->request->data['term'];            $return_arr = array();            $users = $this->User->find('all', array(                'fields' => array('DISTINCT id', 'mobile', 'firstname', 'lastname'),                'conditions' => array(                    'mobile LIKE' => "%" . trim($term) . "%",                    'mobile !=' => 'null',                    'user_role_id' => 4,                ), 'recursive' => -1            ));            //$user_list = implode(',', $users);            $user_detail = array();            if (!empty($users)) {                $res .= '<ul id="user-list" style="height:250px;overflow:hidden; overflow-y:scroll;">';                foreach ($users as $key => $value) {                    $res .= '<li onClick="selectUser(\'' . $value['User']['mobile'] . '\');">' . $value['User']['firstname'] . ' ' . $value['User']['lastname'] . '</li>';                    //array_push($user_detail, $value['Booking']['trip_id']);                }                $res .= '</ul>';            } else {                $res .= '<ul id="user-list" style="height:auto;">';                $res .= '<li>No Records</li>';                $res .= '</ul>';            }            echo $res;            exit;        }    }    function get_taxi_by_no() {        $res = '';        $this->loadModel("Taxi");        $this->autoRender = false;        $this->autoLayout = false;        if ($this->request->is('ajax')) {            $term = $this->request->data['term'];            $category_id = $this->request->data['category_id'];            $return_arr = array();            $users = $this->Taxi->find('all', array(                'fields' => array('DISTINCT id', 'plate_no'),                'conditions' => array(                    'plate_no LIKE' => "%" . trim($term) . "%",                    'plate_no !=' => 'null',                    'motor_type_id' => $category_id,                ), 'recursive' => -1            ));            //$user_list = implode(',', $users);            $user_detail = array();            if (!empty($users)) {                $res .= '<ul id="taxi-list" style="height:250px;overflow:hidden; overflow-y:scroll;">';                foreach ($users as $key => $value) {                    $res .= '<li onClick="VehicleUser(\'' . $value['Taxi']['plate_no'] . '\');">' . $value['Taxi']['plate_no'] . '</li>';                    //array_push($user_detail, $value['Booking']['trip_id']);                }                $res .= '</ul>';            } else {                $res .= '<ul id="taxi-list" style="height:auto;">';                $res .= '<li>No Records</li>';                $res .= '</ul>';            }            echo $res;            //$return_arr = $user_detail;            //pr($return_arr); die;            //echo json_encode($res);            exit;        }    }    function move_to_dco() {        Configure::write('debug', 2);        $this->set('tab_open', 'partners');        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Add New DCO', true));        $this->set('breadcrumb', $breadcrumb);        if ($this->request->is('Ajax')) {            //	pr($this->data['id']); exit;            $id = $this->data['id'];            $CheckUser = $this->{$this->modelClass}->find("first", array(                'conditions' => array(                    "id" => $this->data['id'],            )));            //pr($CheckUser);			            if (empty($CheckUser)) {                $this->Session->setFlash(__('Invalid Driver ID'), 'error');                $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'driver'));            } else {                $data_chk['firstname'] = $CheckUser{$this->modelClass}['firstname'];                $data_chk['lastname'] = $CheckUser{$this->modelClass}['lastname'];                $data_chk['mobile'] = $CheckUser{$this->modelClass}['mobile'];                $this->{$this->modelClass}->set($data_chk);                $upload_folder = USERDOCS;                $data1 = array();                $dirver_uniqid = $CheckUser{$this->modelClass}['uniqid'];                $data1['firstname'] = $CheckUser{$this->modelClass}['firstname'];                $data1['lastname'] = $CheckUser{$this->modelClass}['lastname'];                $data1['mobile'] = $CheckUser{$this->modelClass}['mobile'];                $data1['username'] = $CheckUser{$this->modelClass}['firstname'];                $data1['dob'] = $CheckUser{$this->modelClass}['dob'];                $data1['address'] = $CheckUser{$this->modelClass}['address'];                $data1['residence_address'] = $CheckUser{$this->modelClass}['permanent_address'];                $data1['permanent_address'] = $CheckUser{$this->modelClass}['permanent_address'];                $data1['user_role_id'] = 5;                $data1['city_id'] = $CheckUser{$this->modelClass}['city_id'];                $data1['state_id'] = $CheckUser{$this->modelClass}['state_id'];                $this->loadModel('City');                $this->loadModel('UserCity');                $cityData = $this->City->findById($CheckUser{$this->modelClass}['round_trip']);                //$cityData = $this->UserCity->findById($CheckUser{$this->modelClass}['city_id']);                $cityData = $this->UserCity->find("first", array(                    'conditions' => array(                        "city_id" => $CheckUser{$this->modelClass}['city_id'],                )));                $citycode = $cityData['UserCity']['city_name'];                $citycode = strtoupper(substr($citycode, 0, 2));                $unid = time();                $data['uniqid'] = $unid;                $pass = $data1['mobile'];                $data1['password'] = AuthComponent::password($pass);                $vendor_name = $CheckUser{$this->modelClass}['firstname'] . ' ' . $CheckUser{$this->modelClass}['lastname'];                $vendor_phone = $CheckUser{$this->modelClass}['mobile'];                $data['user_role_id'] = 4;                $data['firstname'] = $CheckUser{$this->modelClass}['firstname'];                $data['lastname'] = $CheckUser{$this->modelClass}['lastname'];                $data['mobile'] = $CheckUser{$this->modelClass}['mobile'];                $data['username'] = $CheckUser{$this->modelClass}['firstname'];                $data['dob'] = $CheckUser{$this->modelClass}['dob'];                $data['address'] = $CheckUser{$this->modelClass}['address'];                $data['residence_address'] = $CheckUser{$this->modelClass}['residence_address'];                $data['license_no'] = $CheckUser{$this->modelClass}['license_no'];                $data['rto_office'] = @$CheckUser{$this->modelClass}['badge_issue_authority'];                $data['license_from'] = @$CheckUser{$this->modelClass}['license_from'] ? date("Y-m-d", strtotime($CheckUser{$this->modelClass}['license_from'])) : "";                $data['license_to'] = @$CheckUser{$this->modelClass}['license_to'] ? date("Y-m-d", strtotime($CheckUser{$this->modelClass}['license_to'])) : "";                $data['aadhar_no'] = @$CheckUser{$this->modelClass}['aadhar_no'];                $data['pen_card'] = @$CheckUser{$this->modelClass}['pen_card'];                $data['voter_id'] = @$CheckUser{$this->modelClass}['voter_id'];                $data['alternate_mobile'] = @$CheckUser{$this->modelClass}['alternate_mobile'];                $data['one_way'] = @$CheckUser{$this->modelClass}['one_way'];                $data['round_trip'] = @$CheckUser{$this->modelClass}['round_trip'];                $data['ownership_type'] = @$CheckUser{$this->modelClass}['ownership_type'];                $data['contact_person'] = @$CheckUser{$this->modelClass}['contact_person'];                $data['contact_person_mo'] = @$CheckUser{$this->modelClass}['contact_person_mo'];                $data['name_as_on_rc'] = @$CheckUser{$this->modelClass}['name_as_on_rc'];                $data['city_id'] = @$CheckUser{$this->modelClass}['city_id'];                $data['state_id'] = @$CheckUser{$this->modelClass}['state_id'];                $data['country_id'] = 1;                $data['password'] = AuthComponent::password($pass);                $data['active'] = 1;                $data['driver_type'] = 1;                $this->request->data["Company"]["sfrom"] = '';                $this->request->data["Company"]["sto"] = '';                $this->request->data["Company"]["gaddress"] = '';                $this->loadModel('User');                //count //                $count_vendor = $this->User->find('count', array(                    'conditions' => array(                        'User.user_role_id' => array(5, 2)                    ),                ));                //end                $this->{$this->modelClass}->create();                if ($this->{$this->modelClass}->save($data1, false)) {                    $c_id = $this->{$this->modelClass}->id;                    $insert_id = $c_id;                    $text_action = "added";                    $json_data = json_encode($this->request->data);                    $this->global_logs("usermgmts", $insert_id, 0, $text_action, $json_data);                    $last_id_logic = str_pad($count_vendor + 1, 4, "0", STR_PAD_LEFT);                    $unique_id_vendor = 'VP' . $citycode . $last_id_logic;                    $update_vp_data[$this->modelClass]['uniqid'] = $unique_id_vendor;                    $update_vp_data[$this->modelClass]['id'] = $c_id;                    $update_vp_data[$this->modelClass]['agreement_date'] = date("Y-m-d H:i:s");                    $this->{$this->modelClass}->save($update_vp_data, false);                    $this->loadModel("Company");                    $this->request->data["Company"]['name'] = $CheckUser{$this->modelClass}['firstname'] . " " . $CheckUser{$this->modelClass}['lastname'];                    $this->request->data["Company"]['bank'] = @$this->data{$this->modelClass}['bank'];                    $this->request->data["Company"]['vrerify_bank'] = @$this->data{$this->modelClass}['bank'];                    $this->request->data["Company"]['bank_name'] = @$this->data{$this->modelClass}['bank_name'];                    $this->request->data["Company"]['branch_name'] = @$this->data{$this->modelClass}['branch_name'];                    $this->request->data["Company"]['ifsc_code'] = @$this->data{$this->modelClass}['ifsc_code'];                    $this->request->data["Company"]['branch_address'] = @$this->data{$this->modelClass}['branch_address'];                    $this->request->data["Company"]['ac_holder_name'] = $CheckUser{$this->modelClass}['firstname'] . " " . $CheckUser{$this->modelClass}['lastname'];                    $this->request->data["Company"]["user_id"] = $c_id;                    $this->request->data["Company"]["status"] = 1;                    $this->request->data["Company"]["created"] = date("Y-m-d H:i:s");                    $this->Company->save($this->data["Company"]);                    $company_id = $this->Company->getLastInsertID();                    $data['company_id'] = $company_id;                    $data['vendor_id'] = $c_id;                    $this->loadModel('User');                    $count_vendor = $this->User->find('count', array(                        'conditions' => array(                            'User.user_role_id' => 4                        ),                    ));                    /// Updating company and vendor id                    $d_id = $id;                    $update_driver_data[$this->modelClass]['company_id'] = $company_id;                    $update_driver_data[$this->modelClass]['vendor_id'] = $c_id;                    $update_driver_data[$this->modelClass]['driver_type'] = 1;                    $update_driver_data[$this->modelClass]['id'] = $d_id;                    $this->{$this->modelClass}->save($update_driver_data, false);                    //insert into logs and alerts//                    if ($this->Auth->user('user_role_id') == 1) {                        $user_type = 0;                    } else {                        $user_type = 1;                    }                    $description = "Move to DCO";                    $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                    $all_data = $CheckUser{$this->modelClass};                    $this->insert_driver_log($d_id, $description, 0, $user_type, $this->Auth->user('id'), $user_name, $all_data);                    echo 1;                    exit;                } else {                    echo 2;                    exit;                }            }        }    }    function add_new_driver() {        //Configure::write('debug', 2);        //pr($this->request->data); die;        $this->set('tab_open', 'partners');        $pages[__('Dashboard', true)] = array('plugin' => '', 'controller' => '/');        $breadcrumb = array('pages' => $pages, 'active' => __('Add New Driver', true));        $this->set('breadcrumb', $breadcrumb);        $this->loadModel("Zone");        $zone_list = $this->Zone->find("list", array(            'conditions' => array(                "Zone.status" => 1,                "Zone.zone_type" => 1        )));        $this->set("zones", $zone_list);        $this->loadModel('Country');        $this->loadModel('UserDocument');        $country = $this->Country->find('list', array('order' => 'created desc'));        $state = array();        $city = array();        $is_success = 1;        if ($this->request->is('post')) {            /* pr($this->request->data);               $value = $this->data["Usermgmt"]['pancard_img'];              pr($value );              exit; */            $mobile = $this->request->data['Usermgmt']['mobile'];            $this->loadModel('User');            $check_duplicate = $this->User->find('count', array(                'conditions' => array(                    'User.mobile' => $this->request->data['Usermgmt']['mobile'],                    'OR' => array('User.user_role_id' => 5, 'User.user_role_id' => 2)                ),                'recursive' => -1            ));            if ($check_duplicate > 0) {                $this->Session->setFlash(__('This mobile number already exist.'), 'error');                $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'add_new_driver'));            }            if ($this->request->data['Usermgmt']['bank'] != $this->request->data['Usermgmt']['vrerify_bank']) {                $this->Session->setFlash(__('Account Number or Verify Account Number Do not match'), 'error');                $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'add_new_driver'));            }            $data_chk['firstname'] = $this->data{$this->modelClass}['firstname'];            $data_chk['lastname'] = $this->data{$this->modelClass}['lastname'];            $data_chk['mobile'] = $this->data{$this->modelClass}['mobile'];            $this->{$this->modelClass}->set($data_chk);            if ($this->Usermgmt->addVendor()) {                //pr($this->data); exit;                $upload_folder = USERDOCS;                $data1 = array();                $data1['firstname'] = $this->data{$this->modelClass}['firstname'];                $data1['lastname'] = $this->data{$this->modelClass}['lastname'];                $data1['mobile'] = $this->data{$this->modelClass}['mobile'];                $data1['username'] = $this->data{$this->modelClass}['firstname'];                $data1['dob'] = $this->data{$this->modelClass}['dob'];                $data1['address'] = $this->data{$this->modelClass}['address'];                $data1['residence_address'] = $this->data{$this->modelClass}['residence_address'];                $data1['user_role_id'] = 5;                $data1['status'] = 1;                $data1['verified'] = 1;                $data1['city_id'] = $this->data['Company']['city_id'];                $data1['state_id'] = $this->data['Company']['state_id'];                $this->loadModel('City');                $this->loadModel('UserCity');                $cityData = $this->City->find("first", array(                    'conditions' => array(                        "City.id" => $this->data['Company']['city_id'],                )));                $citycode = $cityData['City']['city_code'];               /// $citycode = strtoupper(substr($citycode, 0, 2));                $unid = time();                $data['uniqid'] = $unid;                //echo $citycode; exit;                $pass = $data1['mobile'];                $data1['password'] = AuthComponent::password($pass);                $vendor_name = $this->data{$this->modelClass}['firstname'] . ' ' . $this->data{$this->modelClass}['lastname'];                $vendor_phone = $this->data{$this->modelClass}['mobile'];                $refUsers = $this->User->find('first', array(                    'fields' => array('DISTINCT id'),                    'conditions' => array(                        'mobile' => $this->data{$this->modelClass}['referred_id'],                    ), 'recursive' => -1                ));                $data['user_role_id'] = 4;                //pr($this->data); exit;                $data['firstname'] = $this->data{$this->modelClass}['firstname'];                $data['lastname'] = $this->data{$this->modelClass}['lastname'];                $data['mobile'] = $this->data{$this->modelClass}['mobile'];                $data['username'] = $this->data{$this->modelClass}['firstname'];                $data['dob'] = $this->data{$this->modelClass}['dob'];                $data['address'] = $this->data{$this->modelClass}['address'];                $data['residence_address'] = $this->data{$this->modelClass}['residence_address'];                $data['license_no'] = $this->data{$this->modelClass}['dc_number'];                $data['rto_office'] = $this->data{$this->modelClass}['dc_issuing_authority'];                $data['license_from'] = $this->data{$this->modelClass}['dc_issue_date'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['dc_issue_date'])) : "";                $data['license_to'] = $this->data{$this->modelClass}['dc_expiry_date'] ? date("Y-m-d", strtotime($this->data{$this->modelClass}['dc_expiry_date'])) : "";                $data['aadhar_no'] = $this->data{$this->modelClass}['aadhar_card'];                $data['pen_card'] = @$this->data{$this->modelClass}['pen_card'];                $data['voter_id'] = @$this->data{$this->modelClass}['voter_id'];                $data['alternate_mobile'] = $this->data{$this->modelClass}['alternate_mobile'];                $data['one_way'] = @$this->data{$this->modelClass}['one_way'];                $data['round_trip'] = @$this->data{$this->modelClass}['round_trip'];                $data['ownership_type'] = @$this->data{$this->modelClass}['ownership_type'];                $data['contact_person'] = @$this->data{$this->modelClass}['contact_person'];                $data['contact_person_mo'] = @$this->data{$this->modelClass}['contact_person_mo'];                $data['name_as_on_rc'] = @$this->data{$this->modelClass}['name_as_on_rc'];                if (@$refUsers['User']['id']) {                    $data['referred_id'] = @$refUsers['User']['id'];                }                $data['city_id'] = $this->data['Company']['city_id'];                $data['state_id'] = $this->data['Company']['state_id'];                $data['country_id'] = 1;                $data['password'] = AuthComponent::password($pass);                $data['active'] = 1;                $data['status'] = 2;                $data['verified'] = 2;                $data['driver_type'] = 1;                $this->request->data["Company"]["sfrom"] = '';                $this->request->data["Company"]["sto"] = '';                $this->request->data["Company"]["gaddress"] = '';                $this->loadModel('User');                //count //                $count_vendor = $this->User->find('count', array(                    'conditions' => array(                        'User.user_role_id' => array(5, 2)                    ),                ));                //end                //$data1==>Vendor Array//                if ($is_success == 1) {                    $this->{$this->modelClass}->create();                    if ($this->{$this->modelClass}->save($data1)) {                        $c_id = $this->{$this->modelClass}->id;                        //log                        $insert_id = $c_id;                        $text_action = "added";                        $json_data = json_encode($this->request->data);                        $this->global_logs("usermgmts", $insert_id, 0, $text_action, $json_data);                        $last_id_logic = str_pad($count_vendor + 1, 4, "0", STR_PAD_LEFT);                        $unique_id_vendor = 'VP' . $citycode . $last_id_logic;                        $update_vp_data[$this->modelClass]['uniqid'] = $unique_id_vendor;                        $update_vp_data[$this->modelClass]['id'] = $c_id;                        $update_vp_data[$this->modelClass]['agreement_date'] = date("Y-m-d H:i:s");                        $this->{$this->modelClass}->save($update_vp_data, false);                        $this->loadModel("Company");                        $this->request->data["Company"]['name'] = $this->data{$this->modelClass}['firstname'] . " " . $this->data{$this->modelClass}['lastname'];                        $this->request->data["Company"]['bank'] = $this->data{$this->modelClass}['bank'];                        $this->request->data["Company"]['vrerify_bank'] = $this->data{$this->modelClass}['bank'];                        $this->request->data["Company"]['bank_name'] = $this->data{$this->modelClass}['bank_name'];                        $this->request->data["Company"]['branch_name'] = $this->data{$this->modelClass}['branch_name'];                        $this->request->data["Company"]['ifsc_code'] = $this->data{$this->modelClass}['ifsc_code'];                        $this->request->data["Company"]['branch_address'] = $this->data{$this->modelClass}['branch_address'];                        $this->request->data["Company"]['ac_holder_name'] = $this->data{$this->modelClass}['ac_holder_name'];                        $this->request->data["Company"]["user_id"] = $c_id;                        $this->request->data["Company"]["status"] = 1;                        $this->request->data["Company"]["created"] = date("Y-m-d H:i:s");                        $this->Company->save($this->data["Company"]);                        $company_id = $this->Company->getLastInsertID();                        $data['company_id'] = $company_id;                        $data['vendor_id'] = $c_id;                        $this->loadModel('User');                        $count_vendor = $this->User->find('count', array(                            'conditions' => array(                                'User.user_role_id' => 4                            ),                        ));                        $this->{$this->modelClass}->create();                        if ($this->{$this->modelClass}->save($data, false)) {                            $d_id = $this->{$this->modelClass}->id;                            $last_add_driver_id = str_pad($count_vendor + 1, 4, "0", STR_PAD_LEFT);                            $update_driver_data[$this->modelClass]['uniqid'] = 'DR' . $citycode . $last_add_driver_id;                            $update_driver_data[$this->modelClass]['id'] = $d_id;                            $this->{$this->modelClass}->save($update_driver_data, false);                            if (isset($this->data['OperationArea']["zones"])) {                                $this->loadModel("OperationArea");                                $this->OperationArea->create();                                $OperationArea["OperationArea"]['user_id'] = $d_id;                                //$OperationArea["OperationArea"]["zone_ids"] = $this->data['OperationArea']['zone_ids'];                                $OperationArea["OperationArea"]["zone_ids"] = @$this->data['OperationArea']['zones'];                                $OperationArea["OperationArea"]["city_ids"] = @$this->data['OperationArea']['cities'];                                $this->OperationArea->saveAll($OperationArea);                            }                            $this->show_to_all($d_id);                            //insert into logs and alerts//                            if ($this->Auth->user('user_role_id') == 1) {                                $user_type = 0;                            } else {                                $user_type = 1;                            }                            $description = "Driver Added";                            $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                            $all_data = $this->request->data;                            $this->insert_driver_log($d_id, $description, 0, $user_type, $this->Auth->user('id'), $user_name, $all_data);                            /* if (isset($uploadimageArray) && $uploadimageArray['name'] != "") {                              $file_name = $d_id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray['name']));                              if (move_uploaded_file($uploadimageArray['tmp_name'], $upload_folder . DS . $file_name)) {                              // $this->resize($file_name, 200, 150, $upload_folder, $thumb_folder);                              /* echo $file_name.'>>>'.$this->{$this->modelClass}->id;                              die; */                            /*       $this->User->updateAll(array('User.image' => "'" . $file_name . "'"), array('User.id' => $d_id));                              //unlink($upload_folder . DS . $file_name);                              } else {                              $is_file_uploaded = 0;                              }                              }                              if (isset($uploadimageArray_proof_pancard) && $uploadimageArray_proof_pancard['name'] != "") {                              $file_name_proof = $d_id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof_pancard['name']));                              if (move_uploaded_file($uploadimageArray_proof_pancard['tmp_name'], $upload_folder . DS . $file_name_proof)) {                              // $this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                              $this->User->updateAll(array('User.pancard_img' => "'" . $file_name_proof . "'"), array('User.id' => $d_id));                              } else {                              $is_file_uploaded_proof = 0;                              }                              }                              if (isset($uploadimageArray_proof_aadhar) && $uploadimageArray_proof_aadhar['name'] != "") {                              $file_name_proof = $d_id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof_aadhar['name']));                              if (move_uploaded_file($uploadimageArray_proof_aadhar['tmp_name'], $upload_folder . DS . $file_name_proof)) {                              //$this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                              $this->User->updateAll(array('User.aadhar_proof_img' => "'" . $file_name_proof . "'"), array('User.id' => $d_id));                              } else {                              $is_file_uploaded_proof = 0;                              }                              }                              //$uploadimageArray_proof_license                              if (isset($uploadimageArray_proof_license) && $uploadimageArray_proof_license['name'] != "") {                              $file_name_proof = $d_id . '_' . time() . '_' . basename(str_replace(array(" ", "-", ":"), array("_", "_", "_"), $uploadimageArray_proof_license['name']));                              if (move_uploaded_file($uploadimageArray_proof_license['tmp_name'], $upload_folder . DS . $file_name_proof)) {                              // $this->resize($file_name_proof, 200, 150, $upload_folder, $thumb_folder);                              $this->User->updateAll(array('User.license_proof_img' => "'" . $file_name_proof . "'"), array('User.id' => $d_id));                              } else {                              $is_file_uploaded_proof = 0;                              }                              } */                            $this->loadModel('UserDocument');                            if (isset($this->data['Usermgmt']['image']) && !empty($this->data['Usermgmt']['image'])) {                                $value = $this->data["Usermgmt"]['image'];                                foreach ($value as $value) {                                    //	pr($value); exit;                                    $i = 1;                                    $this->UserDocument->create();                                    if (!empty($value["tmp_name"])) {                                        $filename = time() . $i . 'userimag' . str_replace(" ", "_", $value['name']);                                        $filename = time() . $i . 'userimag' . str_replace("/", "_", $filename);                                        move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                        $UserDocument["UserDocument"]["document_image"] = $filename;                                        $UserDocument["UserDocument"]["user_id"] = $d_id;                                        $UserDocument["UserDocument"]["type"] = 8;                                        $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                        $this->UserDocument->saveAll($UserDocument);                                    }                                    $i++;                                }                            }                            //	pr( $this->data["Usermgmt"]['license_proof_img']); exit;                            if (isset($this->data['Usermgmt']['license_proof_img']) && !empty($this->data['Usermgmt']['license_proof_img'])) {                                $value = $this->data["Usermgmt"]['license_proof_img'];                                foreach ($value as $value) {                                    //pr($value); exit;                                    $i = 1;                                    $this->UserDocument->create();                                    if (!empty($value["tmp_name"])) {                                        $filename = time() . $i . 'lpi' . str_replace(" ", "_", $value['name']);                                        $filename = time() . $i . 'lpi' . str_replace("/", "_", $filename);                                        move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                        $UserDocument["UserDocument"]["document_image"] = $filename;                                        $UserDocument["UserDocument"]["user_id"] = $d_id;                                        $UserDocument["UserDocument"]["type"] = 1;                                        $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                        $this->UserDocument->saveAll($UserDocument);                                    }                                    $i++;                                }                            }                            if (isset($this->data['Usermgmt']['pancard_img']) && !empty($this->data['Usermgmt']['pancard_img'])) {                                $value = $this->data["Usermgmt"]['pancard_img'];                                foreach ($value as $value) {                                    //pr($value); exit;                                    $i = 1;                                    $this->UserDocument->create();                                    if (!empty($value["tmp_name"])) {                                        $filename = time() . $i . 'pi' . str_replace(" ", "_", $value['name']);                                        $filename = time() . $i . 'pi' . str_replace("/", "_", $filename);                                        move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                        $UserDocument["UserDocument"]["document_image"] = $filename;                                        $UserDocument["UserDocument"]["user_id"] = $d_id;                                        $UserDocument["UserDocument"]["type"] = 7;                                        $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                        $this->UserDocument->saveAll($UserDocument);                                    }                                    $i++;                                }                            }                            if (isset($this->data['Usermgmt']['aadhar_proof_img']) && !empty($this->data['Usermgmt']['aadhar_proof_img'])) {                                $value = $this->data["Usermgmt"]['aadhar_proof_img'];                                foreach ($value as $value) {                                    //pr($value); exit;                                    $i = 1;                                    $this->UserDocument->create();                                    if (!empty($value["tmp_name"])) {                                        $filename = time() . $i . 'api' . str_replace(" ", "_", $value['name']);                                        $filename = time() . $i . 'api' . str_replace("/", "_", $filename);                                        move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                        $UserDocument["UserDocument"]["document_image"] = $filename;                                        $UserDocument["UserDocument"]["user_id"] = $d_id;                                        $UserDocument["UserDocument"]["type"] = 2;                                        $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                        $this->UserDocument->saveAll($UserDocument);                                    }                                    $i++;                                }                            }                            if (isset($this->data['Usermgmt']['check_copy']) && !empty($this->data['Usermgmt']['check_copy'])) {                                $value = $this->data["Usermgmt"]['check_copy'];                                foreach ($value as $value) {                                    //pr($value); exit;                                    $i = 1;                                    $this->UserDocument->create();                                    if (!empty($value["tmp_name"])) {                                        $filename = time() . $i . 'cc' . str_replace(" ", "_", $value['name']);                                        $filename = time() . $i . 'ccc' . str_replace("/", "_", $filename);                                        move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                        $UserDocument["UserDocument"]["document_image"] = $filename;                                        $UserDocument["UserDocument"]["user_id"] = $d_id;                                        $UserDocument["UserDocument"]["type"] = 9;                                        $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                        $this->UserDocument->saveAll($UserDocument);                                    }                                    $i++;                                }                            }                        }                    }//sms send//                    $phone_no = "+91" . $mobile;//                    $msg = "test msg";//                    $msg = urldecode($msg);//                    $this->send_message($phone_no, $msg, 1);                    $this->Session->setFlash(__('Driver has been added'), 'success');                    $this->redirect(array('action' => 'driver_list'));                } else {                    $this->data = $this->request->data;                    $this->loadModel('Country');                    $country = $this->Country->find('list', array('order' => 'created desc'));                    $this->loadModel('State');                    $state = $this->State->find("list", array("conditions" => array("country_id" => 1)), array("order" => "created desc"));                    $this->loadModel('City');                    $city = $this->City->find("list", array("conditions" => array("state_id" => $this->request->data['Company']['state_id'])), array("order" => "created desc"));                }            } else {                $this->data = $this->request->data;                $this->loadModel('Country');                $country = $this->Country->find('list', array('order' => 'created desc'));                $this->loadModel('State');                $state = $this->State->find("list", array("conditions" => array("country_id" => 1)), array("order" => "created desc"));                $this->loadModel('City');                $city = $this->City->find("list", array("conditions" => array("state_id" => $this->request->data['Company']['state_id'])), array("order" => "created desc"));               /*  $this->loadModel("UserState");                $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));                $this->loadModel("UserCity");                $city = $this->UserCity->find("list", array("fields" => array("city_id", "city_name"), array("conditions" => array("state_id" => $this->request->data['Company']['state_id'])))); */				//$this->Session->setFlash(__('Corporate business has not been added.'), 'error');            }        }        $this->loadModel('State');        $state = $this->State->find("list", array("conditions" => array("country_id" => '1')), array("order" => "created desc"));		/*		$this->loadModel("UserState");        $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));		*/        $this->set('country', $country);        $this->set('state', $state);        $this->set('city', $city);        $this->loadModel("City");        $city_list = $this->City->find("list", array('conditions' => array('City.status' => 'A'), 'order' => array('City.name' => 'Asc')));        $this->set("city_list", $city_list);        $this->set('title_for_layout', 'Add New Driver');    }    function get_user_city() {        $this->loadModel("UserCity");        $this->layout = false;        $subcategory = array();        if (!empty($this->data)) {            $subcategory = $this->UserCity->find('all', array('fields' => array('city_id as id', 'city_name as name'), 'conditions' => array('state_id' => $this->data['cat_id'])));            //pr($subcategory);die;        }        echo json_encode($subcategory);        die;    }    function driver_list() {        //Configure::write('debug', 2);        $this->set('tab_open', 'partners');        $limitValue = $limit = 25;        //$limitValue = $limit = ($this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') ) ? $this->Session->read($this->name . '.' . $this->action . '.recordsPerPage') : Configure::read('defaultPaginationLimit');        $this->set('limitValue', $limitValue);        $this->set('limit', $limit);        $conditions = array();        array_push($conditions, array('Usermgmt.driver_type' => '1', 'Usermgmt.user_role_id' => array(4)));        if (!empty($this->request->query)) {            if (isset($this->request->query['mobile']) && $this->request->query['mobile'] != "") {                array_push($conditions, array('Usermgmt.mobile' => $this->request->query['mobile']));                $this->set("mobile", $this->request->query['mobile']);            }            if (isset($this->request->query['state_id']) && $this->request->query['state_id'] != "") {                array_push($conditions, array('Usermgmt.state_id' => "" . $this->request->query['state_id'] . ""));                $this->set("state_id", $this->request->query['state_id']);            }            if (isset($this->request->query['city_id']) && $this->request->query['city_id'] != "") {                array_push($conditions, array('Usermgmt.city_id' => "" . $this->request->query['city_id'] . ""));                $this->set("city_id", $this->request->query['city_id']);            }            if (isset($this->request->query['driver_firstname']) && $this->request->query['driver_firstname'] != "") {                array_push($conditions, array(                    'OR' => array(                        'LOWER(Usermgmt.firstname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        'LOWER(Usermgmt.lastname) LIKE' => "%" . strtolower($this->request->query['driver_firstname']) . "%",                        "LOWER(CONCAT_WS(' ',Usermgmt.firstname,Usermgmt.lastname)) LIKE" => "%" . strtolower($this->request->query['driver_firstname']) . "%",                    )                ));                $this->set("driver_firstname", $this->request->query['driver_firstname']);            }            if (isset($this->request->query['uniqid']) && $this->request->query['uniqid'] != "") {                /* array_push($conditions, array('Usermgmt.uniqid' => $this->request->query['driver_uniqid']));                  $this->set("driver_uniqid", $this->request->query['driver_uniqid']); */                array_push($conditions, array('Usermgmt.uniqid LIKE' => "%" . $this->request->query['uniqid'] . "%"));                $this->set("uniqid", $this->request->query['uniqid']);            }            if (isset($this->request->query['status']) && $this->request->query['status'] != "") {                array_push($conditions, array('Usermgmt.status' => $this->request->query['status']));                $this->set("status", $this->request->query['status']);            }            if (isset($this->request->query['verified']) && $this->request->query['verified'] != "") {                array_push($conditions, array('Usermgmt.verified' => $this->request->query['verified']));                $this->set("verified", $this->request->query['verified']);            }            if (isset($this->request->query['license_no']) && $this->request->query['license_no'] != "") {                array_push($conditions, array('Usermgmt.license_no' => $this->request->query['license_no']));                $this->set("license_no", $this->request->query['license_no']);            }            if (@$this->request->query['from_date'] and @ $this->request->query['to_date']) {                array_push($conditions, array('(date_format(Usermgmt.created, "%Y-%m-%d") >= ? AND date_format(Usermgmt.created, "%Y-%m-%d") <= ?)' => array($this->request->query['from_date'], $this->request->query['to_date'])));            } else            if (@$this->request->query['from_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") >= ' => $this->request->query['from_date']));            } else            if (@$this->request->query['to_date']) {                array_push($conditions, array('date_format(Usermgmt.created, "%Y-%m-%d") <= ' => $this->request->query['to_date']));            }            $this->set("from_date", $this->request->query['from_date']);            $this->set("to_date", $this->request->query['to_date']);        }        $page = ((isset($this->params->named['page']) && $this->params->named['page'] != "") ? $this->params->named['page'] : 0);        $this->Usermgmt->virtualFields = array(            'city_name' => 'Select city_name From user_cities Where city_id= Usermgmt.city_id limit 1',            //'state_name' => 'Select state_name From user_states Where state_id= Usermgmt.state_id limit 1',            'plate_no' => 'Select plate_no From taxis Where user_id= Usermgmt.id limit 1',                //'created_by' => 'Select user_name From driver_logs Where driver_id= Usermgmt.id AND status="0" limit 1',                //'verified_by' => 'Select user_name From driver_logs Where driver_id= Usermgmt.id AND status=4 order by id desc limit 1',        );        $this->Usermgmt->unbindModel(array('hasMany' => array('Company', 'OperationCity', 'CompanyInformation', 'DriverInformation')), false);        $this->paginate = array(            'conditions' => array($conditions),            'fields' => array("city_name", "plate_no", "id", "uniqid", "firstname", 'mgf_vendor', "status_by_admin", "lastname", "mobile", "license_no", "dob", "created", "status", "verified"),            'limit' => $limit,            'order' => array('Usermgmt.id' => 'desc'),        );        //$this->loadModel("DriverLog");        /* $this->DriverLog->updateAll(array('DriverLog.user_id' =>24,'DriverLog.user_name' =>"'Deepak Rai'"), array('DriverLog.driver_id' => array(2049,2027,2030,2021,2011,1999,1992,1995,1997),'DriverLog.status' => 0));          $DriverLog = $this->DriverLog->find("all", array('conditions' => array('DriverLog.driver_id' => 1997,'DriverLog.status' => 0)));          $driver_id = '2058';          $description = "Driver Added";          $user_type = 1;          $status= 0;          $user_id=24;          $user_name='Deepak Rai';          if ($driver_id) {          $this->loadModel("DriverLog");          $ArrIns = array();          $ArrIns['DriverLog']['driver_id'] = $driver_id;          $ArrIns['DriverLog']['description'] = $description;          $ArrIns['DriverLog']['status'] = $status;          $ArrIns['DriverLog']['user_type'] = $user_type;          $ArrIns['DriverLog']['user_id'] = $user_id;          $ArrIns['DriverLog']['user_name'] = $user_name;          $this->DriverLog->save($ArrIns);          } */        //pr($DriverLog);        //pr($this->paginate('Usermgmt'));exit;        $state = Cache::read('stateDCO');        if ($state == "") {            $this->loadModel("UserState");            $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));            Cache::write('stateDCO', $state);        }        $this->set("states", $state);        $city = Cache::read('UserCityDCO');        if ($city == "") {            $this->loadModel("UserCity");            $city = $this->UserCity->find("list", array("fields" => array("city_id", "city_name")));            Cache::write('UserCityDCO', $city);        }        $this->set("city", $city);        //Configure::write('debug', 2);        // pr($this->paginate('Usermgmt'));        $this->set('result', $this->paginate('Usermgmt'));        $this->set('page', $page);        $this->set('title_for_layout', 'Driver List');    }    function update_driver($id) {        $this->set('tab_open', 'partners');        //pr($this->request->data);die;        $this->loadModel("User");        $this->loadModel("Company");        //$data = $this->User->read(null, $id);        $this->User->bindModel(array('hasMany' => array('UserDocument')));        $this->User->bindModel(array('hasOne' => array('OperationArea' => array(                    'className' => 'OperationArea',                    'foreignKey' => 'user_id',        ))));        $data = $this->User->find("first", array('conditions' => array('User.id' => $id)));        //pr($data);exit;        $vendor_id = $data['User']['vendor_id'];        $company = $this->Company->find("first", array('conditions' => array('Company.id' => $data['User']['company_id'])));        //*************************************          $data['OperationArea']['city_ids'] = @$data['OperationArea']['city_ids'];        $data['OperationArea']['zones'] = @$data['OperationArea']['zone_ids'];        $data['OperationArea']['to_cities_id'] = @$data['OperationArea']['city_ids'] ? explode(",", $data['OperationArea']['city_ids']) : "";        $data['OperationArea']['to_zone_ids'] = @$data['OperationArea']['zone_ids'] ? explode(",", $data['OperationArea']['zone_ids']) : "";        $this->loadModel("City");        $city_list = $this->City->find("list", array('conditions' => array('City.status' => 'A'), 'order' => array('City.name' => 'Asc')));        $this->set("cities_list", $city_list);        $this->set("default_cities_list", $data['OperationArea']['to_cities_id']);        $this->set("default_zone_ids", $data['OperationArea']['to_zone_ids']);        $this->loadModel("Zone");        $zone_list = $this->Zone->find("list", array(            'conditions' => array(                "Zone.status" => 1,                "Zone.zone_type" => 1        )));        $this->set("zones", $zone_list);        //pr($data);        if ($this->request->is('post')) {            if ($this->request->data['Usermgmt']['bank'] != $this->request->data['Usermgmt']['vrerify_bank']) {                $this->Session->setFlash(__('Account Number or Verify Account Number Do not match'), 'error');                $this->redirect(array('plugin' => 'usermgmt', 'controller' => 'usermgmt', 'action' => 'update_driver', $id));            }            $upload_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . DS . 'uploads' . DS . 'photos';            $thumb_folder = WEBSITE_APP_WEBROOT_ROOT_PATH . DS . 'uploads' . DS . 'photos';            $data1 = array();            $data2 = array();            $this->request->data['User']['firstname'] = $this->data{$this->modelClass}['firstname'];            $this->request->data['User']['lastname'] = $this->data{$this->modelClass}['lastname'];            $this->request->data['User']['username'] = $this->data{$this->modelClass}['firstname'];            $this->request->data['User']['dob'] = $this->data{$this->modelClass}['dob'];            $this->request->data['User']['address'] = $this->data{$this->modelClass}['address'];            $this->request->data['User']['residence_address'] = $this->data{$this->modelClass}['residence_address'];            $this->request->data['User']['city_id'] = $this->data['Company']['city_id'];            $this->request->data['User']['state_id'] = $this->data['Company']['state_id'];            if (isset($this->data{$this->modelClass}['mobile']) && !empty($this->data{$this->modelClass}['mobile'])) {                $this->request->data['User']['mobile'] = $this->data{$this->modelClass}['mobile'];            }            $this->request->data['User']['id'] = $vendor_id;			            $this->request->data['User']['user_role_id'] = 5;            if ($this->User->save($this->request->data['User'], false)) {                $data2['User']['firstname'] = $this->data{$this->modelClass}['firstname'];                $data2['User']['lastname'] = $this->data{$this->modelClass}['lastname'];                $data2['User']['username'] = $this->data{$this->modelClass}['firstname'];                $data2['User']['dob'] = $this->data{$this->modelClass}['dob'];                $data2['User']['address'] = $this->data{$this->modelClass}['address'];                $data2['User']['residence_address'] = $this->data{$this->modelClass}['residence_address'];                if (isset($this->data{$this->modelClass}['mobile']) && !empty($this->data{$this->modelClass}['mobile'])) {                    $data2['User']['mobile'] = $this->data{$this->modelClass}['mobile'];                }                $data2['User']['aadhar_no'] = $this->data{$this->modelClass}['aadhar_card'];                $data2['User']['voter_id'] = $this->data{$this->modelClass}['voter_id'];                $data2['User']['pen_card'] = @$this->data{$this->modelClass}['pen_card'];                $data2['User']['alternate_mobile'] = $this->data{$this->modelClass}['alternate_mobile'];                $data2['User']['one_way'] = @$this->data{$this->modelClass}['one_way'];                $data2['User']['round_trip'] = @$this->data{$this->modelClass}['round_trip'];                $data2['User']['ownership_type'] = @$this->data{$this->modelClass}['ownership_type'];                $data2['User']['contact_person'] = @$this->data{$this->modelClass}['contact_person'];                $data2['User']['contact_person_mo'] = @$this->data{$this->modelClass}['contact_person_mo'];                $data2['User']['name_as_on_rc'] = @$this->data{$this->modelClass}['name_as_on_rc'];                $data2['User']['license_no'] = @$this->data{$this->modelClass}['dc_number'];                $data2['User']['rto_office'] = @$this->data{$this->modelClass}['dc_issuing_authority'];                $data2['User']['city_id'] = $this->data['Company']['city_id'];                $data2['User']['state_id'] = $this->data['Company']['state_id'];                $data2['User']['id'] = $id;                $data2['User']['verified'] = 2;                $data2['User']['id'] = $id;                //$this->User->id = $id;                if ($this->User->save($data2['User'])) {                    $this->request->data["Company"]['name'] 		  = $this->data{$this->modelClass}['firstname'] . " " . $this->data{$this->modelClass}['lastname'];                    $this->request->data["Company"]['bank'] 		  = $this->data{$this->modelClass}['bank'];                    $this->request->data["Company"]['vrerify_bank']   = $this->data{$this->modelClass}['bank'];                    $this->request->data["Company"]['bank_name']      = $this->data{$this->modelClass}['bank_name'];                    $this->request->data["Company"]['branch_name']    = $this->data{$this->modelClass}['branch_name'];                    $this->request->data["Company"]['ifsc_code']      = $this->data{$this->modelClass}['ifsc_code'];                    $this->request->data["Company"]['branch_address'] = $this->data{$this->modelClass}['branch_address'];                    $this->request->data["Company"]['ac_holder_name'] = $this->data{$this->modelClass}['ac_holder_name'];                    $this->Company->id = $data['User']['company_id'];                    $this->Company->save($this->data["Company"]);                    $this->loadModel("OperationArea");                    $checkOperationArea = $this->OperationArea->find('list', array('conditions' => array('OperationArea.user_id' => $id))); // to get list for dropdowns                    if (empty($checkOperationArea)) {                        $this->loadModel("OperationArea");                        $this->OperationArea->create();                        if (isset($this->data['OperationArea']["id"]) && !empty($this->data['OperationArea']["id"])) {                            $OperationArea["OperationArea"]['id'] = $this->data['OperationArea']["id"];                        }                        $OperationArea["OperationArea"]['user_id'] = $id;                        $OperationArea["OperationArea"]["zone_ids"] = $this->data['OperationArea']['zones'];                        $OperationArea["OperationArea"]["city_ids"] = $this->data['OperationArea']['city_ids'];                        $this->OperationArea->saveAll($OperationArea);                    } else {                        if (isset($this->data['OperationArea']["zones"]) && !empty($this->data['OperationArea']["zones"])) {                            $this->OperationArea->updateAll(array('OperationArea.zone_ids' => "'" . $this->data['OperationArea']['zones'] . "'"), array('OperationArea.user_id' => $id));                        }                        if (isset($this->data['OperationArea']["city_ids"]) && !empty($this->data['OperationArea']["city_ids"])) {                            $this->OperationArea->updateAll(array('OperationArea.city_ids' => "'" . $this->data['OperationArea']['city_ids'] . "'"), array('OperationArea.user_id' => $id));                        }                    }                    $this->show_to_all($id);                    // updating driver logs 					                    $description = "Driver Updated";                    $user_name = $this->Auth->user('firstname') . " " . $this->Auth->user('lastname');                    $all_data = $this->request->data;                    if ($this->Auth->user('user_role_id') == 1) {                        $user_type = 0;                    } else {                        $user_type = 1;                    }                    $this->insert_driver_log($id, $description, 1, $user_type, $this->Auth->user('id'), $user_name, $all_data);                    $this->loadModel('UserDocument');                    if (isset($this->data['Usermgmt']['image'][0]['name']) && !empty($this->data['Usermgmt']['image'][0]['name'])) {                        $getOldimageData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $id, "UserDocument.type" => 8)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $id, "UserDocument.type" => 8));                        $value = $this->data["Usermgmt"]['image'];                        foreach ($value as $value) {                            //	pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'userimag' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'userimag' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $id;                                $UserDocument["UserDocument"]["type"] = 8;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldimageData)) {                            foreach ($getOldimageData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    //	pr( $this->data["Usermgmt"]['license_proof_img']); exit;                    if (isset($this->data['Usermgmt']['license_proof_img'][0]['name']) && !empty($this->data['Usermgmt']['license_proof_img'][0]['name'])) {                        $getOldlicenseData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $id, "UserDocument.type" => 1)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $id, "UserDocument.type" => 1));                        $value = $this->data["Usermgmt"]['license_proof_img'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'lpi' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'lpi' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $id;                                $UserDocument["UserDocument"]["type"] = 1;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldlicenseData)) {                            foreach ($getOldlicenseData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    if (isset($this->data['Usermgmt']['pancard_img'][0]['name']) && !empty($this->data['Usermgmt']['pancard_img'][0]['name'])) {                        $getOldPancardData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $id, "UserDocument.type" => 7)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $id, "UserDocument.type" => 7));                        $value = $this->data["Usermgmt"]['pancard_img'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'pi' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'pi' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $id;                                $UserDocument["UserDocument"]["type"] = 7;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldPancardData)) {                            foreach ($getOldPancardData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    if (isset($this->data['Usermgmt']['aadhar_proof_img'][0]['name']) && !empty($this->data['Usermgmt']['aadhar_proof_img'][0]['name'])) {                        $getOldAadharData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $id, "UserDocument.type" => 2)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $id, "UserDocument.type" => 2));                        $value = $this->data["Usermgmt"]['aadhar_proof_img'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'api' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'api' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $id;                                $UserDocument["UserDocument"]["type"] = 2;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldAadharData)) {                            foreach ($getOldAadharData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    if (isset($this->data['Usermgmt']['check_copy'][0]['name']) && !empty($this->data['Usermgmt']['check_copy'][0]['name'])) {                        $this->loadModel("UserDocument");                        $getOldCheckCopyData = $this->UserDocument->find("all", array('conditions' => array('UserDocument.user_id' => $id, "UserDocument.type" => 9)));                        $this->UserDocument->deleteAll(array("UserDocument.user_id" => $id, "UserDocument.type" => 9));                        $value = $this->data["Usermgmt"]['check_copy'];                        foreach ($value as $value) {                            //pr($value); exit;                            $i = 1;                            $this->UserDocument->create();                            if (!empty($value["tmp_name"])) {                                $filename = time() . $i . 'cc' . str_replace(" ", "_", $value['name']);                                $filename = time() . $i . 'cc' . str_replace("/", "_", $filename);                                move_uploaded_file($value['tmp_name'], USERDOCS . $filename);                                $UserDocument["UserDocument"]["document_image"] = $filename;                                $UserDocument["UserDocument"]["user_id"] = $id;                                $UserDocument["UserDocument"]["type"] = 9;                                $UserDocument["UserDocument"]["created"] = date("Y-m-d h:i:s");                                $this->UserDocument->saveAll($UserDocument);                            }                            $i++;                        }                        if (!empty($getOldCheckCopyData)) {                            foreach ($getOldCheckCopyData as $DeleteData) {                                @unlink(USERDOCS . $DeleteData["UserDocument"]['document_image']);                            }                        }                    }                    $text_action = "updated";                    $json_data = json_encode($this->request->data);                    $this->global_logs("users", $id, 1, $text_action, $json_data);                    $this->Session->setFlash(__('Driver has been updated'), 'success');                    $this->redirect(array('action' => 'driver_list'));                }            }        } else {            $data['Usermgmt']['firstname']		 			= @$data['User']['firstname'];            $data['Usermgmt']['lastname'] 					= @$data['User']['lastname'];            $data['Usermgmt']['mobile'] 					= @$data['User']['mobile'];            $data['Usermgmt']['dob'] 						= @$data['User']['dob'] ? date("d-m-Y", strtotime(@$data['User']['dob'])) : "";            $data['Usermgmt']['address'] 					= @$data['User']['address'];            $data['Usermgmt']['residence_address'] 			= @$data['User']['residence_address'];            $data['Usermgmt']['dc_number']					= @$data['User']['license_no'];            $data['Usermgmt']['dc_issuing_authority'] 		= @$data['User']['rto_office'];            $data['Usermgmt']['dc_issue_date'] 				= @$data['User']['license_from'] ? date("d-m-Y", strtotime($data['User']['license_from'])) : "";            $data['Usermgmt']['dc_expiry_date'] 			= @$data['User']['license_to'] ? date("d-m-Y", strtotime($data['User']['license_to'])) : "";            $data['Usermgmt']['aadhar_card'] 				= @$data['User']['aadhar_no'];            $data['Usermgmt']['pen_card'] 					= @$data['User']['pen_card'];            $data['Usermgmt']['alternate_mobile'] 			= @$data['User']['alternate_mobile'];            $data['Usermgmt']['one_way'] 					= @$data['User']['one_way'];            $data['Usermgmt']['round_trip']					= @$data['User']['round_trip'];            $data['Usermgmt']['referred_id']				= @$data['User']['referred_id'];            $data['Usermgmt']['city_id'] 					= @$data['User']['city_id'];            $data['Usermgmt']['state_id']				    = @$data['User']['state_id'];            $data['Usermgmt']['ownership_type'] = @$data['User']['ownership_type'];            $data['Usermgmt']['contact_person'] = @$data['User']['contact_person'];            $data['Usermgmt']['contact_person_mo'] = @$data['User']['contact_person_mo'];            $data['Usermgmt']['name_as_on_rc'] = @$data['User']['name_as_on_rc'];            $data['Usermgmt']['bank'] = @$company["Company"]['bank'];            $data['Usermgmt']['vrerify_bank'] = @$company["Company"]['bank'];            $data['Usermgmt']['bank_name'] = @$company["Company"]['bank_name'];            $data['Usermgmt']['branch_name'] = @$company["Company"]['branch_name'];            $data['Usermgmt']['ifsc_code'] = @$company["Company"]['ifsc_code'];            $data['Usermgmt']['branch_address'] = @$company["Company"]['branch_address'];            $data['Usermgmt']['ac_holder_name'] = @$company["Company"]['ac_holder_name'];            $this->data = $data;        }        				        $this->loadModel('Country');        $country = $this->Country->find('list', array('order' => 'created desc'));       /*  $this->loadModel("UserState");        $state = $this->UserState->find("list", array("fields" => array("state_id", "state_name")));		        $this->loadModel("UserCity");		        $city = $this->UserCity->find("list", array("fields" => array("city_id", "city_name"))); */				$this->loadModel("State");        $state = $this->State->find("list", array('conditions' => array('State.status' => 'A'),"fields" => array("State.id", "State.name"), 'order' => array('State.name' => 'Asc')));				$this->loadModel("City");		         $city = $this->City->find("list", array('conditions' => array('City.status' => 'A'),"fields" => array("City.id", "City.name"), 'order' => array('City.name' => 'Asc')));		        $this->set('country', $country);        $this->set('state', $state);        $this->set('city', $city);		        $this->loadModel("City");        $city_list = $this->City->find("list", array('conditions' => array('City.status' => 'A'), 'order' => array('City.name' => 'Asc')));        $this->set("city_list", $city_list);	        $this->loadModel("Zone");        $zone_list = $this->Zone->find("list", array(            'conditions' => array(                "Zone.status" => 1,                "Zone.zone_type" => 1        )));        $this->set("zones", $zone_list);        $this->set("result", $data);        $this->set('title_for_layout', 'Edit Driver');    }    function get_cities() {        $this->loadModel("SuperDestinationCity");        if ($this->request->is('Ajax')) {            $this->loadModel("City");            $city_id = !empty($this->data['city_id']) ? $this->data['city_id'] : 0;            $return_string = '';            $destination_list = $this->City->find("all", array('fields' => array(                    'City.id', 'City.name'                ), 'conditions' => array('City.status' => 'A')));            $return_string .= '<script>$(document).ready(function () {                $(".chosen-select").chosen().change(function (e, params) {                    var values = $(".chosen-select").chosen().val();						$(".cities").val(values);                    });            });</script>';            $return_string .= '<label class="control-label">Cities  <span class="symbol required"></span></label>';            if (!empty($destination_list)) {                $return_string .= '<select data-placeholder="Choose a City " id="to_city_id" name="data[OperationArea][city_ids]" class = "form-control validate[required] chosen-select" multiple="multiple" "required">';                $return_string .= '<option value=""></option>';                foreach ($destination_list as $val) {                    $return_string .= '<option value="' . $val['City']['id'] . '">' . $val['City']['name'] . '</option>';                    //$return_string .= '<input type="checkbox" name="cities[]" id="city_id_' . $val['SuperDestination']['id'] . '" value = "' . $val['SuperDestination']['id'] . '" class="validate[required]"/> ' . $val['SuperDestination']['name'] . '  ';                }                $return_string .= '</select>';            }            $return_string .= '<span id="to_city_id-error" class="help-block"></span>';            echo $return_string;            exit;        }    }    function get_zones() {        $this->loadModel("SuperDestinationCity");        if ($this->request->is('Ajax')) {            $this->loadModel("Zone");            $city_id = !empty($this->data['city_id']) ? $this->data['city_id'] : 0;            $return_string = '';            $destination_list = $this->Zone->find("all", array('fields' => array(                    'Zone.id', 'Zone.name'                ), 'conditions' => array('Zone.status' => 1)));            $return_string .= '<script>$(document).ready(function () {                $(".chosen-select-zone").chosen().change(function (e, params) {                    var values = $(".chosen-select-zone").chosen().val();						$(".zones").val(values);                    });            });</script>';            $return_string .= '<label class="control-label">Zone <span class="symbol required"></span></label>';            if (!empty($destination_list)) {                $return_string .= '<select data-placeholder="Choose a Zone" id="to_city_id" name="data[OperationArea][city_ids]" class = "form-control validate[required] chosen-select-zone" multiple="multiple" "required">';                $return_string .= '<option value=""></option>';                foreach ($destination_list as $val) {                    $return_string .= '<option value="' . $val['Zone']['id'] . '">' . $val['Zone']['name'] . '</option>';                    //$return_string .= '<input type="checkbox" name="cities[]" id="city_id_' . $val['SuperDestination']['id'] . '" value = "' . $val['SuperDestination']['id'] . '" class="validate[required]"/> ' . $val['SuperDestination']['name'] . '  ';                }                $return_string .= '</select>';            }            $return_string .= '<span id="to_city_id-error" class="help-block"></span>';            echo $return_string;            exit;        }    }    function get_user_deflat_cities() {        $this->loadModel("SuperDestinationCity");        if ($this->request->is('Ajax')) {            $this->loadModel("City");            $city_id = !empty($this->data['city_id']) ? $this->data['city_id'] : 0;            $return_string = '';            $destination_list = $this->City->find("all", array('fields' => array(                    'City.id', 'City.name'                ), 'conditions' => array('City.status' => 'A')));            $return_string .= '<script>$(document).ready(function () {                $(".chosen-select").chosen().change(function (e, params) {                    var values = $(".chosen-select").chosen().val();						$(".cities").val(values);                    });            });</script>';            $return_string .= '<label class="control-label">Cities ajax <span class="symbol required"></span></label>';            if (!empty($destination_list)) {                $return_string .= '<select data-placeholder="Choose a City ajax" id="to_city_id" name="data[OperationArea][city_ids]" class = "form-control validate[required] chosen-select" multiple="multiple">';                $return_string .= '<option value=""></option>';                foreach ($destination_list as $val) {                    $return_string .= '<option value="' . $val['City']['id'] . '">' . $val['City']['name'] . '</option>';                    //$return_string .= '<input type="checkbox" name="cities[]" id="city_id_' . $val['SuperDestination']['id'] . '" value = "' . $val['SuperDestination']['id'] . '" class="validate[required]"/> ' . $val['SuperDestination']['name'] . '  ';                }                $return_string .= '</select>';            }            $return_string .= '<span id="to_city_id-error" class="help-block"></span>';            echo $return_string;            exit;        }    }    public function send_message_to_driver_dco() {        Configure::write('debug', 2);        $conditions = array();        array_push($conditions, array('Usermgmt.user_role_id' => 4, 'Usermgmt.driver_type' => 1, 'Usermgmt.status' => 1));        $driverList = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array('Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.mobile', 'Usermgmt.created', 'Usermgmt.id',),            'recursive' => -1,            'order' => array($this->modelClass . '.created' => 'desc')        ));        pr($driverList);        exit;        $i = 0;        foreach ($driverList as $dirverData) {            //pr($dirverData); exit;	            if ($dirverData['Usermgmt']['mobile']) {                $phone_no = $dirverData['Usermgmt']['mobile'];                $phone_no = '+91' . $phone_no;                $msg = 'Dear Partner,';                $msg .= "\n";                $msg .='SuperCabz ke sath judne ke liye dhanyavad. Aapka panel active ho chukka hai. Kripiya niche diye gaye link se APP download kare aur  jyada se jyada booking kare aur incentive paye. Adhik Jankari ke liye  9773989023 par call kare.';                $msg .= "\n";                $msg .= 'https://play.google.com/store/apps/details?id=com.superCabz.driver&hl=en';                $msg .= "\n";                $msg .= 'Dhnayavad, Aapka Sathi';                $msg .= "\n";                $msg .= 'SuperCabz';                $res = $this->send_message($phone_no, $msg, 1);            }            $i++;        }        pr($res);        echo $i;        echo $msg;        exit;    }    public function send_message_to_driver() {        Configure::write('debug', 2);        $conditions = array();        array_push($conditions, array('Usermgmt.user_role_id' => 4, 'Usermgmt.driver_type' => 0, 'Usermgmt.status' => 1));        $driverList = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array('Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.mobile', 'Usermgmt.created', 'Usermgmt.id',),            'recursive' => -1,            'order' => array($this->modelClass . '.created' => 'desc')        ));        //pr($driverList);        // exit;        $i = 0;        foreach ($driverList as $dirverData) {            //pr($dirverData); exit;	            if ($dirverData['Usermgmt']['mobile']) {                $phone_no = $dirverData['Usermgmt']['mobile'];                $phone_no = '+91' . $phone_no;                $msg = 'Dear Partner,';                $msg .= "\n";                $msg .='Agar aapki Customer Rating 4 ya 4 se jyada ayegi to SuperCabz aapko us trip kay liye Rs 100/- Incentive dega, wo bhi seedha aapke account mein. Adhik Jankari ke liye 9773989023 par call kare or niche diye gaye link se APP download kare.';                $msg .= "\n";                $msg .= 'https://play.google.com/store/apps/details?id=com.superCabz.driver&hl=en';                $msg .= "\n";                $msg .= 'Dhnayavad, Aapka Sathi';                $msg .= "\n";                $msg .= 'SuperCabz';                $res = $this->send_message($phone_no, $msg, 1);            }            $i++;        }        pr($res);        echo $i;        echo $msg;        exit;    }    public function send_message_to_vendor() {        Configure::write('debug', 2);        $conditions = array();        /* $phone_no = 9001209889;          $phone_no = '+91' . $phone_no;          $msg = 'Dear Partner,';          $msg .= "\n";          $msg .='SuperCabz kay sath jude rahne ke liye dhanyavad. Apse anurodh hai ki har booking kay liye aap apne driver bhaiyo ko customer ko achi service dene kay liye kahe aur customer se acha feedback dene kay liye request kare. Jin vendors kay driver ki rating achi hogi unhe jyada se jyada kaam milega. Adhik Jankari ke liye 7428456789 par call kare.';          $msg .= "\n";          //$msg .= 'https://play.google.com/store/apps/details?id=com.superCabz.driver&hl=en';          /// $msg .= "\n";          $msg .= 'Dhnayavad, Aapka Sathi';          $msg .= "\n";          $msg .= 'SuperCabz';          $res = $this->send_message($phone_no, $msg, 1);          exit; */        array_push($conditions, array('Usermgmt.user_role_id' => 2, 'Usermgmt.status' => 1));        $driverList = $this->Usermgmt->find('all', array(            'conditions' => array($conditions),            'fields' => array('Usermgmt.firstname', 'Usermgmt.lastname', 'Usermgmt.mobile', 'Usermgmt.created', 'Usermgmt.id', 'Usermgmt.state_id',),            'recursive' => -1,            'order' => array($this->modelClass . '.created' => 'desc')        ));        // pr($driverList);        //  exit;        $i = 0;        foreach ($driverList as $dirverData) {            //pr($dirverData); exit;	            if ($dirverData['Usermgmt']['mobile']) {                $phone_no = $dirverData['Usermgmt']['mobile'];                $phone_no = '+91' . $phone_no;                $msg = 'Dear Partner,';                $msg .= "\n";                if (in_array($dirverData['Usermgmt']['state_id'], array("20", "24", "25"))) {                    $msg .='Thanks a lot for signing up with SuperCabz! We request you to inform your driver about On-time pickup, Clean cab from both inside & outside and delivering overall wonderful experience to the customer. Also ask the drivers to request customers to rate them on Make My Trip app. Those vendors whose drivers are rated higher would get more business from now on. Call 7428456789 for any queries that you may have.';                    $msg .= "\n";                    $msg .= 'Regards';                    $msg .= "\n";                    $msg .= 'SuperCabz';                    $msg .= "\n";                } else {                    $msg .='SuperCabz kay sath jude rahne ke liye dhanyavad. Apse anurodh hai ki har booking kay liye aap apne driver bhaiyo ko customer ko achi service dene kay liye kahe aur customer se acha feedback dene kay liye request kare. Jin vendors kay driver ki rating achi hogi unhe jyada se jyada kaam milega. Adhik Jankari ke liye 7428456789 par call kare.';                    $msg .= "\n";                    $msg .= 'Dhnayavad, Aapka Sathi';                    $msg .= "\n";                    $msg .= 'SuperCabz';                    $msg .= "\n";                }                $res = $this->send_message($phone_no, $msg, 1);            }            $i++;        }        pr($res);        echo $i;        echo $msg;        exit;    }    function view_logs($driver_id, $unique_no = '') {        $this->loadModel("DriverLog");        $get_list = $this->DriverLog->find('all', array(            'conditions' => array(                'DriverLog.driver_id' => $driver_id,            ),            'order' => array("DriverLog.id" => "DESC")        ));        $this->set("get_list", $get_list);        $this->set("plate_no", $unique_no);    }}